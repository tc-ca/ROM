var globalFormContext;

const FIELD_PRIME_CLASS = "ovs_primeclass";
const FIELD_ERAP_CATEGORY = "ovs_erapcategory";

function OnLoad(executionContext) {
    //get context
    globalContext = glHelper.getGlobalContext();
    var formContext = executionContext.getFormContext();
    globalFormContext = formContext;

    // 0 = Undefined, 1 = Create, 2 = Update, 3 = Read Only, 4 = Disabled, 6 = Bulk Edit
    let formType = glHelper.GetFormType(formContext);

    var primaryClassCode = formContext.getAttribute(FIELD_PRIME_CLASS);
    primaryClassCode.removeOnChange(primaryClassCode_OnChange); // avoid binding multiple event handlers
    primaryClassCode.addOnChange(primaryClassCode_OnChange);
}

function primaryClassCode_OnChange(executionContext) {

    var formContext = executionContext.getFormContext();

    var pcType = glHelper.GetOptionsetValue(formContext, FIELD_PRIME_CLASS);
    getEnvironmentVariableInternal(formContext, "tdg_Env_Variables", pcType);
}

top.environmentVariables = [];

function getEnvironmentVariableInternal(formContext, varName, pcType) {
    "use strict";
    var json = null;
    Xrm.WebApi.retrieveMultipleRecords("environmentvariabledefinition", "?$select=defaultvalue,displayname&$expand=environmentvariabledefinition_environmentvariablevalue($select=value)&$filter=schemaname eq '" + varName + "'").then(
        function success(result) {
            for (var i = 0; i < result.entities.length; i++) {
                if (typeof (result.entities[i]["environmentvariabledefinition_environmentvariablevalue"]) != "undefined"
                    && result.entities[i]["environmentvariabledefinition_environmentvariablevalue"].length > 0) {
                    json = result.entities[i]["environmentvariabledefinition_environmentvariablevalue"][0].value;
                }
                else if (typeof (result.entities[i].defaultvalue) != "undefined") {
                    json = result.entities[i].defaultvalue;
                }
                else {
                    json = null;
                }
            }

            var data = JSON.parse(json);
            if (data != null || typeof data !== 'undefined') {

                var ec = data.filter(function (o) { return o.Primary_Classes == pcType; });
                if (ec.length > 0 && ec[0].ERAP_CATEGORY !== "") glHelper.SetOptionsetByValue(formContext, FIELD_ERAP_CATEGORY, ec[0].ERAP_CATEGORY);
                else glHelper.SetValue(formContext, FIELD_ERAP_CATEGORY, null);
            }
        },
        function (error) {
            console.log(error.message);
        }
    );
}
