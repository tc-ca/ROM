<html>
<head>
    <meta charset="utf-8" />
    <title></title>

    <link href="../qm_/Bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css" />


    <script src="../ClientGlobalContext.js.aspx"></script>
    <script src="../qm_/Scripts/jquery_3.1.1.min.js"></script>
    <script src="../qm_/Bootstrap/js/bootstrap.min.js"></script>

    <style>

        .top-mini-buffer {
            margin-top: 5px;
        }

        .top-buffer {
            margin-top: 10px;
        }

        .top-double-buffer {
            margin-top: 20px;
        }

        .top-grand-buffer {
            margin-top: 50px;
        }

        .bottom-buffer {
            margin-bottom: 20px;
        }

        @-moz-document url-prefix() {
            fieldset {
                display: table-cell;
            }
        }

        .msg {
            font-style: italic;
            font-size: 12px;
            margin: 0;
        }

        .form-group.required .control-label:after {
            content: "*";
            color: red;
        }
    </style>

</head>

<body>
    <div class="container-fluid">
        <div class="row top-buffer">
            <label id="lblTitle">
                <span>You can replace the HQ approved candidate with local candidate.</span>
                <span> We recommend utilize 'Candidates Replacement and Justification' view for selection. Please select HQ approved camdidate for replacement.</span>
                <span> Press 'HQ Approved' button on top of grid to add it to panel. Then select Regional candidate to substitute and press 'Substitute' button.</span>
            </label>
        </div>

        <div class="row top-buffer">
            <div class="col-xs-12">
                <label for="txtHqApproved" id="lblHqApproved">HQ Approved Candidate</label>
                <textarea class="form-control" id="txtHqApproved" rows="3" readonly></textarea>
            </div>
        </div>

        <div class="row top-buffer">
            <div class="col-xs-12">
                <label for="txtLocalCandidate" id="lblLocalCandidate">Local Candidate to replace</label>
                <textarea class="form-control" id="txtLocalCandidate" rows="3" readonly></textarea>
            </div>
        </div>

        <div class="row top-buffer">
            <div class="form-group required">
                <div class="col-xs-12">
                    <label class="control-label" for="txtJustify" id="lblJustify">Please, justify the replacement: </label>
                    <textarea class="form-control required" id="txtJustify" rows="5"></textarea>
                </div>
            </div>
        </div>

        <div class="row top-buffer">
            <div class="col-xs-2 col-xs-offset-8">
                <button type="submit" id="submitReplacement" class="btn btn-primary">Replace?</button>
            </div>
        </div>



    </div>

    <script>

        var globalContext = Xrm.Utility.getGlobalContext();
        var formContext;
        var gridControl;
        var LCID = 1033;

        var HQ_Candidate = null;
        var LocalCandidate = null;

        function cleanAll() {

            HQ_Candidate = null;
            LocalCandidate = null;
            $('#txtHqApproved').text('');
            $('#txtLocalCandidate').text('');
            $("#txtJustify").val('');
        }

        function updateCandidates(hq_candidate_id, local_candidate_id, justification, gridControl) {


            Xrm.Utility.showProgressIndicator("Working ...");
            var parameters = {};
            parameters.justification = justification;
            parameters.hq_candidate_id = { guid: hq_candidate_id };
            parameters.local_candidate_id = { guid: local_candidate_id };

            var ovs_ReplaceCandidatePostRequest = {
                justification: parameters.justification,
                hq_candidate_id: parameters.hq_candidate_id,
                local_candidate_id: parameters.local_candidate_id,

                getMetadata: function () {
                    return {
                        boundParameter: null,
                        parameterTypes: {
                            "justification": {
                                "typeName": "Edm.String",
                                "structuralProperty": 1
                            },
                            "hq_candidate_id": {
                                "typeName": "Edm.Guid",
                                "structuralProperty": 1
                            },
                            "local_candidate_id": {
                                "typeName": "Edm.Guid",
                                "structuralProperty": 1
                            }
                        },
                        operationType: 0,
                        operationName: "ovs_ReplaceCandidatePost"
                    };
                }
            };

            Xrm.WebApi.online.execute(ovs_ReplaceCandidatePostRequest).then(
                function success(result) {

                    Xrm.Utility.closeProgressIndicator();

                    if (result.ok) {
                        result.text().then(function (i) {
                            var data = JSON.parse(i);
                            if (data != null || typeof data !== 'undefined') {

                                if ((data.isOk != null)
                                    && typeof data.isOk !== 'undefined')
                                    if (data.isOk) {

                                        //success message, refresh grid
                                        var alertStrings = { confirmButtonLabel: "Yes", text: "Successefuly replaced candidates" };

                                        Xrm.Navigation.openAlertDialog(alertStrings).then(
                                            function (success) {
                                                gridControl.refresh();
                                                cleanAll();
                                            },
                                            function (error) {
                                                console.log("alert dialog error: " + error.message);
                                            }
                                        );
                                    } else {
                                        //error message, refresh grid
                                        var alertStrings = { confirmButtonLabel: "Yes", text: "Error replacing candidates: " + data.errormessage };

                                        Xrm.Navigation.openAlertDialog(alertStrings).then(
                                            function (success) {
                                                gridControl.refresh();
                                            },
                                            function (error) {
                                                console.log("alert dialog error: " + error.message);
                                            }
                                        );

                                    }
                            }
                        }, function (error) {

                            console.log("ovs_ReplaceCandidatePost error: " + error.message);
                            Xrm.Navigation.openErrorDialog({ message: "Something went wrong. Error: " + error.message });
                        });

                    }
                },
                function (error) {
                    Xrm.Utility.closeProgressIndicator();
                    console.log("ReplaceCandidatePost error: " + error.message);
                    Xrm.Navigation.openErrorDialog({ message: "Something went wrong. Error: " + error.message });
                }
            );
        }

        function setHQ_Candidate(formContextRef, gridControlRef, rowObj) {

            formContext = formContextRef;
            gridControl = gridControlRef;
            HQ_Candidate = rowObj;
            $('#txtHqApproved').text(rowObj.Name + "\r Regional Candidate with priority score of " + (rowObj.priorityscore == null ? " N/A " : rowObj.priorityscore));
        }

        function setLocalCandidate(formContextRef, gridControlRef, rowObj) {

            formContext = formContextRef;
            gridControl = gridControlRef;
            LocalCandidate = rowObj;
            $('#txtLocalCandidate').text(rowObj.Name + "\r HQ Candidate with priority score of " + (rowObj.priorityscore == null ? " N/A " : rowObj.priorityscore));
        }

        $(document).ready(function () {

            var userSettings = globalContext.userSettings;
            LCID = userSettings.languageId;

            //if (LCID == 1033)
            //    resexResourceName = "?.1033.resx";
            //else if (LCID == 1036)
            //    resexResourceName = "?.1036.resx";

            //$('#lblTitle').text(Xrm.Utility.getResourceString(resexResourceName, ""));


            $('#submitReplacement').on('click', function () {

                var justification = $("#txtJustify").val();
                //validate Justification
                if (justification.trim() == "") {

                    Xrm.Navigation.openErrorDialog({ message: "Justification field cannot be empty!" });
                    return;
                }
                //yes => call Custom Api
                if (justification.trim() != "" && HQ_Candidate && LocalCandidate)
                    updateCandidates(HQ_Candidate.Id, LocalCandidate.Id, justification, gridControl);
                else
                    Xrm.Navigation.openErrorDialog({ message: "Something went wrong" });
            });
        });

    </script>
</body>
</html>