{
  "properties": {
    "connectionReferences": {
      "shared_commondataserviceforapps_1": {
        "runtimeSource": "embedded",
        "connection": {
          "connectionReferenceLogicalName": "tdg_ConnectionReferenceDataverseServicePrinciple"
        },
        "api": {
          "name": "shared_commondataserviceforapps"
        }
      },
      "shared_commondataserviceforapps": {
        "runtimeSource": "embedded",
        "connection": {
          "connectionReferenceLogicalName": "tdg_ConnectionReferenceDataverseServicePrinciple"
        },
        "api": {
          "name": "shared_commondataserviceforapps"
        }
      },
      "shared_azureblob_1": {
        "runtimeSource": "embedded",
        "connection": {
          "connectionReferenceLogicalName": "cid_sharedazureblob_395e7"
        },
        "api": {
          "name": "shared_azureblob"
        }
      },
      "shared_sharepointonline": {
        "runtimeSource": "embedded",
        "connection": {
          "connectionReferenceLogicalName": "tdg_ConnectionReferenceSharepointTDGCoreUser"
        },
        "api": {
          "name": "shared_sharepointonline"
        }
      },
      "shared_excelonlinebusiness_1": {
        "runtimeSource": "embedded",
        "connection": {
          "connectionReferenceLogicalName": "tdg_ConnectionReferenceExcelTDGCoreUser"
        },
        "api": {
          "name": "shared_excelonlinebusiness"
        }
      },
      "shared_webcontents": {
        "runtimeSource": "embedded",
        "connection": {
          "connectionReferenceLogicalName": "cid_sharedwebcontents_efbe7"
        },
        "api": {
          "name": "shared_webcontents"
        }
      }
    },
    "definition": {
      "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
      "contentVersion": "1.0.0.0",
      "parameters": {
        "$connections": {
          "defaultValue": {},
          "type": "Object"
        },
        "$authentication": {
          "defaultValue": {},
          "type": "SecureObject"
        }
      },
      "triggers": {
        "manual": {
          "metadata": {
            "operationMetadataId": "4ddcee8d-9d8e-4291-9b73-9eca2b07bbc7"
          },
          "type": "Request",
          "kind": "Http",
          "inputs": {
            "schema": {
              "type": "object",
              "properties": {
                "activityid": {
                  "type": "string"
                },
                "name": {
                  "type": "string"
                },
                "accountid": {
                  "type": "string"
                },
                "Lang": {
                  "type": "string"
                },
                "ActivityType": {
                  "type": "string"
                }
              }
            }
          }
        }
      },
      "actions": {
        "List_Environment_setting": {
          "runAfter": {
            "check_Language": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "55ddbf3f-4c68-4cff-aca0-eb4c71e2a24f"
          },
          "type": "OpenApiConnection",
          "inputs": {
            "host": {
              "connectionName": "shared_commondataserviceforapps_1",
              "operationId": "ListRecords",
              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
            },
            "parameters": {
              "entityName": "qm_environmentsettingses",
              "fetchXml": "<fetch version=\"1.0\" output-format=\"xml-platform\" mapping=\"logical\" distinct=\"false\">\n  <entity name=\"qm_environmentsettings\">\n    <attribute name=\"qm_environmentsettingsid\" />\n    <attribute name=\"qm_name\" />\n    <attribute name=\"qm_value\" />\n    <order attribute=\"qm_name\" descending=\"false\" />\n    <filter type=\"and\">\n      <condition attribute=\"qm_name\" operator=\"like\" value=\"%CID[_]%\" />\n    </filter>\n  </entity>\n</fetch>"
            },
            "authentication": "@parameters('$authentication')"
          }
        },
        "company-name": {
          "runAfter": {
            "Get_Company": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "88147cd0-932d-4339-848a-55ffc9249b92"
          },
          "type": "Compose",
          "inputs": "@outputs('Get_Company')?['body/ovs_legalname']"
        },
        "CompanyId": {
          "runAfter": {
            "company-name": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "99d62caf-1929-4115-8b90-eef816655c13"
          },
          "type": "Compose",
          "inputs": "@outputs('Get_Company')?['body/cid_companyid']"
        },
        "Get_Company": {
          "runAfter": {
            "check_Language": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "15a64acd-8d3c-4a8a-b17b-eaeb5a6d416d"
          },
          "type": "OpenApiConnection",
          "inputs": {
            "host": {
              "connectionName": "shared_commondataserviceforapps",
              "operationId": "GetItem",
              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
            },
            "parameters": {
              "entityName": "accounts",
              "recordId": "@triggerBody()?['accountid']"
            },
            "authentication": "@parameters('$authentication')"
          }
        },
        "Get_Bulk_Activity_log_Summaries": {
          "runAfter": {
            "check_Language": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "0abf4f66-6dea-4942-a637-83047b3c2026"
          },
          "type": "OpenApiConnection",
          "inputs": {
            "host": {
              "connectionName": "shared_commondataserviceforapps_1",
              "operationId": "GetItem",
              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
            },
            "parameters": {
              "entityName": "cid_bulkactivitylogsummaries",
              "recordId": "@triggerBody()?['activityid']"
            },
            "authentication": "@parameters('$authentication')"
          }
        },
        "get_Attachment_conetent": {
          "actions": {
            "Get_Note": {
              "runAfter": {},
              "metadata": {
                "operationMetadataId": "7793f97f-eebe-40e1-866e-eaaebd7ee54b"
              },
              "type": "OpenApiConnection",
              "inputs": {
                "host": {
                  "connectionName": "shared_commondataserviceforapps_1",
                  "operationId": "ListRecords",
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                },
                "parameters": {
                  "entityName": "annotations",
                  "$filter": "_objectid_value eq @{triggerBody()?['activityid']}"
                },
                "authentication": "@parameters('$authentication')"
              }
            },
            "attachement": {
              "runAfter": {
                "OrigionalFileName": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "26d6e4c7-9c5e-48b5-8a86-4e89ac3c5461"
              },
              "type": "Compose",
              "inputs": "@body('Get_blob_content_(V2)')"
            },
            "Get-Txt-file-from-attachement": {
              "runAfter": {
                "Get_Note": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "62e124c4-2e49-4fc2-ae92-69bcb44fc3ec"
              },
              "type": "Compose",
              "inputs": "@json(base64ToString(outputs('Get_Note')?['body/value'][0].documentbody))"
            },
            "file-URL-in-Blob": {
              "runAfter": {
                "Get-Txt-file-from-attachement": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "9c7f4bb9-be7d-46bd-905b-f53f3f8e4078"
              },
              "type": "Compose",
              "inputs": "@outputs('Get-Txt-file-from-attachement')['URL']"
            },
            "Get_blob_content_(V2)": {
              "runAfter": {
                "file-URL-in-Blob": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "27463fd4-1ba4-437b-aeab-f3227a9d5e9b"
              },
              "type": "OpenApiConnection",
              "inputs": {
                "host": {
                  "connectionName": "shared_azureblob_1",
                  "operationId": "GetFileContent_V2",
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_azureblob"
                },
                "parameters": {
                  "dataset": "satdgrdnprdcc",
                  "id": "@substring(outputs('file-URL-in-Blob'), indexOf(outputs('file-URL-in-Blob'), '/blobstoragecontainer'))",
                  "inferContentType": true
                },
                "authentication": "@parameters('$authentication')"
              }
            },
            "OrigionalFileName": {
              "runAfter": {
                "Get_blob_content_(V2)": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "1ab9a214-0af2-46cc-bee6-b15edaa4ba49"
              },
              "type": "Compose",
              "inputs": "@replace( substring(outputs('file-URL-in-Blob'), add(lastIndexOf( outputs('file-URL-in-Blob'),'/'),1)),'%20',' ')"
            }
          },
          "runAfter": {
            "ActionBy": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "28bcf457-d482-4c97-8639-e70b9bcd77c1"
          },
          "type": "Scope"
        },
        "Initialize_Environment_folder_variable": {
          "runAfter": {
            "Scope-get-environment-setting": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "fc5c3dd6-8d62-49cb-befd-838a6faaacca"
          },
          "type": "InitializeVariable",
          "inputs": {
            "variables": [
              {
                "name": "Environment_Folder",
                "type": "string",
                "value": "@{body('Filter_array-GetEnvironmentVariable')?[0]['qm_value']}"
              }
            ]
          }
        },
        "Scope-get-environment-setting": {
          "actions": {
            "Filter_environment-setting-get-version#": {
              "runAfter": {
                "Filter_array-GetEnvironmentVariable": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "0e744065-88c2-4338-956b-7400a9256a6e"
              },
              "type": "Query",
              "inputs": {
                "from": "@outputs('List_Environment_setting')?['body/value']",
                "where": "@equals(item()?['qm_name'], 'CID_BulkUpload_VersionNumber')"
              }
            },
            "version-number": {
              "runAfter": {
                "Filter_environment-setting-get-version#": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "41b70b02-c1a1-45c9-8dea-3c396fb42ce3"
              },
              "type": "Compose",
              "inputs": "@body('Filter_environment-setting-get-version#')[0]['qm_value']"
            },
            "Filter_environment-max-workbook-site": {
              "runAfter": {
                "version-number": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "0e744065-88c2-4338-956b-7400a9256a6e"
              },
              "type": "Query",
              "inputs": {
                "from": "@outputs('List_Environment_setting')?['body/value']",
                "where": "@equals(item()?['qm_name'], 'CID_Bukl_Upload_Template_Max_Allowed_Sites_Per_Company')"
              }
            },
            "Filter_environment-max-workbook-UNNumber": {
              "runAfter": {
                "Filter_environment-max-workbook-site": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "0e744065-88c2-4338-956b-7400a9256a6e"
              },
              "type": "Query",
              "inputs": {
                "from": "@outputs('List_Environment_setting')?['body/value']",
                "where": "@equals(item()?['qm_name'], 'CID_Bukl_Upload_Template_Max_Allowed_UNNumbers_Per_Company')"
              }
            },
            "Filter_environment-max-system-sites": {
              "runAfter": {
                "Filter_environment-max-workbook-UNNumber": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "0e744065-88c2-4338-956b-7400a9256a6e"
              },
              "type": "Query",
              "inputs": {
                "from": "@outputs('List_Environment_setting')?['body/value']",
                "where": "@equals(item()?['qm_name'], 'CID_Bukl_System_Max_Sites_Per_Company')"
              }
            },
            "Filter_environment-max-system-UNNumbers": {
              "runAfter": {
                "Filter_environment-max-system-sites": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "0e744065-88c2-4338-956b-7400a9256a6e"
              },
              "type": "Query",
              "inputs": {
                "from": "@outputs('List_Environment_setting')?['body/value']",
                "where": "@equals(item()?['qm_name'], 'CID_Bukl_System_Max_UNumber_Per_Company')"
              }
            },
            "Max-Workbook-sites": {
              "runAfter": {
                "Filter_environment-max-system-UNNumbers": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "41b70b02-c1a1-45c9-8dea-3c396fb42ce3"
              },
              "type": "Compose",
              "inputs": "@int(body('Filter_environment-max-workbook-site')[0]['qm_value'])"
            },
            "Max-Workbook-UNnumbers": {
              "runAfter": {
                "Max-Workbook-sites": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "41b70b02-c1a1-45c9-8dea-3c396fb42ce3"
              },
              "type": "Compose",
              "inputs": "@int(body('Filter_environment-max-workbook-site')[0]['qm_value'])"
            },
            "Max-system-sites": {
              "runAfter": {
                "Max-Workbook-UNnumbers": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "41b70b02-c1a1-45c9-8dea-3c396fb42ce3"
              },
              "type": "Compose",
              "inputs": "@int(body('Filter_environment-max-system-sites')[0]['qm_value'])"
            },
            "Max-System-UNnumbers": {
              "runAfter": {
                "Max-system-sites": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "41b70b02-c1a1-45c9-8dea-3c396fb42ce3"
              },
              "type": "Compose",
              "inputs": "@int(body('Filter_environment-max-system-UNNumbers')[0]['qm_value'])"
            },
            "Filter_array-GetEnvironmentVariable": {
              "runAfter": {},
              "metadata": {
                "operationMetadataId": "41f6f1a2-74a5-40a3-8f7a-1c9d91283a64"
              },
              "type": "Query",
              "inputs": {
                "from": "@outputs('List_Environment_setting')?['body/value']",
                "where": "@equals(item()['qm_name'], 'CID_Flow_Environment_Folder')"
              }
            }
          },
          "runAfter": {
            "List_Environment_setting": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "6f69746b-293b-4aea-84f6-03a279403372"
          },
          "type": "Scope"
        },
        "List_All_Un_numbers": {
          "runAfter": {
            "check_Language": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "0fe38d0c-cec3-4743-98f1-b1032d9035ff"
          },
          "type": "OpenApiConnection",
          "inputs": {
            "host": {
              "connectionName": "shared_commondataserviceforapps",
              "operationId": "ListRecords",
              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
            },
            "parameters": {
              "entityName": "ovs_operationunnumbers",
              "fetchXml": "<fetch version=\"1.0\" output-format=\"xml-platform\" mapping=\"logical\" distinct=\"false\">\n  <entity name=\"ovs_operationunnumber\">\n    <attribute name=\"ovs_name\" />\n    <attribute name=\"createdon\" />\n    <attribute name=\"ovs_operationunnumberid\" />\n    <order attribute=\"ovs_name\" descending=\"false\" />\n    <link-entity name=\"account\" from=\"accountid\" to=\"cid_site\" link-type=\"inner\" alias=\"ac\">\n      <filter type=\"and\">\n        <condition attribute=\"parentaccountid\" operator=\"eq\" value=\"@{triggerBody()?['accountid']}\" />\n      </filter>\n    </link-entity>\n  </entity>\n</fetch>"
            },
            "authentication": "@parameters('$authentication')"
          }
        },
        "List_All_sites": {
          "runAfter": {
            "check_Language": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "3794cc98-ec23-4ed0-98fb-46768f868747"
          },
          "type": "OpenApiConnection",
          "inputs": {
            "host": {
              "connectionName": "shared_commondataserviceforapps",
              "operationId": "ListRecords",
              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
            },
            "parameters": {
              "entityName": "accounts",
              "$filter": "customertypecode eq 948010001 and _parentaccountid_value eq '@{triggerBody()?['accountid']}'"
            },
            "authentication": "@parameters('$authentication')"
          }
        },
        "check_error_flag": {
          "actions": {
            "Update_bulk_Activity_Log_Summary": {
              "runAfter": {},
              "metadata": {
                "operationMetadataId": "16c1b0ac-fdb1-4356-9768-087810cae42f"
              },
              "type": "OpenApiConnection",
              "inputs": {
                "host": {
                  "connectionName": "shared_commondataserviceforapps_1",
                  "operationId": "UpdateRecord",
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                },
                "parameters": {
                  "entityName": "cid_bulkactivitylogsummaries",
                  "recordId": "@triggerBody()?['activityid']",
                  "item/cid_activitystarttime": "@outputs('Bulk_Activity_start_time')",
                  "item/cid_activitytype": 100000001,
                  "item/cid_filename": "@outputs('OrigionalFileName')",
                  "item/cid_language": "@variables('Language_Index')",
                  "item/cid_numberofsites": "@outputs('Number-Of-Sites')",
                  "item/cid_numberofunnumbers": "@outputs('Number-of-UNs')",
                  "item/cid_tempsharepointfilelocation": "@outputs('Create_Temp_file')?['body/Path']",
                  "item/cid_validationcompletedstage": 100000000,
                  "item/cid_version": "@outputs('version-number')"
                },
                "authentication": "@parameters('$authentication')"
              }
            },
            "check_language_for_response": {
              "actions": {
                "Success_Response": {
                  "runAfter": {},
                  "metadata": {
                    "operationMetadataId": "66e8a4fe-bef3-42dc-8d0c-7f1c84210141"
                  },
                  "type": "Response",
                  "kind": "Http",
                  "inputs": {
                    "statusCode": 200,
                    "headers": {
                      "filepath": "@outputs('Create_Temp_file')?['body/Path']",
                      "NumberOfSitesWithRequirementLevel": "@{int(outputs('Number-Of-Sites-With-Reqiurement-Level'))}",
                      "warningMessage": "@{body('Filter_Messages_B1035')[0]['Message']}"
                    },
                    "body": "@Replace(Replace(string(body('Filter_array_B1036')[0]['Message']),'{0}', string(outputs('Number-Of-Sites'))),'{1}' , string(outputs('Number-of-UNs')))"
                  }
                }
              },
              "runAfter": {
                "filter_logged_error_and_Error_Message_2": [
                  "Succeeded"
                ]
              },
              "else": {
                "actions": {
                  "Success_Response_in_French": {
                    "runAfter": {},
                    "metadata": {
                      "operationMetadataId": "29f1233e-d89f-4851-991e-0b1112187e44"
                    },
                    "type": "Response",
                    "kind": "Http",
                    "inputs": {
                      "statusCode": 200,
                      "headers": {
                        "NumberOfSitesWithRequirementLevel": "@{int(outputs('Number-Of-Sites-With-Reqiurement-Level'))}",
                        "filepath": "@outputs('Create_Temp_file')?['body/Path']",
                        "warningMessage": "@{body('Filter_Messages_B1035')[0]['Message']}"
                      },
                      "body": "@Replace(Replace(string(body('Filter_array_B1036')[0]['Message']),'{0}', string(outputs('Number-Of-Sites'))),'{1}' , string(outputs('Number-of-UNs')))"
                    }
                  }
                }
              },
              "expression": {
                "contains": [
                  "@triggerBody()?['Lang']",
                  "en"
                ]
              },
              "metadata": {
                "operationMetadataId": "09fceff5-0d57-4b0b-b974-598451d1b3d4"
              },
              "type": "If"
            },
            "filter_logged_error_and_Error_Message_2": {
              "actions": {
                "Filter_array_B1036": {
                  "runAfter": {},
                  "metadata": {
                    "operationMetadataId": "80b29c84-7347-4907-bf75-cb1f1f4e2161"
                  },
                  "type": "Query",
                  "inputs": {
                    "from": "@variables('Messages_Array')",
                    "where": "@equals(item()['code'], variables('Error_Code'))"
                  }
                },
                "Filter_Messages_B1035": {
                  "runAfter": {
                    "Filter_array_B1036": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "e755b2d8-176c-430f-a770-26ce12d5e32a"
                  },
                  "type": "Query",
                  "inputs": {
                    "from": "@variables('Messages_Array')",
                    "where": "@equals(item()['code'], 'B1035')"
                  }
                },
                "Set_variable_Error-Message_B1036": {
                  "runAfter": {
                    "Filter_Messages_B1035": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "3cc05f8b-d916-4cf3-abb3-63f2cd66891f"
                  },
                  "type": "SetVariable",
                  "inputs": {
                    "name": "Error_Message",
                    "value": "@{body('Filter_array_B1036')[0]['Message']}"
                  }
                }
              },
              "runAfter": {
                "Set_variable-ErrorCode_B1036": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "171aebed-046f-4bae-8c20-ca144c23c28f"
              },
              "type": "Scope"
            },
            "Set_variable-ErrorCode_B1036": {
              "runAfter": {
                "Update_bulk_Activity_Log_Summary": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "d9cc657f-ad59-482e-b6b1-6d31a09ab404"
              },
              "type": "SetVariable",
              "inputs": {
                "name": "Error_Code",
                "value": "B1036"
              }
            }
          },
          "runAfter": {
            "Check_Activity_Type": [
              "Succeeded"
            ]
          },
          "else": {
            "actions": {
              "Add-Bulk-Activity-Logs-Details": {
                "runAfter": {
                  "Update_bulk_Activity_Log_Summary_2": [
                    "Succeeded"
                  ]
                },
                "metadata": {
                  "operationMetadataId": "904e3f3f-2707-413b-9d39-eeca703a31e9"
                },
                "type": "OpenApiConnection",
                "inputs": {
                  "host": {
                    "connectionName": "shared_commondataserviceforapps_1",
                    "operationId": "CreateRecord",
                    "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                  },
                  "parameters": {
                    "entityName": "cid_bulkactivitylogsdetailses",
                    "item/cid_BulkActivityLogSummary@odata.bind": "@concat('\\cid_bulkactivitylogsummaries\\',outputs('Get_Bulk_Activity_log_Summaries')?['body/cid_bulkactivitylogsummaryid'])",
                    "item/cid_errordetails": "@variables('Logged_Error_Message')",
                    "item/cid_errorwarningcode": "@variables('Error_Code')",
                    "item/cid_type": 100000000
                  },
                  "authentication": "@parameters('$authentication')"
                }
              },
              "Update_bulk_Activity_Log_Summary_2": {
                "runAfter": {},
                "metadata": {
                  "operationMetadataId": "16c1b0ac-fdb1-4356-9768-087810cae42f"
                },
                "type": "OpenApiConnection",
                "inputs": {
                  "host": {
                    "connectionName": "shared_commondataserviceforapps_1",
                    "operationId": "UpdateRecord",
                    "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
                  },
                  "parameters": {
                    "entityName": "cid_bulkactivitylogsummaries",
                    "recordId": "@triggerBody()?['activityid']",
                    "item/cid_activityendtime": "@utcNow()",
                    "item/cid_activitystarttime": "@outputs('Bulk_Activity_start_time')",
                    "item/cid_activitystatus": 100000001,
                    "item/cid_activitytype": 100000001,
                    "item/cid_filename": "@outputs('OrigionalFileName')",
                    "item/cid_language": "@variables('Language_Index')",
                    "item/cid_numberofsites": "@outputs('Number-Of-Sites')",
                    "item/cid_numberofunnumbers": "@outputs('Number-of-UNs')",
                    "item/cid_summary": "@variables('Logged_Error_Message')",
                    "item/cid_tempsharepointfilelocation": "@outputs('Create_Temp_file')?['body/Path']",
                    "item/cid_totalruntime": "@div(sub(ticks(utcNow()),ticks(outputs('Bulk_Activity_start_time'))),10000000)",
                    "item/cid_version": "@outputs('version-number')"
                  },
                  "authentication": "@parameters('$authentication')"
                }
              },
              "Send_an_HTTP_request_to_SharePoint-Delete-File": {
                "runAfter": {
                  "Add-Bulk-Activity-Logs-Details": [
                    "Succeeded"
                  ]
                },
                "metadata": {
                  "operationMetadataId": "613190e4-0e54-402c-92ea-4d8c3d1e4a7a"
                },
                "type": "OpenApiConnection",
                "inputs": {
                  "host": {
                    "connectionName": "shared_sharepointonline",
                    "operationId": "HttpRequest",
                    "apiId": "/providers/Microsoft.PowerApps/apis/shared_sharepointonline"
                  },
                  "parameters": {
                    "dataset": "https://034gc.sharepoint.com/sites/SamuraiTeam",
                    "parameters/method": "DELETE",
                    "parameters/uri": "_api/web/GetFileByServerRelativeUrl('/sites/SamuraiTeam/Shared Documents/CID_Bulk_Upload/@{variables('Environment_Folder')}/@{triggerBody()?['activityid']}/@{outputs('Create_Temp_file')?['body/Name']}')/recycle",
                    "parameters/headers": {
                      "Prefer": "bypass-shared-lock"
                    }
                  },
                  "authentication": "@parameters('$authentication')"
                }
              },
              "Delete_Folder": {
                "runAfter": {
                  "Send_an_HTTP_request_to_SharePoint-Delete-File": [
                    "Succeeded"
                  ]
                },
                "metadata": {
                  "operationMetadataId": "f00e886f-145d-4890-91e5-d4fb5eacf205"
                },
                "type": "OpenApiConnection",
                "inputs": {
                  "host": {
                    "connectionName": "shared_sharepointonline",
                    "operationId": "DeleteItem",
                    "apiId": "/providers/Microsoft.PowerApps/apis/shared_sharepointonline"
                  },
                  "parameters": {
                    "dataset": "https://034gc.sharepoint.com/sites/SamuraiTeam",
                    "table": "Documents",
                    "id": "@outputs('Create_new_folder')?['body/ID']"
                  },
                  "authentication": "@parameters('$authentication')"
                }
              }
            }
          },
          "expression": {
            "equals": [
              "@variables('IsErrorFree')",
              "@true"
            ]
          },
          "metadata": {
            "operationMetadataId": "65069879-0150-4e08-9d1e-e04210460358"
          },
          "type": "If"
        },
        "check_attachement": {
          "actions": {
            "getfilename": {
              "runAfter": {},
              "metadata": {
                "operationMetadataId": "0e873c2f-544b-4f80-a0c7-10e0e9eea411"
              },
              "type": "Compose",
              "inputs": "@concat(triggerBody()?['activityid'], '_', utcNow(), '.xlsx')"
            },
            "Create_Temp_file": {
              "runAfter": {
                "Create_new_folder": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "d78c1ad0-cc32-4c5b-bd99-b00c092fc24f"
              },
              "type": "OpenApiConnection",
              "inputs": {
                "host": {
                  "connectionName": "shared_sharepointonline",
                  "operationId": "CreateFile",
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_sharepointonline"
                },
                "parameters": {
                  "dataset": "https://034gc.sharepoint.com/sites/SamuraiTeam",
                  "folderPath": "@outputs('Create_new_folder')?['body/{FullPath}']",
                  "name": "@outputs('getfilename')",
                  "body": "@outputs('attachement')"
                },
                "authentication": "@parameters('$authentication')"
              },
              "runtimeConfiguration": {
                "contentTransfer": {
                  "transferMode": "Chunked"
                }
              }
            },
            "Create_new_folder": {
              "runAfter": {
                "getfilename": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "d1d81464-2008-4bda-9de6-02d58454c8b0"
              },
              "type": "OpenApiConnection",
              "inputs": {
                "host": {
                  "connectionName": "shared_sharepointonline",
                  "operationId": "CreateNewFolder",
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_sharepointonline"
                },
                "parameters": {
                  "dataset": "https://034gc.sharepoint.com/sites/SamuraiTeam",
                  "table": "ddbec2ce-e3a5-4bf3-b065-23b0d1d0d395",
                  "parameters/path": "/CID_Bulk_Upload/@{variables('Environment_Folder')}/@{triggerBody()?['activityid']}"
                },
                "authentication": "@parameters('$authentication')"
              }
            },
            "SharePoint-file-path": {
              "runAfter": {
                "Create_Temp_file": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "813f258f-a88e-4327-a661-56a540b24c1e"
              },
              "type": "Compose",
              "inputs": "@outputs('Create_Temp_file')?['body/Path']"
            },
            "Validation_logic": {
              "actions": {
                "Get_tables": {
                  "runAfter": {},
                  "metadata": {
                    "operationMetadataId": "d54bf7e3-e86f-4418-8a41-6e0839a09425",
                    "tableId": null
                  },
                  "type": "OpenApiConnection",
                  "inputs": {
                    "host": {
                      "connectionName": "shared_excelonlinebusiness_1",
                      "operationId": "GetTables",
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_excelonlinebusiness"
                    },
                    "parameters": {
                      "source": "sites/034gc.sharepoint.com,140da73b-4423-4443-a812-e623d6d857c4,f2a2589e-2eec-4642-9280-443640f88211",
                      "drive": "b!O6cNFCNEQ0SoEuYj1thXxJ5YovLsLkJGkoBENkD4ghHOwr7dpePzS7BlI7DR0NOV",
                      "file": "/CID_Bulk_Upload/@{variables('Environment_Folder')}/@{triggerBody()?['activityid']}/@{outputs('Create_Temp_file')?['body/Name']}"
                    },
                    "authentication": "@parameters('$authentication')"
                  }
                },
                "Filter-array-table2": {
                  "runAfter": {
                    "Get_tables": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "4f6088f2-9cee-4739-9ada-9f118e232533"
                  },
                  "type": "Query",
                  "inputs": {
                    "from": "@outputs('Get_tables')?['body/value']",
                    "where": "@equals(item()['name'], 'TableAddBasic')"
                  }
                },
                "Filter-array-Table4": {
                  "runAfter": {
                    "Filter-array-table2": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "6b2878bf-b104-467f-9d6a-3cd0583bc967"
                  },
                  "type": "Query",
                  "inputs": {
                    "from": "@outputs('Get_tables')?['body/value']",
                    "where": "@equals(item()['name'], 'TableAddExtended')"
                  }
                },
                "Filter-array-Table1": {
                  "runAfter": {
                    "Filter-array-Table4": [
                      "Succeeded"
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "9e90dfa9-e55e-43c5-94c7-2b9f55fefa01"
                  },
                  "type": "Query",
                  "inputs": {
                    "from": "@outputs('Get_tables')?['body/value']",
                    "where": "@equals(item()['name'], 'SettingTable')"
                  }
                },
                "check-If-Tables_exists-In_excel": {
                  "actions": {
                    "get_the_version_#": {
                      "runAfter": {},
                      "metadata": {
                        "operationMetadataId": "225ee8e6-dae1-4b5d-a9a1-992f64baec5b",
                        "tableId": "SettingTable"
                      },
                      "type": "OpenApiConnection",
                      "inputs": {
                        "host": {
                          "connectionName": "shared_excelonlinebusiness_1",
                          "operationId": "GetItems",
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_excelonlinebusiness"
                        },
                        "parameters": {
                          "source": "sites/034gc.sharepoint.com,140da73b-4423-4443-a812-e623d6d857c4,f2a2589e-2eec-4642-9280-443640f88211",
                          "drive": "b!O6cNFCNEQ0SoEuYj1thXxJ5YovLsLkJGkoBENkD4ghHOwr7dpePzS7BlI7DR0NOV",
                          "file": "/CID_Bulk_Upload/@{variables('Environment_Folder')}/@{triggerBody()?['activityid']}/@{outputs('Create_Temp_file')?['body/Name']}",
                          "table": "SettingTable"
                        },
                        "authentication": "@parameters('$authentication')"
                      }
                    },
                    "Get-Table-Setting": {
                      "runAfter": {
                        "get_the_version_#": [
                          "Succeeded"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "8d0cbf6f-1e9d-4224-bacd-e3ad8c39d85c"
                      },
                      "type": "OpenApiConnection",
                      "inputs": {
                        "host": {
                          "connectionName": "shared_webcontents",
                          "operationId": "InvokeHttp",
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_webcontents"
                        },
                        "parameters": {
                          "request/method": "GET",
                          "request/url": "https://graph.microsoft.com/v1.0/sites/034gc.sharepoint.com,140da73b-4423-4443-a812-e623d6d857c4,f2a2589e-2eec-4642-9280-443640f88211/lists/ddbec2ce-e3a5-4bf3-b065-23b0d1d0d395/drive/root:/@{outputs('Get-File-Relative-Path')}:/workbook/tables/SettingTable/rows"
                        },
                        "authentication": "@parameters('$authentication')"
                      }
                    },
                    "check_version_Number": {
                      "actions": {
                        "Number_of_rows_in_each_sheet": {
                          "actions": {
                            "Number-Of-Sites": {
                              "runAfter": {
                                "Number-of-UNs": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "315d245a-50d3-4ff2-a5e6-a9c456abfcf1"
                              },
                              "type": "Compose",
                              "inputs": "@length(body('List_All_Sites_with_data'))"
                            },
                            "Number-of-UNs": {
                              "runAfter": {
                                "List_All_UN_number": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "c61f60d4-dc26-49ef-9e7e-898e7f4d3fc8"
                              },
                              "type": "Compose",
                              "inputs": "@length(body('List_All_UN_number'))"
                            },
                            "Invoke_http_Get_Sites": {
                              "runAfter": {},
                              "metadata": {
                                "operationMetadataId": "8d0cbf6f-1e9d-4224-bacd-e3ad8c39d85c"
                              },
                              "type": "OpenApiConnection",
                              "inputs": {
                                "host": {
                                  "connectionName": "shared_webcontents",
                                  "operationId": "InvokeHttp",
                                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_webcontents"
                                },
                                "parameters": {
                                  "request/method": "GET",
                                  "request/url": "https://graph.microsoft.com/v1.0/sites/034gc.sharepoint.com,140da73b-4423-4443-a812-e623d6d857c4,f2a2589e-2eec-4642-9280-443640f88211/lists/ddbec2ce-e3a5-4bf3-b065-23b0d1d0d395/drive/root:/@{outputs('Get-File-Relative-Path')}:/workbook/tables/TableAddBasic/rows"
                                },
                                "authentication": "@parameters('$authentication')"
                              }
                            },
                            "List_All_UN_number": {
                              "runAfter": {
                                "Invoke-an-HTTP-request-unnumber": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "05c212d4-bdab-4ba9-a408-cc89507d9cdd"
                              },
                              "type": "Query",
                              "inputs": {
                                "from": "@outputs('Invoke-an-HTTP-request-unnumber')?['body']['value']",
                                "where": "@greater(length(item()['values'][0][1]), 0)"
                              }
                            },
                            "Invoke-an-HTTP-request-unnumber": {
                              "runAfter": {
                                "List_All_Sites_with_data": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "f11d9ebe-4fb1-412e-b313-ec10ab941bb7"
                              },
                              "type": "OpenApiConnection",
                              "inputs": {
                                "host": {
                                  "connectionName": "shared_webcontents",
                                  "operationId": "InvokeHttp",
                                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_webcontents"
                                },
                                "parameters": {
                                  "request/method": "GET",
                                  "request/url": "https://graph.microsoft.com/v1.0/sites/034gc.sharepoint.com,140da73b-4423-4443-a812-e623d6d857c4,f2a2589e-2eec-4642-9280-443640f88211/lists/ddbec2ce-e3a5-4bf3-b065-23b0d1d0d395/drive/root:/@{outputs('Get-File-Relative-Path')}:/workbook/tables/TableAddExtended/rows"
                                },
                                "authentication": "@parameters('$authentication')"
                              }
                            },
                            "List_All_Sites_with_data": {
                              "runAfter": {
                                "Invoke_http_Get_Sites": [
                                  "Succeeded"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "05c212d4-bdab-4ba9-a408-cc89507d9cdd"
                              },
                              "type": "Query",
                              "inputs": {
                                "from": "@outputs('Invoke_http_Get_Sites')?['body']['value']",
                                "where": "@greater(length(item()['values'][0][26]), 0)"
                              }
                            }
                          },
                          "runAfter": {},
                          "metadata": {
                            "operationMetadataId": "743662eb-08f8-4616-b6a4-f7ae13f823f4"
                          },
                          "type": "Scope"
                        },
                        "CompanyID-fromSetting": {
                          "runAfter": {
                            "Number_of_rows_in_each_sheet": [
                              "Succeeded"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "30a38da6-4de2-4d99-b6d7-f47cedf5ad40"
                          },
                          "type": "Compose",
                          "inputs": "@outputs('Get-Table-Setting')?['body']['value'][0]['values'][0][3]"
                        },
                        "check-if-company-name-match": {
                          "actions": {},
                          "runAfter": {
                            "CompanyName-fromSetting_": [
                              "Succeeded"
                            ]
                          },
                          "else": {
                            "actions": {
                              "Set_variable_false_company_not_match": {
                                "runAfter": {},
                                "metadata": {
                                  "operationMetadataId": "a5e5056d-1f27-41f8-9adf-f5d840e557d2"
                                },
                                "type": "SetVariable",
                                "inputs": {
                                  "name": "IsErrorFree",
                                  "value": "@false"
                                }
                              },
                              "Response": {
                                "runAfter": {
                                  "Set_variable-Logged-error-Message_B1003": [
                                    "Succeeded"
                                  ]
                                },
                                "metadata": {
                                  "operationMetadataId": "14021fe3-0ddb-4253-8e78-19b83b453fb1"
                                },
                                "type": "Response",
                                "kind": "Http",
                                "inputs": {
                                  "statusCode": 402,
                                  "body": "@variables('Error_Message')"
                                }
                              },
                              "Set_variable-Logged-error-Message_B1003": {
                                "runAfter": {
                                  "Set_variable_Error-Message_2": [
                                    "Succeeded"
                                  ]
                                },
                                "metadata": {
                                  "operationMetadataId": "e4818f97-8f16-4544-9e48-eb41e4872005"
                                },
                                "type": "SetVariable",
                                "inputs": {
                                  "name": "Logged_Error_Message",
                                  "value": "@{Replace(body('Filter_array_B1003')[0]['Message'] ,'{0}' ,outputs('CompanyName-fromSetting_'))}"
                                }
                              },
                              "filter_logged_error_and_Error_Message_B1003": {
                                "actions": {
                                  "Filter_array_B1003": {
                                    "runAfter": {},
                                    "metadata": {
                                      "operationMetadataId": "80b29c84-7347-4907-bf75-cb1f1f4e2161"
                                    },
                                    "type": "Query",
                                    "inputs": {
                                      "from": "@variables('Messages_Array')",
                                      "where": "@equals(item()['code'], variables('Error_Code'))"
                                    }
                                  },
                                  "Filter_Messages_to_log_in_bulk_log_details_B1003": {
                                    "runAfter": {
                                      "Filter_array_B1003": [
                                        "Succeeded"
                                      ]
                                    },
                                    "metadata": {
                                      "operationMetadataId": "e755b2d8-176c-430f-a770-26ce12d5e32a"
                                    },
                                    "type": "Query",
                                    "inputs": {
                                      "from": "@body('Parse_Messages_to_JSON')",
                                      "where": "@equals(item()['code'], variables('Error_Code'))"
                                    }
                                  }
                                },
                                "runAfter": {
                                  "Set_variable_6-ErrorCode_B1003": [
                                    "Succeeded"
                                  ]
                                },
                                "metadata": {
                                  "operationMetadataId": "748b3741-0b14-468f-a029-5bbe90cb8454"
                                },
                                "type": "Scope"
                              },
                              "Set_variable_6-ErrorCode_B1003": {
                                "runAfter": {
                                  "Set_variable_false_company_not_match": [
                                    "Succeeded"
                                  ]
                                },
                                "metadata": {
                                  "operationMetadataId": "724229d5-9c0a-4544-9ff2-23dc22506bcb"
                                },
                                "type": "SetVariable",
                                "inputs": {
                                  "name": "Error_Code",
                                  "value": "B1003"
                                }
                              },
                              "Set_variable_Error-Message_2": {
                                "runAfter": {
                                  "filter_logged_error_and_Error_Message_B1003": [
                                    "Succeeded"
                                  ]
                                },
                                "metadata": {
                                  "operationMetadataId": "a5ca21ab-5ce9-4dff-a3aa-d059b6b19661"
                                },
                                "type": "SetVariable",
                                "inputs": {
                                  "name": "Error_Message",
                                  "value": "@{Replace(Replace(body('Filter_array_B1003')[0]['Message'] ,'{0}' ,outputs('CompanyName-fromSetting_')) , '{1}' , outputs('Get_Company')?['body/ovs_legalname'])}"
                                }
                              }
                            }
                          },
                          "expression": {
                            "and": [
                              {
                                "equals": [
                                  "@outputs('CompanyId')",
                                  "@outputs('CompanyID-fromSetting')"
                                ]
                              },
                              {
                                "equals": [
                                  "@variables('IsErrorFree')",
                                  "@true"
                                ]
                              }
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "34a83951-6f91-4a0c-a34e-40eaf3250b14"
                          },
                          "type": "If"
                        },
                        "CompanyName-fromSetting_": {
                          "runAfter": {
                            "CompanyID-fromSetting": [
                              "Succeeded"
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "30a38da6-4de2-4d99-b6d7-f47cedf5ad40"
                          },
                          "type": "Compose",
                          "inputs": "@outputs('Get-Table-Setting')?['body']['value'][0]['values'][0][4]"
                        },
                        "Check_if_#_of_sites_is_greater_than_zero_2": {
                          "actions": {
                            "check-max-workbook-rows__2": {
                              "actions": {
                                "check_max_system_record_2": {
                                  "actions": {},
                                  "runAfter": {},
                                  "else": {
                                    "actions": {
                                      "Set_variable_6": {
                                        "runAfter": {},
                                        "metadata": {
                                          "operationMetadataId": "d70d0913-45a3-4db4-8ebb-398fb2f9aa11"
                                        },
                                        "type": "SetVariable",
                                        "inputs": {
                                          "name": "IsErrorFree",
                                          "value": "@false"
                                        }
                                      },
                                      "Set_variable_6-ErrorCode__B1007_2": {
                                        "runAfter": {
                                          "Set_variable_6": [
                                            "Succeeded"
                                          ]
                                        },
                                        "metadata": {
                                          "operationMetadataId": "98df166e-a29b-461b-b4bb-f5bacaf20bdb"
                                        },
                                        "type": "SetVariable",
                                        "inputs": {
                                          "name": "Error_Code",
                                          "value": "B1007"
                                        }
                                      },
                                      "filter_logged_error_and_Error_Message_6": {
                                        "actions": {
                                          "Filter_array_B1007_2": {
                                            "runAfter": {},
                                            "metadata": {
                                              "operationMetadataId": "80b29c84-7347-4907-bf75-cb1f1f4e2161"
                                            },
                                            "type": "Query",
                                            "inputs": {
                                              "from": "@variables('Messages_Array')",
                                              "where": "@equals(item()['code'], variables('Error_Code'))"
                                            }
                                          },
                                          "Filter_Messages_to_log_in_bulk_log_details_B1007_2": {
                                            "runAfter": {
                                              "Filter_array_B1007_2": [
                                                "Succeeded"
                                              ]
                                            },
                                            "metadata": {
                                              "operationMetadataId": "e755b2d8-176c-430f-a770-26ce12d5e32a"
                                            },
                                            "type": "Query",
                                            "inputs": {
                                              "from": "@body('Parse_Messages_to_JSON')",
                                              "where": "@equals(item()['code'], variables('Error_Code'))"
                                            }
                                          }
                                        },
                                        "runAfter": {
                                          "Set_variable_6-ErrorCode__B1007_2": [
                                            "Succeeded"
                                          ]
                                        },
                                        "metadata": {
                                          "operationMetadataId": "0f64cc0a-0adb-4333-bb71-020401a1a05d"
                                        },
                                        "type": "Scope"
                                      },
                                      "Set_variable_Error-Message_[_B1007]_2": {
                                        "runAfter": {
                                          "filter_logged_error_and_Error_Message_6": [
                                            "Succeeded"
                                          ]
                                        },
                                        "metadata": {
                                          "operationMetadataId": "30cf9ef0-30f5-4857-a2ac-db5d593568f5"
                                        },
                                        "type": "SetVariable",
                                        "inputs": {
                                          "name": "Error_Message",
                                          "value": "@{Replace(Replace(string(body('Filter_array_B1007_2')[0]['Message']), '{0}', string(outputs('Number-Of-Listed-Sites'))), '{1}', string(outputs('Number-Of-UN-Listed')))}"
                                        }
                                      },
                                      "Set_variable-Logged-error-Message_3": {
                                        "runAfter": {
                                          "Set_variable_Error-Message_[_B1007]_2": [
                                            "Succeeded"
                                          ]
                                        },
                                        "metadata": {
                                          "operationMetadataId": "bf1fa5f4-e23d-4fe2-b5e9-4c97a7b80ac7"
                                        },
                                        "type": "SetVariable",
                                        "inputs": {
                                          "name": "Logged_Error_Message",
                                          "value": "Error - Bulk Site Registration Upload: CID for this Company has too many rows of Sites data @{outputs('Number-Of-Listed-Sites')} and/or rows of UN data  @{outputs('Number-Of-UN-Listed')}, versus limits of @{outputs('Max-system-sites')} and @{outputs('Max-System-UNnumbers')}.[B1007]"
                                        }
                                      },
                                      "Response_-_exceed_max_system_2": {
                                        "runAfter": {
                                          "Set_variable-Logged-error-Message_3": [
                                            "Succeeded"
                                          ]
                                        },
                                        "metadata": {
                                          "operationMetadataId": "07b6d268-f617-4d10-9369-3ae227b7f852"
                                        },
                                        "type": "Response",
                                        "kind": "Http",
                                        "inputs": {
                                          "statusCode": 402,
                                          "body": "@variables('Error_Message')"
                                        }
                                      }
                                    }
                                  },
                                  "expression": {
                                    "or": [
                                      {
                                        "less": [
                                          "@outputs('Number-Of-Listed-Sites')",
                                          "@outputs('Max-system-sites')"
                                        ]
                                      },
                                      {
                                        "less": [
                                          "@outputs('Number-Of-UN-Listed')",
                                          "@outputs('Max-System-UNnumbers')"
                                        ]
                                      }
                                    ]
                                  },
                                  "metadata": {
                                    "operationMetadataId": "8db5c542-dfd8-4988-8ad5-ca6b97f6f119"
                                  },
                                  "type": "If"
                                }
                              },
                              "runAfter": {},
                              "else": {
                                "actions": {
                                  "Set_variable_7": {
                                    "runAfter": {},
                                    "metadata": {
                                      "operationMetadataId": "3cc8fb12-bb4e-4939-9646-e826b6fb19ee"
                                    },
                                    "type": "SetVariable",
                                    "inputs": {
                                      "name": "IsErrorFree",
                                      "value": "@false"
                                    }
                                  },
                                  "Response-excel-exceed-Max-Allowed-rows-in-Excel_2": {
                                    "runAfter": {
                                      "Set_variable-Logged-error-Message_6": [
                                        "Succeeded"
                                      ]
                                    },
                                    "metadata": {
                                      "operationMetadataId": "b46fae1f-6003-49b8-b2ab-717dca013b0c"
                                    },
                                    "type": "Response",
                                    "kind": "Http",
                                    "inputs": {
                                      "statusCode": 402,
                                      "body": "@variables('Error_Message')"
                                    }
                                  },
                                  "Set_variable_6-ErrorCode__B1006_2": {
                                    "runAfter": {
                                      "Set_variable_7": [
                                        "Succeeded"
                                      ]
                                    },
                                    "metadata": {
                                      "operationMetadataId": "72872a57-3d8a-443b-8df8-c26a022cc8a0"
                                    },
                                    "type": "SetVariable",
                                    "inputs": {
                                      "name": "Error_Code",
                                      "value": "B1006"
                                    }
                                  },
                                  "Set_variable-Logged-error-Message_6": {
                                    "runAfter": {
                                      "Set_variable_Error-Message_7": [
                                        "Succeeded"
                                      ]
                                    },
                                    "metadata": {
                                      "operationMetadataId": "2a072103-c96f-4e07-9a91-e49f651f6826"
                                    },
                                    "type": "SetVariable",
                                    "inputs": {
                                      "name": "Logged_Error_Message",
                                      "value": "@{Replace(Replace(Replace(Replace(string(body('Filter_Messages_to_log_in_bulk_log_details_B1006_2')[0]['Eng-Message']), '{0}', string(outputs('Number-Of-Sites'))), '{1}', string(outputs('Number-of-UNs'))), '{2}', string(outputs('Max-Workbook-sites'))), '{3}', string(outputs('Max-Workbook-UNnumbers')))}"
                                    }
                                  },
                                  "Set_variable_Error-Message_7": {
                                    "runAfter": {
                                      "filter_logged_error_and_Error_Message_7": [
                                        "Succeeded"
                                      ]
                                    },
                                    "metadata": {
                                      "operationMetadataId": "bd737d61-1164-47aa-a89e-b32fd290bc02"
                                    },
                                    "type": "SetVariable",
                                    "inputs": {
                                      "name": "Error_Message",
                                      "value": "@{Replace(Replace(Replace(Replace(string(body('Filter_array_B1006_2')[0]['Message']), '{0}', string(outputs('Number-Of-Sites'))), '{1}', string(outputs('Number-of-UNs'))), '{2}', string(outputs('Max-Workbook-sites'))), '{3}', string(outputs('Max-Workbook-UNnumbers')))}\n"
                                    }
                                  },
                                  "filter_logged_error_and_Error_Message_7": {
                                    "actions": {
                                      "Filter_array_B1006_2": {
                                        "runAfter": {},
                                        "metadata": {
                                          "operationMetadataId": "80b29c84-7347-4907-bf75-cb1f1f4e2161"
                                        },
                                        "type": "Query",
                                        "inputs": {
                                          "from": "@variables('Messages_Array')",
                                          "where": "@equals(item()['code'], variables('Error_Code'))"
                                        }
                                      },
                                      "Filter_Messages_to_log_in_bulk_log_details_B1006_2": {
                                        "runAfter": {
                                          "Filter_array_B1006_2": [
                                            "Succeeded"
                                          ]
                                        },
                                        "metadata": {
                                          "operationMetadataId": "e755b2d8-176c-430f-a770-26ce12d5e32a"
                                        },
                                        "type": "Query",
                                        "inputs": {
                                          "from": "@body('Parse_Messages_to_JSON')",
                                          "where": "@equals(item()['code'], variables('Error_Code'))"
                                        }
                                      }
                                    },
                                    "runAfter": {
                                      "Set_variable_6-ErrorCode__B1006_2": [
                                        "Succeeded"
                                      ]
                                    },
                                    "metadata": {
                                      "operationMetadataId": "64cdce6e-bd45-4bcb-bbb8-d72f90cdaede"
                                    },
                                    "type": "Scope"
                                  }
                                }
                              },
                              "expression": {
                                "or": [
                                  {
                                    "less": [
                                      "@outputs('Number-Of-Sites')",
                                      "@outputs('Max-Workbook-sites')"
                                    ]
                                  },
                                  {
                                    "less": [
                                      "@outputs('Number-of-UNs')",
                                      "@outputs('Max-Workbook-UNnumbers')"
                                    ]
                                  }
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "490735b9-d8a0-4ae7-ae26-eff03f1dff4b"
                              },
                              "type": "If"
                            }
                          },
                          "runAfter": {
                            "check-if-company-name-match": [
                              "Succeeded"
                            ]
                          },
                          "else": {
                            "actions": {
                              "Set_variable_2": {
                                "runAfter": {},
                                "metadata": {
                                  "operationMetadataId": "da077faa-e8b0-42e3-ad6b-1029af4edf4f"
                                },
                                "type": "SetVariable",
                                "inputs": {
                                  "name": "IsErrorFree",
                                  "value": "@false"
                                }
                              },
                              "Response_-_file_empty_2": {
                                "runAfter": {
                                  "Set_variable-Logged-error-Message_B1005_2": [
                                    "Succeeded"
                                  ]
                                },
                                "metadata": {
                                  "operationMetadataId": "701e7b6a-a2d5-4722-b64d-1344404671a7"
                                },
                                "type": "Response",
                                "kind": "Http",
                                "inputs": {
                                  "statusCode": 402,
                                  "body": "@variables('Error_Message')"
                                }
                              },
                              "Set_variable_Error-Message_5": {
                                "runAfter": {
                                  "filter_logged_error_and_Error_Message_5": [
                                    "Succeeded"
                                  ]
                                },
                                "metadata": {
                                  "operationMetadataId": "becb8a07-c9c3-48c4-a0f7-1eca08664fe9"
                                },
                                "type": "SetVariable",
                                "inputs": {
                                  "name": "Error_Message",
                                  "value": "@{body('Filter_array_B1005')[0]['Message']}"
                                }
                              },
                              "Set_variable-Logged-error-Message_B1005_2": {
                                "runAfter": {
                                  "Set_variable_Error-Message_5": [
                                    "Succeeded"
                                  ]
                                },
                                "metadata": {
                                  "operationMetadataId": "51765c19-e943-45c6-a40d-0a70a1f4ca1a"
                                },
                                "type": "SetVariable",
                                "inputs": {
                                  "name": "Logged_Error_Message",
                                  "value": "@{body('Filter_Messages_to_log_in_bulk_log_details_B1005')[0]['Eng-Message']}"
                                }
                              },
                              "Set_variable_6-ErrorCode_B1005_2": {
                                "runAfter": {
                                  "Set_variable_2": [
                                    "Succeeded"
                                  ]
                                },
                                "metadata": {
                                  "operationMetadataId": "23991f98-bd9d-4d32-aa8e-d5d8e6b99589"
                                },
                                "type": "SetVariable",
                                "inputs": {
                                  "name": "Error_Code",
                                  "value": "B1005"
                                }
                              },
                              "filter_logged_error_and_Error_Message_5": {
                                "actions": {
                                  "Filter_array_B1005": {
                                    "runAfter": {},
                                    "metadata": {
                                      "operationMetadataId": "80b29c84-7347-4907-bf75-cb1f1f4e2161"
                                    },
                                    "type": "Query",
                                    "inputs": {
                                      "from": "@variables('Messages_Array')",
                                      "where": "@equals(item()['code'], variables('Error_Code'))"
                                    }
                                  },
                                  "Filter_Messages_to_log_in_bulk_log_details_B1005": {
                                    "runAfter": {
                                      "Filter_array_B1005": [
                                        "Succeeded"
                                      ]
                                    },
                                    "metadata": {
                                      "operationMetadataId": "e755b2d8-176c-430f-a770-26ce12d5e32a"
                                    },
                                    "type": "Query",
                                    "inputs": {
                                      "from": "@body('Parse_Messages_to_JSON')",
                                      "where": "@equals(item()['code'], variables('Error_Code'))"
                                    }
                                  }
                                },
                                "runAfter": {
                                  "Set_variable_6-ErrorCode_B1005_2": [
                                    "Succeeded"
                                  ]
                                },
                                "metadata": {
                                  "operationMetadataId": "6a959f68-8cb1-406a-a26c-cac8beeb4f90"
                                },
                                "type": "Scope"
                              }
                            }
                          },
                          "expression": {
                            "greater": [
                              "@outputs('Number-Of-Sites')",
                              0
                            ]
                          },
                          "metadata": {
                            "operationMetadataId": "85996040-d468-47c0-9bfe-b248a74612e0"
                          },
                          "type": "If"
                        }
                      },
                      "runAfter": {
                        "Get-Table-Setting": [
                          "Succeeded"
                        ]
                      },
                      "else": {
                        "actions": {
                          "Set_variable": {
                            "runAfter": {},
                            "metadata": {
                              "operationMetadataId": "9a3febac-5919-4293-94ac-ec6450e16553"
                            },
                            "type": "SetVariable",
                            "inputs": {
                              "name": "IsErrorFree",
                              "value": "@false"
                            }
                          },
                          "Response-wrong-version": {
                            "runAfter": {
                              "Set_variable-Logged-error-Message_B1004": [
                                "Succeeded"
                              ]
                            },
                            "metadata": {
                              "operationMetadataId": "1f529166-a6ec-423d-9a92-396a0ad70218"
                            },
                            "type": "Response",
                            "kind": "Http",
                            "inputs": {
                              "statusCode": 401,
                              "headers": {
                                "Error": "@variables('Error_Message')"
                              },
                              "body": "@variables('Error_Message')"
                            }
                          },
                          "Set_variable_6-ErrorCode_B1004": {
                            "runAfter": {
                              "Set_variable": [
                                "Succeeded"
                              ]
                            },
                            "metadata": {
                              "operationMetadataId": "d9cc657f-ad59-482e-b6b1-6d31a09ab404"
                            },
                            "type": "SetVariable",
                            "inputs": {
                              "name": "Error_Code",
                              "value": "B1004"
                            }
                          },
                          "Set_variable-Logged-error-Message_B1004": {
                            "runAfter": {
                              "Set_variable_Error-Message": [
                                "Succeeded"
                              ]
                            },
                            "metadata": {
                              "operationMetadataId": "a38bd09e-8950-4a84-a03b-5746b1cf2b7c"
                            },
                            "type": "SetVariable",
                            "inputs": {
                              "name": "Logged_Error_Message",
                              "value": "Error - Bulk Site Registration Upload: File’s version of  @{outputs('get_the_version_#')?['body/value'][0]?['version Number']} is less than the current minimum file version @{outputs('version-number')}. [B1004]"
                            }
                          },
                          "Set_variable_Error-Message": {
                            "runAfter": {
                              "filter_logged_error_and_Error_Message_B1004": [
                                "Succeeded"
                              ]
                            },
                            "metadata": {
                              "operationMetadataId": "3cc05f8b-d916-4cf3-abb3-63f2cd66891f"
                            },
                            "type": "SetVariable",
                            "inputs": {
                              "name": "Error_Message",
                              "value": "@{body('Filter_array_B1004')[0]['Message']}"
                            }
                          },
                          "filter_logged_error_and_Error_Message_B1004": {
                            "actions": {
                              "Filter_array_B1004": {
                                "runAfter": {},
                                "metadata": {
                                  "operationMetadataId": "80b29c84-7347-4907-bf75-cb1f1f4e2161"
                                },
                                "type": "Query",
                                "inputs": {
                                  "from": "@variables('Messages_Array')",
                                  "where": "@equals(item()['code'], variables('Error_Code'))"
                                }
                              },
                              "Filter_Messages_to_log_in_bulk_log_details_B1004": {
                                "runAfter": {
                                  "Filter_array_B1004": [
                                    "Succeeded"
                                  ]
                                },
                                "metadata": {
                                  "operationMetadataId": "e755b2d8-176c-430f-a770-26ce12d5e32a"
                                },
                                "type": "Query",
                                "inputs": {
                                  "from": "@body('Parse_Messages_to_JSON')",
                                  "where": "@equals(item()['code'], variables('Error_Code'))"
                                }
                              }
                            },
                            "runAfter": {
                              "Set_variable_6-ErrorCode_B1004": [
                                "Succeeded"
                              ]
                            },
                            "metadata": {
                              "operationMetadataId": "f48537b5-a34d-4182-9aea-47921def7c51"
                            },
                            "type": "Scope"
                          }
                        }
                      },
                      "expression": {
                        "equals": [
                          "@outputs('get_the_version_#')?['body/value'][0]?['version Number']",
                          "@outputs('version-number')"
                        ]
                      },
                      "metadata": {
                        "operationMetadataId": "a782cd03-7b79-4f14-80d5-4a9c5c6110da"
                      },
                      "type": "If"
                    }
                  },
                  "runAfter": {
                    "Filter-array-Table1": [
                      "Succeeded"
                    ]
                  },
                  "else": {
                    "actions": {
                      "Set_IsErrorFree_to_false": {
                        "runAfter": {},
                        "metadata": {
                          "operationMetadataId": "97bb35e1-166e-43b9-babc-3161cd46cc09"
                        },
                        "type": "SetVariable",
                        "inputs": {
                          "name": "IsErrorFree",
                          "value": "@false"
                        }
                      },
                      "Response_-_send_template_error_response": {
                        "runAfter": {
                          "Set_variable-Logged-error-Message_2": [
                            "Succeeded"
                          ]
                        },
                        "metadata": {
                          "operationMetadataId": "ee3c3cd2-006d-4ac8-a012-7c327fbf86fd"
                        },
                        "type": "Response",
                        "kind": "Http",
                        "inputs": {
                          "statusCode": 401,
                          "body": "@variables('Error_Message')"
                        }
                      },
                      "Set_variable__flag_allTable_exists_to_false": {
                        "runAfter": {
                          "Set_IsErrorFree_to_false": [
                            "Succeeded"
                          ]
                        },
                        "metadata": {
                          "operationMetadataId": "62a41d5d-eae5-47bf-a918-bb2a549665e2"
                        },
                        "type": "SetVariable",
                        "inputs": {
                          "name": "Flage_All_Table_exists",
                          "value": "@false"
                        }
                      },
                      "Set_variable-ErrorCode_B1002_": {
                        "runAfter": {
                          "Set_variable__flag_allTable_exists_to_false": [
                            "Succeeded"
                          ]
                        },
                        "metadata": {
                          "operationMetadataId": "d9cc657f-ad59-482e-b6b1-6d31a09ab404"
                        },
                        "type": "SetVariable",
                        "inputs": {
                          "name": "Error_Code",
                          "value": "B1002"
                        }
                      },
                      "Set_variable_Error-Message_6": {
                        "runAfter": {
                          "filter_logged_error_and_Error_Message": [
                            "Succeeded"
                          ]
                        },
                        "metadata": {
                          "operationMetadataId": "3cc05f8b-d916-4cf3-abb3-63f2cd66891f"
                        },
                        "type": "SetVariable",
                        "inputs": {
                          "name": "Error_Message",
                          "value": "@{body('Filter_array_B1002')[0]['Message']}"
                        }
                      },
                      "Set_variable-Logged-error-Message_2": {
                        "runAfter": {
                          "Set_variable_Error-Message_6": [
                            "Succeeded"
                          ]
                        },
                        "metadata": {
                          "operationMetadataId": "419289f3-0828-4b20-aece-18c72bc35de2"
                        },
                        "type": "SetVariable",
                        "inputs": {
                          "name": "Logged_Error_Message",
                          "value": "@{body('Filter_Messages_to_log_in_bulk_log_details_B1002')[0]['Eng-Message']}"
                        }
                      },
                      "filter_logged_error_and_Error_Message": {
                        "actions": {
                          "Filter_array_B1002": {
                            "runAfter": {},
                            "metadata": {
                              "operationMetadataId": "80b29c84-7347-4907-bf75-cb1f1f4e2161"
                            },
                            "type": "Query",
                            "inputs": {
                              "from": "@variables('Messages_Array')",
                              "where": "@equals(item()['code'], variables('Error_Code'))"
                            }
                          },
                          "Filter_Messages_to_log_in_bulk_log_details_B1002": {
                            "runAfter": {
                              "Filter_array_B1002": [
                                "Succeeded"
                              ]
                            },
                            "metadata": {
                              "operationMetadataId": "e755b2d8-176c-430f-a770-26ce12d5e32a"
                            },
                            "type": "Query",
                            "inputs": {
                              "from": "@body('Parse_Messages_to_JSON')",
                              "where": "@equals(item()['code'], variables('Error_Code'))"
                            }
                          }
                        },
                        "runAfter": {
                          "Set_variable-ErrorCode_B1002_": [
                            "Succeeded"
                          ]
                        },
                        "metadata": {
                          "operationMetadataId": "171aebed-046f-4bae-8c20-ca144c23c28f"
                        },
                        "type": "Scope"
                      }
                    }
                  },
                  "expression": {
                    "and": [
                      {
                        "greater": [
                          "@length(body('Filter-array-Table1'))",
                          0
                        ]
                      },
                      {
                        "greater": [
                          "@length(body('Filter-array-table2'))",
                          0
                        ]
                      },
                      {
                        "greater": [
                          "@length(body('Filter-array-Table4'))",
                          0
                        ]
                      }
                    ]
                  },
                  "metadata": {
                    "operationMetadataId": "741e3a50-0416-4cc0-bacc-5794139a364c"
                  },
                  "type": "If"
                }
              },
              "runAfter": {
                "Get-File-Relative-Path": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "8f162a33-d8d8-4206-b291-c543bf9406ea"
              },
              "type": "Scope"
            },
            "Get-File-Relative-Path": {
              "runAfter": {
                "SharePoint-file-path": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "62a55140-16b9-46c5-8165-dbd9d75253d9"
              },
              "type": "Compose",
              "inputs": "@substring(outputs('SharePoint-file-path'), indexOf(outputs('SharePoint-file-path'), 'CID_Bulk_Upload'))"
            }
          },
          "runAfter": {
            "CompanyId": [
              "Succeeded"
            ],
            "get_Attachment_conetent": [
              "Succeeded"
            ],
            "Initialize_Environment_folder_variable": [
              "Succeeded"
            ],
            "Number-Of-Sites-With-Reqiurement-Level": [
              "Succeeded"
            ],
            "Number-Of-UN-Listed": [
              "Succeeded"
            ]
          },
          "else": {
            "actions": {
              "Set_variable-IsErrorFree-to-false": {
                "runAfter": {},
                "metadata": {
                  "operationMetadataId": "6854c04f-327e-4ed5-b17e-f8a85946dc59"
                },
                "type": "SetVariable",
                "inputs": {
                  "name": "IsErrorFree",
                  "value": "@false"
                }
              },
              "Response_attachment_not_found": {
                "runAfter": {
                  "Set_variable-Logged-error-Message": [
                    "Succeeded"
                  ]
                },
                "metadata": {
                  "operationMetadataId": "1f529166-a6ec-423d-9a92-396a0ad70218"
                },
                "type": "Response",
                "kind": "Http",
                "inputs": {
                  "statusCode": 401,
                  "headers": {
                    "Error": "\"Filet not found\""
                  },
                  "body": "File Not Found"
                }
              },
              "Set_variable_6-ErrorCode": {
                "runAfter": {
                  "Set_variable-IsErrorFree-to-false": [
                    "Succeeded"
                  ]
                },
                "metadata": {
                  "operationMetadataId": "15df6c9d-8f76-47dd-9dff-a12998341d47"
                },
                "type": "SetVariable",
                "inputs": {
                  "name": "Error_Code",
                  "value": "0"
                }
              },
              "Set_variable-ErrorMessage": {
                "runAfter": {
                  "Set_variable_6-ErrorCode": [
                    "Succeeded"
                  ]
                },
                "metadata": {
                  "operationMetadataId": "9765b487-338d-496e-8bc7-9bd82cde07fb"
                },
                "type": "SetVariable",
                "inputs": {
                  "name": "Error_Message",
                  "value": "File Not Found"
                }
              },
              "Set_variable-Logged-error-Message": {
                "runAfter": {
                  "Set_variable-ErrorMessage": [
                    "Succeeded"
                  ]
                },
                "metadata": {
                  "operationMetadataId": "cc717399-1be5-4553-8b05-b013fb8b4c08"
                },
                "type": "SetVariable",
                "inputs": {
                  "name": "Logged_Error_Message",
                  "value": "File Not Found"
                }
              }
            }
          },
          "expression": {
            "not": {
              "equals": [
                "@outputs('attachement')",
                "Null"
              ]
            }
          },
          "metadata": {
            "operationMetadataId": "06b869e6-ecc6-4f8d-a019-d96151a0cbed"
          },
          "type": "If"
        },
        "ActionBy": {
          "runAfter": {
            "Get_Bulk_Activity_log_Summaries": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "1c1b15c1-fa5b-476a-857a-ea18ee67282e"
          },
          "type": "Compose",
          "inputs": "@outputs('Get_Bulk_Activity_log_Summaries-initial')?['body']['_cid_actionedby_value@OData.Community.Display.V1.FormattedValue']"
        },
        "Error_List_Variable": {
          "runAfter": {
            "Initialize_variable_-_Log_Error_Message": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "a10a3b39-9550-46b6-b00c-75dd826be0a2"
          },
          "type": "InitializeVariable",
          "inputs": {
            "variables": [
              {
                "name": "Error_List",
                "type": "array",
                "value": [
                  {
                    "Site_address": "",
                    "Error": ""
                  }
                ]
              }
            ]
          }
        },
        "Initialize_ProvinceCodes_variable": {
          "runAfter": {
            "Error_List_Variable": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "74815300-3912-4a4c-ad7f-1cfdca4d3ce9"
          },
          "type": "InitializeVariable",
          "inputs": {
            "variables": [
              {
                "name": "ProvinceCodes",
                "type": "object",
                "value": {
                  "NL": "10",
                  "PE": "11",
                  "NS": "12",
                  "NB": "13",
                  "QC": "24",
                  "ON": "35",
                  "MB": "46",
                  "SK": "47",
                  "AB": "48",
                  "BC": "59",
                  "YU": "60",
                  "NT": "61",
                  "NU": "62",
                  "UF": "72",
                  "IW": "73"
                }
              }
            ]
          }
        },
        "All-Tables_exists-in-Excel-Flag": {
          "runAfter": {
            "Initialize_ProvinceCodes_variable": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "ea234297-f193-4320-b5cf-eeed009e2f42"
          },
          "type": "InitializeVariable",
          "inputs": {
            "variables": [
              {
                "name": "Flage_All_Table_exists",
                "type": "boolean",
                "value": "@true"
              }
            ]
          }
        },
        "Error_flag": {
          "runAfter": {
            "All-Tables_exists-in-Excel-Flag": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "af9c01db-59f3-46fa-826e-e24fc2c82cca"
          },
          "type": "InitializeVariable",
          "inputs": {
            "variables": [
              {
                "name": "IsErrorFree",
                "type": "boolean",
                "value": "@true"
              }
            ]
          }
        },
        "Initialize_variable-Error-Message": {
          "runAfter": {
            "Error_flag": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "35b9d1fb-da0e-491e-9802-9126b6c5408c"
          },
          "type": "InitializeVariable",
          "inputs": {
            "variables": [
              {
                "name": "Error_Message",
                "type": "string"
              }
            ]
          }
        },
        "Initialize_variable-ErrorCode": {
          "runAfter": {
            "Initialize_variable-Error-Message": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "745a4749-12a3-439a-9231-6a95cf6876bb"
          },
          "type": "InitializeVariable",
          "inputs": {
            "variables": [
              {
                "name": "Error_Code",
                "type": "string"
              }
            ]
          }
        },
        "Initialize_variable-Type": {
          "runAfter": {
            "Initialize_variable-ErrorCode": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "cb871a38-ef64-4045-b2ea-6ca03491784d"
          },
          "type": "InitializeVariable",
          "inputs": {
            "variables": [
              {
                "name": "LogType",
                "type": "string"
              }
            ]
          }
        },
        "Bulk_Activity_start_time": {
          "runAfter": {},
          "metadata": {
            "operationMetadataId": "6907a2ad-8951-45c7-990f-5ced90c5981a"
          },
          "type": "Compose",
          "inputs": "@utcNow()"
        },
        "Filter_array-All_Sites_With_RequirementLevel-Contains-Data": {
          "runAfter": {
            "Number-Of-Listed-Sites": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "36daded1-93fb-4282-b71d-acdd36335cd4"
          },
          "type": "Query",
          "inputs": {
            "from": "@outputs('List_All_sites')?['body/value']",
            "where": "@not(equals(item()?['cid_requirementlevel'], null))"
          }
        },
        "Number-Of-Sites-With-Reqiurement-Level": {
          "runAfter": {
            "Filter_array-All_Sites_With_RequirementLevel-Contains-Data": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "574efb28-9b54-49f4-ac70-7775b4716888"
          },
          "type": "Compose",
          "inputs": "@length(body('Filter_array-All_Sites_With_RequirementLevel-Contains-Data'))"
        },
        "Number-Of-Listed-Sites": {
          "runAfter": {
            "List_All_sites": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "bf0003ef-b457-4552-a231-5139af15d7bc"
          },
          "type": "Compose",
          "inputs": "@length(outputs('List_All_sites')?['body/value'])"
        },
        "Number-Of-UN-Listed": {
          "runAfter": {
            "List_All_Un_numbers": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "a0446023-d515-4093-99e2-c9fcbf71455b"
          },
          "type": "Compose",
          "inputs": "@length(outputs('List_All_Un_numbers')?['body/value'])"
        },
        "Initialize_variable_-_Log_Error_Message": {
          "runAfter": {
            "Initialize_variable_-_Language_Index_-_default_english": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "22b9d9ec-f2ae-4346-a68c-31f80dc842d9"
          },
          "type": "InitializeVariable",
          "inputs": {
            "variables": [
              {
                "name": "Logged_Error_Message",
                "type": "string"
              }
            ]
          }
        },
        "Initialize_variable_-_Language_Index_-_default_english": {
          "runAfter": {
            "Initialize_variable_-_Activity_type": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "2e0ab909-9d77-4bf0-8692-08dd432b957d"
          },
          "type": "InitializeVariable",
          "inputs": {
            "variables": [
              {
                "name": "Language_Index",
                "type": "integer",
                "value": 918640001
              }
            ]
          }
        },
        "check_Language": {
          "actions": {
            "Set_variable_-_Set_Language_code_to_French": {
              "runAfter": {},
              "metadata": {
                "operationMetadataId": "33b646d2-8978-4fc8-9857-a59fdbc6a870"
              },
              "type": "SetVariable",
              "inputs": {
                "name": "Language_Index",
                "value": 918640002
              }
            },
            "Select_-_French_Language": {
              "runAfter": {
                "Set_variable_-_Set_Language_code_to_French": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "7e1b1002-0ea0-4737-81cd-7a7ddee851b1"
              },
              "type": "Select",
              "inputs": {
                "from": "@body('Parse_Messages_to_JSON')",
                "select": {
                  "code": "@item()['code']",
                  "Message": "@item()['Fr-Message']"
                }
              }
            },
            "for_each_French_message": {
              "foreach": "@body('Select_-_French_Language')",
              "actions": {
                "Append_to_array_variable_French_Message": {
                  "runAfter": {},
                  "metadata": {
                    "operationMetadataId": "6ca892ec-2f00-4e9c-9c07-db6a700f96df"
                  },
                  "type": "AppendToArrayVariable",
                  "inputs": {
                    "name": "Messages_Array",
                    "value": "@items('for_each_French_message')"
                  }
                }
              },
              "runAfter": {
                "Select_-_French_Language": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "1b147b98-4f69-4ed0-a0b3-3d01bf011e07"
              },
              "type": "Foreach"
            }
          },
          "runAfter": {
            "Get_Contact": [
              "Succeeded"
            ]
          },
          "else": {
            "actions": {
              "Select_-_English_Language": {
                "runAfter": {},
                "metadata": {
                  "operationMetadataId": "2f87aa54-460c-45c4-a069-00ea3dbd7bf2"
                },
                "type": "Select",
                "inputs": {
                  "from": "@body('Parse_Messages_to_JSON')",
                  "select": {
                    "code": "@item()['code']",
                    "Message": "@item()['Eng-Message']"
                  }
                }
              },
              "Apply_to_each_English_Message": {
                "foreach": "@body('Select_-_English_Language')",
                "actions": {
                  "Append_to_array_variable_3": {
                    "runAfter": {},
                    "metadata": {
                      "operationMetadataId": "e34d2bba-d320-4f5a-9b95-0e2454bf437e"
                    },
                    "type": "AppendToArrayVariable",
                    "inputs": {
                      "name": "Messages_Array",
                      "value": "@items('Apply_to_each_English_Message')"
                    }
                  }
                },
                "runAfter": {
                  "Select_-_English_Language": [
                    "Succeeded"
                  ]
                },
                "metadata": {
                  "operationMetadataId": "21b64a4a-96fd-4540-b578-86cee5235ab6"
                },
                "type": "Foreach"
              }
            }
          },
          "expression": {
            "not": {
              "contains": [
                "@triggerBody()?['Lang']",
                "en"
              ]
            }
          },
          "metadata": {
            "operationMetadataId": "949613ef-c3ae-49bf-a41e-8bd4d3467616"
          },
          "type": "If"
        },
        "Initialize_variable_-_Messages_Array": {
          "runAfter": {
            "Initialize_variable-Type": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "499f5dda-1202-4d2e-9116-d73467858d68"
          },
          "type": "InitializeVariable",
          "inputs": {
            "variables": [
              {
                "name": "Messages_Array",
                "type": "array"
              }
            ]
          }
        },
        "Messaages": {
          "runAfter": {
            "Initialize_variable_-_Messages_Array": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "04d08f07-7aa1-43e4-8da5-adb1e21d7258"
          },
          "type": "Compose",
          "inputs": [
            {
              "code": "B1001",
              "Eng-Message": "A scan of the file has found a potential virus. <br> <br>Please download and update a new version of the Site Bulk Upload Excel Template, then upload that file instead. [B1001]",
              "Fr-Message": "Une analyse du fichier a trouvé un virus potentiel. <br> <br> Veuillez télécharger et mettre à jour une nouvelle version du modèle Excel de téléchargement groupé du site, puis téléchargez ce fichier à la place.[B1001]"
            },
            {
              "code": "B1002",
              "Eng-Message": "The uploaded file is not the custom Site Bulk Upload Excel workbook. <br><br> Please download and update a new version of the Site Bulk Upload Excel Template, then upload that file instead. [B1002] ",
              "Fr-Message": "Le fichier téléchargé n'est pas le classeur Excel personnalisé de téléchargement en masse du site. <br><br> Veuillez télécharger et mettre à jour une nouvelle version du modèle Excel de téléchargement groupé du site, puis téléchargez ce fichier à la place.[B1002] "
            },
            {
              "code": "B1003",
              "Eng-Message": "The uploaded file is assigned to the ‘{0}’ Company, versus your own Company of '{1}'. <br><br>  Please download and update a new version of the Site Bulk Upload Excel Template, then upload that file instead. [B1003] ",
              "Fr-Message": "Le fichier téléchargé est attribué à la société '{0}', par opposition à votre propre société de '{1}'. <br><br>  Veuillez télécharger et mettre à jour une nouvelle version du modèle Excel de téléchargement groupé du site, puis téléchargez ce fichier à la place. [B1003]"
            },
            {
              "code": "B1004",
              "Eng-Message": "The uploaded file is based on a template that is no longer current. <br><br>  Please download and update a new version of the Site Bulk Upload Excel template, then upload that completed workbook instead. [B1004] ",
              "Fr-Message": "Le fichier téléchargé est basé sur un modèle qui n'est plus actuel. <br>Veuillez télécharger et mettre à jour une nouvelle version du modèle Excel de téléchargement groupé du site, puis téléchargez ce fichier à la place. [B1004]"
            },
            {
              "code": "B1005",
              "Eng-Message": "The uploaded file is empty. Please update the file with the Basic, and if required Extended, Site information, Guidance for the data entry can be found in the [Instructions] sheet of the workbook. <br> <br>When that process is complete, then upload that version of the file. [B1005]",
              "Fr-Message": "Le fichier téléchargé est vide. Veuillez mettre à jour le fichier avec les informations de base et, si nécessaire, les informations étendues sur le site. Des conseils pour la saisie des données peuvent être trouvés dans la feuille [Instructions] du classeur. <br> <br>Une fois ce processus terminé, téléchargez cette version du fichier. [B1005]"
            },
            {
              "code": "B1006",
              "Eng-Message": "This workbook contains {0} rows of Site data and {1} rows of UN data for those sites. This exceeds the acceptable limits for the bulk upload of {2} rows for Site data and {3} rows for UN data. <br><br> The [Instructions] tab within the workbook provides guidance as to what data needs to be provided. If need be, you may consider splitting the file into two Bulk files, each under the limits, and two Bulk submissions. [B1006] ",
              "Fr-Message": "Ce classeur contient {0} lignes de données de site et {1} lignes de données UN pour ces sites. Cela dépasse les limites acceptables pour le téléchargement groupé de {2} lignes pour les données de site et de {3} lignes pour les données de l'ONU.<br><br>L'onglet [Instructions] du classeur fournit des indications sur les données à fournir. Si besoin est, vous pouvez envisager de diviser le fichier en deux fichiers groupés, chacun sous les limites, et deux soumissions groupées. [B1006]"
            },
            {
              "code": "B1007",
              "Eng-Message": "There are already {0} rows of Site data and {1} rows of UN data for those sites on file for this Company, so no further uploads can continue. [B1007]",
              "Fr-Message": "Il existe déjà {0} lignes de données de site et {1} lignes de données de l'ONU pour ces sites dans le dossier de cette entreprise. Aucun autre téléchargement ne peut donc continuer. [B1007]"
            },
            {
              "code": "B1035",
              "Eng-Message": "Detail Site data has already been assigned manually, or via a previous Bulk Upload. If you proceed, then any Site referenced in the workbook that is already in CID, will first be completed deleted from CID, with no possibility to recover the related data. Those Site(s) will then be re-created based on the workbook values here. <br><br>Are you sure you want to continue with this upload and potentially override existing Site data? [B1035] ",
              "Fr-Message": "Les données détaillées du site ont déjà été attribuées manuellement ou via un précédent chargement en bloc. Si vous continuez, tout site référencé dans le classeur qui est déjà dans CID sera d'abord complètement supprimé de CID, sans possibilité de récupérer les données associées. Ces sites seront ensuite recréés en fonction des valeurs du classeur ici. <br><br>Voulez-vous vraiment continuer avec ce téléchargement et éventuellement remplacer les données existantes du site ?[B1035] "
            },
            {
              "code": "B1008",
              "Eng-Message": "Missing required field: Province. [B1008]",
              "Fr-Message": "Champ obligatoire manquant : Province. [B1008]"
            },
            {
              "code": "B1009",
              "Eng-Message": "Missing required field: Postal Code. [B1009]",
              "Fr-Message": "Champ obligatoire manquant : Code postal. [B1009]"
            },
            {
              "code": "B1010",
              "Eng-Message": "Missing required field:Address 1. [B1010]",
              "Fr-Message": "Champ obligatoire manquant :Adresse 1. [B1010]"
            },
            {
              "code": "B1011",
              "Eng-Message": "Address already exist. [B1011]",
              "Fr-Message": "L'adresse existe déjà pour l'entreprise par. [B1011]"
            },
            {
              "code": "B1012",
              "Eng-Message": "City name is not correct. [B1012]",
              "Fr-Message": "Le nom de la ville n'est pas correct. [B1012]"
            },
            {
              "code": "B1013",
              "Eng-Message": "City doesn't belong to Province. [B1013]",
              "Fr-Message": "La ville n'appartient pas à la province. [B1013]"
            },
            {
              "code": "B1014",
              "Eng-Message": "Missing required field:1B. Quarter / LSD. [B1014]",
              "Fr-Message": "Champ obligatoire manquant : 1B. Trimestre / LSD. [B1014]"
            },
            {
              "code": "B1015",
              "Eng-Message": "Missing required field:1B. Section. [B1015]",
              "Fr-Message": "Champ obligatoire manquant : 1B. Section. [B1015]"
            },
            {
              "code": "B1016",
              "Eng-Message": "Missing required field:1B. Township. [B1016]",
              "Fr-Message": "Champ obligatoire manquant : 1B. Canton. [B1016]"
            },
            {
              "code": "B1017",
              "Eng-Message": "Missing required field:1B. Range. [B1017]",
              "Fr-Message": "Champ obligatoire manquant : 1B. Varier. [B1017]"
            },
            {
              "code": "B1018",
              "Eng-Message": "Missing required field:1B. Meridian. [B1018]",
              "Fr-Message": "Champ obligatoire manquant : 1B. Méridien. [B1018]"
            },
            {
              "code": "B1019",
              "Eng-Message": "Legal Land description already exists. [B1019]",
              "Fr-Message": "La description légale du terrain existe déjà. [B1019]"
            },
            {
              "code": "B1020",
              "Eng-Message": "Missing required field: 1C. Latitude. [B1020]",
              "Fr-Message": "Champ obligatoire manquant : 1C. Latitude. [B1020]"
            },
            {
              "code": "B1021",
              "Eng-Message": "Missing required field: 1C. Longtitude. [B1021]",
              "Fr-Message": "Champ obligatoire manquant : 1C. Longitude. [B1021]"
            },
            {
              "code": "B1022",
              "Eng-Message": "Latitude and Longtitude alerady exists for the company. [B1022]",
              "Fr-Message": "La latitude et la longitude existent déjà pour l'entreprise. [B1022]"
            },
            {
              "code": "B1023",
              "Eng-Message": "At least one mode of transportation Need to be selected. [B1023]",
              "Fr-Message": "Au moins un mode de transport Doit être sélectionné. [B1023]"
            },
            {
              "code": "B1024",
              "Eng-Message": "At least one Class need to be added. [B1024]",
              "Fr-Message": "Au moins une classe doit être ajoutée. [B1024]"
            },
            {
              "code": "B1025",
              "Eng-Message": "Incorrect class. [B1025]",
              "Fr-Message": "Classe incorrecte. [B1025]"
            },
            {
              "code": "B1026",
              "Eng-Message": "Extended Site information in not specified. [B1026]",
              "Fr-Message": "Les informations étendues sur le site ne sont pas spécifiées. [B1026]"
            },
            {
              "code": "B1027",
              "Eng-Message": "Site must have at least one HOTI activities. [B1027]",
              "Fr-Message": "Le site doit avoir au moins une activité HOTI. [B1027]"
            },
            {
              "code": "B1028",
              "Eng-Message": "Extednded site must have at Least  on UNNumber Need to be specified. [B1028]",
              "Fr-Message": "Le site étendu doit avoir au moins un numéro UN Doit être spécifié. [B1028]"
            },
            {
              "code": "B1029",
              "Eng-Message": "Missing required field: City. [B1029]",
              "Fr-Message": "Champ obligatoire manquant : Ville. [B1029]"
            },
            {
              "code": "B1030",
              "Eng-Message": "Missing Annual Quantity/Volume. [B1030]",
              "Fr-Message": "Quantité/Volume annuel manquant. [B1030]"
            },
            {
              "code": "B1031",
              "Eng-Message": "Missing Unit of measurement. [B1031]",
              "Fr-Message": "Unité de mesure manquante. [B1031]"
            },
            {
              "code": "B1032",
              "Eng-Message": "Missing Annual # of  Consignments. [B1032]",
              "Fr-Message": "Nombre annuel manquant d'envois. [B1032]"
            },
            {
              "code": "B1033",
              "Eng-Message": "Site belong to another company. Please go through cliaming process. [B1033]",
              "Fr-Message": "Le site appartient à une autre société. Veuillez passer par le processus de réclamation. [B1033]"
            },
            {
              "code": "B1034",
              "Eng-Message": "Once site address is established it cannot be changed.[B1034]",
              "Fr-Message": "Une fois l'adresse du site établie, elle ne peut plus être modifiée.[B1034]"
            },
            {
              "code": "B1036",
              "Eng-Message": "<p>First of two sets of validations of the file being uploaded is now complete.The workbook contains {0} rows of Site data and {1}  rows of UN # data related to those Sites that are ready to be added, or updated, within CID for your Company. <br><br>Do you want continue with the Bulk Upload process? <br><br> </P><ul><li>{0} Sites from the Add Basic sheet.</li><li>{1} UN # rows from the Add Extended sheet.</li></ul> [B1036]",
              "Fr-Message": "<p>La première des deux séries de validations du fichier en cours de téléchargement est maintenant terminée.Le classeur contient {0} lignes de données de site et {1} lignes de données de numéro UN relatives aux sites qui sont prêts à être ajoutés ou mis à jour dans le CID de votre entreprise. <br><br>Souhaitez-vous poursuivre le processus de transfert groupé ? <br><br> </P><ul><li>{0} Sites de la feuille Ajouter de base.</li><li>{1} UN # lignes de la feuille Add Extended.</li></ul> [B1036]"
            },
            {
              "code": "B1037",
              "Eng-Message": "The CID system will now begin the second of two sets of validations of the file being uploaded. An email will be sent to your email address of {0} (as set via your user profile), indicating the results the second set of validations and the subsequent steps to take.<br> <br> At this point you can wait for the notification email and proceed with the next step described from within it. Alternatively, you can leave the Registration process temporarily and the system will return you to the spot where you left off when you return. [B1037]",
              "Fr-Message": "Le système CID va maintenant commencer la deuxième des deux séries de validations du fichier en cours de téléchargement. Un e-mail sera envoyé à votre adresse e-mail de {0} (telle que définie via votre profil d'utilisateur), indiquant les résultats de la deuxième série de validations et les étapes ultérieures à suivre.<br> <br> À ce stade, vous pouvez attendre l'e-mail de notification et passer à l'étape suivante décrite à partir de celui-ci. Alternativement, vous pouvez quitter temporairement le processus d'inscription et le système vous ramènera à l'endroit où vous vous étiez arrêté à votre retour. [B1037]"
            }
          ]
        },
        "Parse_Messages_to_JSON": {
          "runAfter": {
            "Messaages": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "c7167db6-5d1d-4c49-8959-e8ed51425a00"
          },
          "type": "ParseJson",
          "inputs": {
            "content": "@outputs('Messaages')",
            "schema": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "code": {
                    "type": "string"
                  },
                  "Eng-Message": {
                    "type": "string"
                  },
                  "Fr-Message": {
                    "type": "string"
                  }
                },
                "required": [
                  "code",
                  "Eng-Message",
                  "Fr-Message"
                ]
              }
            }
          }
        },
        "Get_Bulk_Activity_log_Summaries-initial": {
          "runAfter": {
            "Parse_Messages_to_JSON": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "0abf4f66-6dea-4942-a637-83047b3c2026"
          },
          "type": "OpenApiConnection",
          "inputs": {
            "host": {
              "connectionName": "shared_commondataserviceforapps_1",
              "operationId": "GetItem",
              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
            },
            "parameters": {
              "entityName": "cid_bulkactivitylogsummaries",
              "recordId": "@triggerBody()?['activityid']"
            },
            "authentication": "@parameters('$authentication')"
          }
        },
        "ContactID": {
          "runAfter": {
            "Get_Bulk_Activity_log_Summaries-initial": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "813962c6-0382-4d8d-9cce-ca742bb0c054"
          },
          "type": "Compose",
          "inputs": "@outputs('Get_Bulk_Activity_log_Summaries-initial')?['body/_cid_actionedby_value']"
        },
        "Get_Contact": {
          "runAfter": {
            "ContactID": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "ac6e8559-1d7b-4fc6-9bee-9f42336cb467"
          },
          "type": "OpenApiConnection",
          "inputs": {
            "host": {
              "connectionName": "shared_commondataserviceforapps",
              "operationId": "GetItem",
              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"
            },
            "parameters": {
              "entityName": "contacts",
              "recordId": "@outputs('ContactID')"
            },
            "authentication": "@parameters('$authentication')"
          }
        },
        "Initialize_variable_-_Activity_type": {
          "runAfter": {
            "Bulk_Activity_start_time": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "43c9ef86-4039-4c10-90b0-9aad7a106d5b"
          },
          "type": "InitializeVariable",
          "inputs": {
            "variables": [
              {
                "name": "ActivityType",
                "type": "integer"
              }
            ]
          }
        },
        "Check_Activity_Type": {
          "actions": {},
          "runAfter": {
            "check_attachement": [
              "Succeeded"
            ]
          },
          "expression": {
            "greater": [
              "@length(triggerBody()?['ActivityType'])",
              0
            ]
          },
          "metadata": {
            "operationMetadataId": "ebe18e27-10ef-4939-b53e-f2209c83753f"
          },
          "type": "If"
        }
      },
      "outputs": {}
    }
  },
  "schemaVersion": "1.0.0.0"
}