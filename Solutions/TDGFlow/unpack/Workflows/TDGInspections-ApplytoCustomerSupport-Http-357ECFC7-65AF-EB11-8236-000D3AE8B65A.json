{"properties":{"connectionReferences":{"shared_commondataserviceforapps_1":{"runtimeSource":"embedded","connection":{},"api":{"name":"shared_commondataserviceforapps"}},"shared_teams_1":{"runtimeSource":"embedded","connection":{},"api":{"name":"shared_teams"}},"shared_office365":{"runtimeSource":"embedded","connection":{},"api":{"name":"shared_office365"}}},"definition":{"$schema":"https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#","contentVersion":"1.0.0.0","parameters":{"$connections":{"defaultValue":{},"type":"Object"},"$authentication":{"defaultValue":{},"type":"SecureObject"}},"triggers":{"manual":{"type":"Request","kind":"Http","inputs":{"schema":{"type":"object","properties":{"userId":{"type":"string"},"message":{"type":"string"},"isBugOrFeature":{"type":"string"},"isStop":{"type":"string"}}},"method":"POST"}}},"actions":{"User_Id":{"runAfter":{},"type":"InitializeVariable","inputs":{"variables":[{"name":"UserId","type":"string","value":"@triggerBody()?['userId']"}]}},"CS_Message":{"runAfter":{"User_Id":["Succeeded"]},"type":"InitializeVariable","inputs":{"variables":[{"name":"CSmessage","type":"string","value":"@triggerBody()?['message']"}]}},"Response":{"runAfter":{"Process_Support_Team":["Succeeded"]},"type":"Response","kind":"Http","inputs":{"statusCode":200,"headers":{"ContentType":"text/plain"},"body":"Your request was successfully submitted to: @{join(variables(' SupportTeam'),',')}"}},"Get_Sender":{"runAfter":{"Current_user_id":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps_1","operationId":"GetItem","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"systemusers","recordId":"@variables('UserId')","$select":"fullname,lastname,firstname,internalemailaddress,systemuserid,domainname"},"authentication":"@parameters('$authentication')"}},"Get_Customer_Support_team":{"runAfter":{"Get_Sender":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps_1","operationId":"ListRecords","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"qm_environmentsettingses","$filter":"(qm_name eq 'CustomerSupportTeam')","$top":1},"authentication":"@parameters('$authentication')"}},"SupportTeam":{"runAfter":{"Is_bug_or_feature":["Succeeded"]},"type":"InitializeVariable","inputs":{"variables":[{"name":" SupportTeam","type":"array"}]}},"Current_user_id":{"runAfter":{"SupportTeam":["Succeeded"]},"type":"InitializeVariable","inputs":{"variables":[{"name":"currentUserId","type":"string"}]}},"Process_Support_Team":{"foreach":"@outputs('Get_Customer_Support_team')?['body/value']","actions":{"Set_support_team_list":{"runAfter":{},"type":"SetVariable","inputs":{"name":" SupportTeam","value":"@split(items('Process_Support_Team')?['qm_value'],';')"}},"Send_Message":{"foreach":"@variables(' SupportTeam')","actions":{"Get_TO's":{"runAfter":{},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps_1","operationId":"ListRecords","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"systemusers","$select":"fullname,lastname,firstname,internalemailaddress,systemuserid,domainname","$filter":"(domainname eq '@{items('Send_Message')}')","$top":1},"authentication":"@parameters('$authentication')"}},"Get_To_ID":{"foreach":"@outputs('Get_TO''s')?['body/value']","actions":{"Set_current_addressee_id":{"runAfter":{},"type":"SetVariable","inputs":{"name":"currentUserId","value":"@items('Get_To_ID')?['systemuserid']"}},"Create_an_email":{"runAfter":{"Set_current_addressee_id":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps_1","operationId":"CreateRecord","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"emails","item/activitypointer_activity_parties":[{"participationtypemask":1,"partyid@odata.bind":"/systemusers(@{variables('UserId')})"},{"participationtypemask":2,"partyid@odata.bind":"/systemusers(@{variables('currentUserId')})"}],"item/description":"<p>Hi</p><p>@{variables('CSmessage')}</p>","item/subject":"Customer Support request from @{outputs('Get_Sender')?['body/fullname']}"},"authentication":"@parameters('$authentication')"}}},"runAfter":{"Get_TO's":["Succeeded"]},"type":"Foreach"},"Post_a_message_as_the_Flow_bot_to_a_user":{"runAfter":{"Get_To_ID":["Succeeded","Failed","Skipped","TimedOut"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_teams_1","operationId":"PostUserNotification","apiId":"/providers/Microsoft.PowerApps/apis/shared_teams"},"parameters":{"PostNotificationRequest/recipient/to":"@{items('Send_Message')};","PostNotificationRequest/messageBody":"Hello,\nI have found an issue using ROM.\nThe steps to reproduce the issue are as follows:\n@{variables('CSmessage')}\n\nIs this issue preventing you from completing an inspection?\n@{variables('isStopping')}\n\nIs this bug or just a feature that would be nice to have in the system?\n@{variables('isBugOrFeature')}","PostNotificationRequest/messageTitle":"Customer Support request from @{outputs('Get_Sender')?['body/fullname']}","PostNotificationRequest/recipient/isAlert":true},"authentication":"@parameters('$authentication')"}}},"runAfter":{"Set_support_team_list":["Succeeded"]},"type":"Foreach"},"Send_an_email_(V2)":{"runAfter":{"Send_Message":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_office365","operationId":"SendEmailV2","apiId":"/providers/Microsoft.PowerApps/apis/shared_office365"},"parameters":{"emailMessage/To":" TDGOversight-SurveillanceTMD@tc.gc.ca;@{outputs('Get_Sender')?['body/domainname']}","emailMessage/Subject":"Customer Support request from @{outputs('Get_Sender')?['body/fullname']}","emailMessage/Body":"<p>Hello,<br>\nI have found an issue using ROM.<br>\nThe steps to reproduce the issue are as follows:<br>\n@{variables('CSmessage')}<br>\n<br>\nIs this issue preventing you from completing an inspection?<br>\n@{variables('isStopping')}<br>\n<br>\nIs this bug or just a feature that would be nice to have in the system?<br>\n@{variables('isBugOrFeature')}</p>","emailMessage/Cc":"@items('Process_Support_Team')?['qm_value']"},"authentication":"@parameters('$authentication')"}}},"runAfter":{"Get_Customer_Support_team":["Succeeded"]},"type":"Foreach"},"Is_Stopping_issue":{"runAfter":{"CS_Message":["Succeeded"]},"type":"InitializeVariable","inputs":{"variables":[{"name":"isStopping","type":"string","value":"@triggerBody()?['isStop']"}]}},"Is_bug_or_feature":{"runAfter":{"Is_Stopping_issue":["Succeeded"]},"type":"InitializeVariable","inputs":{"variables":[{"name":"isBugOrFeature","type":"string","value":"@triggerBody()?['isBugOrFeature']"}]}}},"outputs":{}}},"schemaVersion":"1.0.0.0"}