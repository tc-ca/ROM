{"properties":{"connectionReferences":{"shared_commondataserviceforapps_1":{"runtimeSource":"embedded","connection":{},"api":{"name":"shared_commondataserviceforapps"}},"shared_wordonlinebusiness_1":{"runtimeSource":"embedded","connection":{},"api":{"name":"shared_wordonlinebusiness"}},"shared_sharepointonline_1":{"runtimeSource":"embedded","connection":{},"api":{"name":"shared_sharepointonline"}},"shared_azureblob":{"runtimeSource":"embedded","connection":{},"api":{"name":"shared_azureblob"}}},"definition":{"$schema":"https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#","contentVersion":"1.0.0.0","parameters":{"$connections":{"defaultValue":{},"type":"Object"},"$authentication":{"defaultValue":{},"type":"SecureObject"}},"triggers":{"When_a_row_is_added,_modified_or_deleted":{"type":"OpenApiConnectionWebhook","inputs":{"host":{"connectionName":"shared_commondataserviceforapps_1","operationId":"SubscribeWebhookTrigger","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"subscriptionRequest/message":4,"subscriptionRequest/entityname":"ovs_cyaction","subscriptionRequest/scope":4,"subscriptionRequest/runas":1},"authentication":"@parameters('$authentication')"},"conditions":[{"expression":"@and(equals(triggerBody()?['statuscode'],2),equals(triggerBody()?['ovs_actiontype'],918640004))"}]}},"actions":{"Is_work_order":{"actions":{"Get_Site_and_Primary_Contact":{"runAfter":{"Set_Blob_Path":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps_1","operationId":"GetItem","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"accounts","recordId":"@outputs('Get_a_WO._All_fields')?['body/_msdyn_serviceaccount_value']","$select":"name,emailaddress1,accountid,address1_composite, address1_city,address1_stateorprovince,address1_line1,address1_postalcode,address1_country,ovs_legalname","$expand":"primarycontactid($select=jobtitle,fullname,emailaddress1,telephone1)"},"authentication":"@parameters('$authentication')"}},"Get_The_Single_Booking":{"runAfter":{"Get_Primary_Inspector":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps_1","operationId":"ListRecords","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"bookableresourcebookings","$select":"starttime","$filter":"(_msdyn_workorder_value eq @{outputs('Get_a_WO._All_fields')?['body/msdyn_workorderid']})","$orderby":"starttime desc","$top":1},"authentication":"@parameters('$authentication')"}},"Apply_StartTime_if_any":{"foreach":"@outputs('Get_The_Single_Booking')?['body/value']","actions":{"Set_StartTime_EN":{"runAfter":{},"type":"SetVariable","inputs":{"name":"bookingStartTimeEN","value":"@{formatDateTime(items('Apply_StartTime_if_any')?['starttime'], 'd MMMM yyyy')}"}},"Set_StartTime_FR":{"runAfter":{"Set_temp_month_FR":["Succeeded"]},"type":"SetVariable","inputs":{"name":"bookingStartTimeFR","value":"@{replace(formatDateTime(items('Apply_StartTime_if_any')?['starttime'], 'd MMMM yyyy'),variables('tempStartTimeEN'),variables('tempStartTimeFR'))}"}},"Set_month_name_EN":{"runAfter":{"Set_Parsed_array":["Succeeded"]},"type":"SetVariable","inputs":{"name":"tempStartTimeEN","value":"@{variables('enDateArray')[1]}"}},"Parse_JSON":{"runAfter":{"Set_month_name_EN":["Succeeded"]},"type":"ParseJson","inputs":{"content":"@variables('Month2FR')","schema":{"type":"array","items":{"type":"object","properties":{"Key":{"type":"string"},"Value":{"type":"string"}},"required":["Key","Value"]}}}},"Set_temp_month_FR":{"runAfter":{"Filter_array":["Succeeded"]},"type":"SetVariable","inputs":{"name":"tempStartTimeFR","value":"@{first(body('Filter_array'))?['Value']}"}},"Filter_array":{"runAfter":{"Parse_JSON":["Succeeded"]},"type":"Query","inputs":{"from":"@body('Parse_JSON')","where":"@equals(item()['Key'], variables('tempStartTimeEN'))"}},"Compose":{"runAfter":{"Set_StartTime_EN":["Succeeded"]},"type":"Compose","inputs":"@split(variables('bookingStartTimeEN'),' ')"},"Set_Parsed_array":{"runAfter":{"Compose":["Succeeded"]},"type":"SetVariable","inputs":{"name":"enDateArray","value":"@outputs('Compose')"}}},"runAfter":{"Get_The_Single_Booking":["Succeeded"]},"type":"Foreach"},"Get_Primary_Inspector":{"runAfter":{"Get_Site_and_Primary_Contact":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps_1","operationId":"GetItem","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"bookableresources","recordId":"@outputs('Get_a_WO._All_fields')?['body/_ovs_primaryinspector_value']","$select":"name,msdyn_primaryemail,bookableresourceid,ovs_badgenumber,ovs_registeredinspectornumberrin","$expand":"UserId($select=lastname,firstname,systemuserid,fullname)"},"authentication":"@parameters('$authentication')"}},"Convert_Word_Document_to_PDF":{"runAfter":{"Location_Condition":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_wordonlinebusiness_1","operationId":"GetFilePDF","apiId":"/providers/Microsoft.PowerApps/apis/shared_wordonlinebusiness"},"parameters":{"source":"sites/034gc.sharepoint.com,140da73b-4423-4443-a812-e623d6d857c4,f2a2589e-2eec-4642-9280-443640f88211","drive":"b!O6cNFCNEQ0SoEuYj1thXxJ5YovLsLkJGkoBENkD4ghHOwr7dpePzS7BlI7DR0NOV","file":"/Reports@{variables('SPfolderPath')}/@{variables('fileNameSP')}"},"authentication":"@parameters('$authentication')"}},"Set_Blob_Path":{"runAfter":{"Get_a_WO._All_fields":["Succeeded"]},"type":"SetVariable","inputs":{"name":"filePathBlob","value":"@{outputs('Get_a_WO._All_fields')?['body/msdyn_name']}_@{variables('RegardingId')}/@{triggerOutputs()?['body/ovs_actionnumber']}-Notice of Infraction-@{variables('filePostfix')}.pdf"}},"Create_new_folder_in_SP":{"runAfter":{},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_sharepointonline_1","operationId":"CreateNewFolder","apiId":"/providers/Microsoft.PowerApps/apis/shared_sharepointonline"},"parameters":{"dataset":"https://034gc.sharepoint.com/sites/SamuraiTeam","table":"ddbec2ce-e3a5-4bf3-b065-23b0d1d0d395","parameters/path":"/Reports@{variables('SPfolderPath')}"},"authentication":"@parameters('$authentication')"}},"Get_a_WO._All_fields":{"runAfter":{"Create_new_folder_in_SP":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps_1","operationId":"GetItem","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"msdyn_workorders","recordId":"@triggerOutputs()?['body/_regardingobjectid_value']"},"authentication":"@parameters('$authentication')"}},"Delete_folder":{"runAfter":{"Create_PDF_file_blob":["Succeeded","Failed","TimedOut","Skipped"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_sharepointonline_1","operationId":"DeleteItem","apiId":"/providers/Microsoft.PowerApps/apis/shared_sharepointonline"},"parameters":{"dataset":"https://034gc.sharepoint.com/sites/SamuraiTeam","table":"Documents","id":"@outputs('Create_new_folder_in_SP')?['body/ID']"},"authentication":"@parameters('$authentication')"}},"Create_PDF_file_blob":{"runAfter":{"Add_Annotation_file":["Failed","TimedOut"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_azureblob","operationId":"CreateFile","apiId":"/providers/Microsoft.PowerApps/apis/shared_azureblob"},"parameters":{"folderPath":"/msdynworkorder","name":"@variables('filePathBlob')","body":"@outputs('Convert_Word_Document_to_PDF')?['body']","Content-Type":"application/pdf"},"authentication":"@parameters('$authentication')"},"runtimeConfiguration":{"contentTransfer":{"transferMode":"Chunked"}}},"Location_Condition":{"actions":{"Populate_a_Microsoft_Word_template_NoLocation":{"runAfter":{},"metadata":{"01QZYBJ7EI4EVTAFWFBBCKOFJGD2UZSUL4":"/Inspection Report Templates/Notice of Infraction V1.docx","01QZYBJ7EXZMAJWIBB65GKEVRXXXWJRD6M":"/Inspection Report Templates/Notice of Infraction V2.docx","01QZYBJ7FS5BS2ZXI4Q5FKQNLW76O7M3BR":"/Inspection Report Templates/Notice of Infraction V3.docx","01QZYBJ7H5I5AAAZTYL5CIQLY3BWOHQ75D":"/Inspection Report Templates/Notice of Infraction V4.docx","01QZYBJ7G6OZE52WS6ANEL4ZAZL657V7BS":"/Inspection Report Templates/Notice of Infraction V5.docx","01QZYBJ7AAYYFN24MQCFEZYTXUHDTAPYPX":"/Inspection Report Templates/Notice of Infraction V6.docx","01QZYBJ7FQTOZSDPCK6FGYYXGJQWGJABKB":"/Inspection Report Templates/Notice of Infraction V7.docx","01QZYBJ7A7SZ66P4JGF5FILIWZKATITRQT":"/Inspection Report Templates/Notice of Infraction Revised.docx","01QZYBJ7AZ7TMKEOGF3ZDILKX73QITEQPJ":"/Inspection Report Templates/Notice of Infraction Revised Location.docx","01QZYBJ7FHBU6Q6XX3AJGIXW7VJYVAQQI5":"/Inspection Report Templates/Notice of Infraction Revised NoLocation.docx"},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_wordonlinebusiness_1","operationId":"CreateFileItem","apiId":"/providers/Microsoft.PowerApps/apis/shared_wordonlinebusiness"},"parameters":{"source":"sites/034gc.sharepoint.com,140da73b-4423-4443-a812-e623d6d857c4,f2a2589e-2eec-4642-9280-443640f88211","drive":"b!O6cNFCNEQ0SoEuYj1thXxJ5YovLsLkJGkoBENkD4ghHOwr7dpePzS7BlI7DR0NOV","file":"01QZYBJ7FHBU6Q6XX3AJGIXW7VJYVAQQI5","dynamicFileSchema/382301797":"@{outputs('Get_Site_and_Primary_Contact')?['body/address1_line1']}, @{outputs('Get_Site_and_Primary_Contact')?['body/address1_city']}, @{outputs('Get_Site_and_Primary_Contact')?['body/address1_stateorprovince']}, @{outputs('Get_Site_and_Primary_Contact')?['body/address1_postalcode']}","dynamicFileSchema/465325485":"@outputs('Get_Primary_Inspector')?['body/userid/fullname']","dynamicFileSchema/1018354222":"@outputs('Get_Primary_Inspector')?['body/ovs_registeredinspectornumberrin']","dynamicFileSchema/1098905991":"@outputs('Get_Site_and_Primary_Contact')?['body/primarycontactid/fullname']","dynamicFileSchema/1285996689":"@outputs('Get_Site_and_Primary_Contact')?['body/ovs_legalname']","dynamicFileSchema/1301888070":"@triggerOutputs()?['body/ovs_actiondate']","dynamicFileSchema/1539550161":"@outputs('Get_Site_and_Primary_Contact')?['body/ovs_legalname']","dynamicFileSchema/1592131855":"@variables('bookingStartTimeEN')","dynamicFileSchema/2034456519":"@triggerOutputs()?['body/ovs_noncompliancedetailstxt']","dynamicFileSchema/-565412095":"@outputs('Get_a_WO._All_fields')?['body/msdyn_name']","dynamicFileSchema/-1975126":"@variables('bookingStartTimeFR')","dynamicFileSchema/-2089449557":"@outputs('Get_Primary_Inspector')?['body/ovs_badgenumber']"},"authentication":"@parameters('$authentication')"}},"Create_file_in_SP_No_Location":{"runAfter":{"Populate_a_Microsoft_Word_template_NoLocation":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_sharepointonline_1","operationId":"CreateFile","apiId":"/providers/Microsoft.PowerApps/apis/shared_sharepointonline"},"parameters":{"dataset":"https://034gc.sharepoint.com/sites/SamuraiTeam","folderPath":"@outputs('Create_new_folder_in_SP')?['body/{FullPath}']","name":"@variables('fileNameSP')","body":"@outputs('Populate_a_Microsoft_Word_template_NoLocation')?['body']"},"authentication":"@parameters('$authentication')"},"runtimeConfiguration":{"contentTransfer":{"transferMode":"Chunked"}}}},"runAfter":{"Apply_StartTime_if_any":["Succeeded"]},"else":{"actions":{"Populate_a_Microsoft_Word_template_Location":{"runAfter":{},"metadata":{"01QZYBJ7EI4EVTAFWFBBCKOFJGD2UZSUL4":"/Inspection Report Templates/Notice of Infraction V1.docx","01QZYBJ7EXZMAJWIBB65GKEVRXXXWJRD6M":"/Inspection Report Templates/Notice of Infraction V2.docx","01QZYBJ7FS5BS2ZXI4Q5FKQNLW76O7M3BR":"/Inspection Report Templates/Notice of Infraction V3.docx","01QZYBJ7H5I5AAAZTYL5CIQLY3BWOHQ75D":"/Inspection Report Templates/Notice of Infraction V4.docx","01QZYBJ7G6OZE52WS6ANEL4ZAZL657V7BS":"/Inspection Report Templates/Notice of Infraction V5.docx","01QZYBJ7AAYYFN24MQCFEZYTXUHDTAPYPX":"/Inspection Report Templates/Notice of Infraction V6.docx","01QZYBJ7FQTOZSDPCK6FGYYXGJQWGJABKB":"/Inspection Report Templates/Notice of Infraction V7.docx","01QZYBJ7A7SZ66P4JGF5FILIWZKATITRQT":"/Inspection Report Templates/Notice of Infraction Revised.docx","01QZYBJ7AZ7TMKEOGF3ZDILKX73QITEQPJ":"/Inspection Report Templates/Notice of Infraction Revised Location.docx"},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_wordonlinebusiness_1","operationId":"CreateFileItem","apiId":"/providers/Microsoft.PowerApps/apis/shared_wordonlinebusiness"},"parameters":{"source":"sites/034gc.sharepoint.com,140da73b-4423-4443-a812-e623d6d857c4,f2a2589e-2eec-4642-9280-443640f88211","drive":"b!O6cNFCNEQ0SoEuYj1thXxJ5YovLsLkJGkoBENkD4ghHOwr7dpePzS7BlI7DR0NOV","file":"01QZYBJ7AZ7TMKEOGF3ZDILKX73QITEQPJ","dynamicFileSchema/382301797":"@{outputs('Get_Site_and_Primary_Contact')?['body/address1_line1']}, @{outputs('Get_Site_and_Primary_Contact')?['body/address1_city']}, @{outputs('Get_Site_and_Primary_Contact')?['body/address1_stateorprovince']}, @{outputs('Get_Site_and_Primary_Contact')?['body/address1_postalcode']}","dynamicFileSchema/465325485":"@outputs('Get_Primary_Inspector')?['body/userid/fullname']","dynamicFileSchema/1018354222":"@outputs('Get_Primary_Inspector')?['body/ovs_registeredinspectornumberrin']","dynamicFileSchema/1098905991":"@outputs('Get_Site_and_Primary_Contact')?['body/primarycontactid/fullname']","dynamicFileSchema/1285996689":"@outputs('Get_Site_and_Primary_Contact')?['body/ovs_legalname']","dynamicFileSchema/1301888070":"@triggerOutputs()?['body/ovs_actiondate']","dynamicFileSchema/1539550161":"@outputs('Get_Site_and_Primary_Contact')?['body/ovs_legalname']","dynamicFileSchema/1592131855":"@variables('bookingStartTimeEN')","dynamicFileSchema/2034456519":"@triggerOutputs()?['body/ovs_noncompliancedetailstxt']","dynamicFileSchema/-565412095":"@outputs('Get_a_WO._All_fields')?['body/msdyn_name']","dynamicFileSchema/-106351805":"@{outputs('Get_a_WO._All_fields')?['body/msdyn_address1']}, @{outputs('Get_a_WO._All_fields')?['body/msdyn_city']}, @{outputs('Get_a_WO._All_fields')?['body/msdyn_stateorprovince']}. @{outputs('Get_a_WO._All_fields')?['body/msdyn_postalcode']}","dynamicFileSchema/-1975126":"@variables('bookingStartTimeFR')","dynamicFileSchema/-2089449557":"@outputs('Get_Primary_Inspector')?['body/ovs_badgenumber']"},"authentication":"@parameters('$authentication')"}},"Create_file_in_SP_With_Location":{"runAfter":{"Populate_a_Microsoft_Word_template_Location":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_sharepointonline_1","operationId":"CreateFile","apiId":"/providers/Microsoft.PowerApps/apis/shared_sharepointonline"},"parameters":{"dataset":"https://034gc.sharepoint.com/sites/SamuraiTeam","folderPath":"@outputs('Create_new_folder_in_SP')?['body/{FullPath}']","name":"@variables('fileNameSP')","body":"@outputs('Populate_a_Microsoft_Word_template_Location')?['body']"},"authentication":"@parameters('$authentication')"},"runtimeConfiguration":{"contentTransfer":{"transferMode":"Chunked"}}}}},"expression":{"and":[{"equals":["@outputs('Get_Site_and_Primary_Contact')?['body/address1_line1']","@outputs('Get_a_WO._All_fields')?['body/msdyn_address1']"]},{"equals":["@outputs('Get_Site_and_Primary_Contact')?['body/address1_city']","@outputs('Get_a_WO._All_fields')?['body/msdyn_city']"]},{"equals":["@outputs('Get_Site_and_Primary_Contact')?['body/address1_postalcode']","@outputs('Get_a_WO._All_fields')?['body/msdyn_postalcode']"]},{"equals":["@outputs('Get_Site_and_Primary_Contact')?['body/address1_stateorprovince']","@outputs('Get_a_WO._All_fields')?['body/msdyn_stateorprovince']"]}]},"type":"If"},"Add_Annotation_file":{"runAfter":{"Convert_Word_Document_to_PDF":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps_1","operationId":"CreateRecord","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"annotations","item/subject":"Work order @{outputs('Get_a_WO._All_fields')?['body/msdyn_name']} - Notice of Infraction","item/isdocument":true,"item/documentbody":"@base64(outputs('Convert_Word_Document_to_PDF')?['body'])","item/filename":"@{triggerOutputs()?['body/ovs_actionnumber']}- Notice of Infraction-@{variables('filePostfix')}.pdf","item/objectid_msdyn_workorder@odata.bind":"/msdyn_workorders/@{outputs('Get_a_WO._All_fields')?['body/msdyn_workorderid']}"},"authentication":"@parameters('$authentication')"}}},"runAfter":{"File_Name_Postfix":["Succeeded"]},"expression":{"equals":["@variables('RegardingType')","msdyn_workorders"]},"type":"If"},"Clean_WO_guid":{"runAfter":{"Month2French":["Succeeded"]},"type":"InitializeVariable","inputs":{"variables":[{"name":"RegardingId","type":"string","value":"@toUpper(replace(triggerOutputs()?['body/_regardingobjectid_value'], '-', ''))"}]}},"Regarding_Type":{"runAfter":{"Clean_WO_guid":["Succeeded"]},"type":"InitializeVariable","inputs":{"variables":[{"name":"RegardingType","type":"string","value":"@{triggerOutputs()?['body/_regardingobjectid_type']}"}]}},"SP_Folder_Path":{"runAfter":{"Regarding_Type":["Succeeded"]},"type":"InitializeVariable","inputs":{"variables":[{"name":"SPfolderPath","type":"string","value":"/@{variables('RegardingId')}"}]}},"File_Name_SharePoint":{"runAfter":{"SP_Folder_Path":["Succeeded"]},"type":"InitializeVariable","inputs":{"variables":[{"name":"fileNameSP","type":"string","value":"@{triggerOutputs()?['body/ovs_actionnumber']}-Notice of Infraction.docx"}]}},"Booking_StartTime_EN":{"runAfter":{"File_Path_Blob":["Succeeded"]},"type":"InitializeVariable","inputs":{"variables":[{"name":"bookingStartTimeEN","type":"string"}]}},"File_Path_Blob":{"runAfter":{"File_Name_SharePoint":["Succeeded"]},"type":"InitializeVariable","inputs":{"variables":[{"name":"filePathBlob","type":"string"}]}},"Booking_StartTime_FR":{"runAfter":{"Booking_StartTime_EN":["Succeeded"]},"type":"InitializeVariable","inputs":{"variables":[{"name":"bookingStartTimeFR","type":"string"}]}},"Month2French":{"runAfter":{},"type":"InitializeVariable","inputs":{"variables":[{"name":"Month2FR","type":"array","value":[{"Key":"January","Value":"Janvier"},{"Key":"February","Value":"Février"},{"Key":"March","Value":"Mars"},{"Key":"April","Value":"Avril"},{"Key":"May","Value":"May"},{"Key":"June","Value":"Juin"},{"Key":"July","Value":"Juillet"},{"Key":"August","Value":"Août"},{"Key":"September","Value":"Septembre"},{"Key":"October","Value":"Octobre"},{"Key":"November","Value":"Novembre"},{"Key":"December","Value":"Décembre"}]}]}},"Temp_StartTime_FR":{"runAfter":{"Temp_StartTime_EN":["Succeeded"]},"type":"InitializeVariable","inputs":{"variables":[{"name":"tempStartTimeFR","type":"string"}]}},"Temp_StartTime_EN":{"runAfter":{"Booking_StartTime_FR":["Succeeded"]},"type":"InitializeVariable","inputs":{"variables":[{"name":"tempStartTimeEN","type":"string"}]}},"Date_parse_array_EN":{"runAfter":{"Temp_StartTime_FR":["Succeeded"]},"type":"InitializeVariable","inputs":{"variables":[{"name":"enDateArray","type":"array"}]}},"File_Name_Postfix":{"runAfter":{"Date_parse_array_EN":["Succeeded"]},"type":"InitializeVariable","inputs":{"variables":[{"name":"filePostfix","type":"string","value":"@formatDateTime(utcNow(), 'ddMMyyyyhhmmfff')"}]}}},"outputs":{}}},"schemaVersion":"1.0.0.0"}