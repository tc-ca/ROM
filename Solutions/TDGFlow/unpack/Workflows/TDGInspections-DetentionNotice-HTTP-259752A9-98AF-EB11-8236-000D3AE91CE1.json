{"properties":{"connectionReferences":{"shared_sharepointonline_1":{"runtimeSource":"embedded","connection":{},"api":{"name":"shared_sharepointonline"}},"shared_wordonlinebusiness_1":{"runtimeSource":"embedded","connection":{},"api":{"name":"shared_wordonlinebusiness"}},"shared_commondataserviceforapps_2":{"runtimeSource":"embedded","connection":{},"api":{"name":"shared_commondataserviceforapps"}},"shared_commondataserviceforapps":{"runtimeSource":"embedded","connection":{},"api":{"name":"shared_commondataserviceforapps"}}},"definition":{"$schema":"https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#","contentVersion":"1.0.0.0","parameters":{"$connections":{"defaultValue":{},"type":"Object"},"$authentication":{"defaultValue":{},"type":"SecureObject"},"dynamicscrmonline.organizationName":{"defaultValue":"","type":"String"},"dynamicscrmonline.entityName":{"defaultValue":"","type":"String"},"Detention Notice EN":{"defaultValue":"-DN-AR-","type":"String","metadata":{"schemaName":"ovs_DetentionNoticeEN","description":"Report middle name"}}},"triggers":{"When_a_row_is_added,_modified_or_deleted":{"type":"OpenApiConnectionWebhook","inputs":{"host":{"connectionName":"shared_commondataserviceforapps","operationId":"SubscribeWebhookTrigger","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"subscriptionRequest/message":4,"subscriptionRequest/entityname":"ovs_cyaction","subscriptionRequest/scope":4,"subscriptionRequest/filteringattributes":"statecode,statuscode"},"authentication":"@parameters('$authentication')"},"conditions":[{"expression":"@equals(triggerOutputs()?['body/ovs_actiontype'],918640000)"}]}},"actions":{"Create_file":{"runAfter":{"Populate_a_Microsoft_Word_template":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_sharepointonline_1","operationId":"CreateFile","apiId":"/providers/Microsoft.PowerApps/apis/shared_sharepointonline"},"parameters":{"dataset":"https://034gc.sharepoint.com/sites/SamuraiTeam","folderPath":"/Shared Documents/Inspection Report Templates/Temp","name":"@{variables('FileName')}.docx","body":"@base64(outputs('Populate_a_Microsoft_Word_template')?['body'])"},"authentication":"@parameters('$authentication')"},"runtimeConfiguration":{"contentTransfer":{"transferMode":"Chunked"}}},"Convert_Word_Document_to_PDF":{"runAfter":{"Create_file":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_wordonlinebusiness_1","operationId":"GetFilePDF","apiId":"/providers/Microsoft.PowerApps/apis/shared_wordonlinebusiness"},"parameters":{"source":"sites/034gc.sharepoint.com,140da73b-4423-4443-a812-e623d6d857c4,f2a2589e-2eec-4642-9280-443640f88211","drive":"b!O6cNFCNEQ0SoEuYj1thXxJ5YovLsLkJGkoBENkD4ghHOwr7dpePzS7BlI7DR0NOV","file":"/Inspection Report Templates/Temp/@{outputs('Create_file')?['body/Name']}"},"authentication":"@parameters('$authentication')"}},"Delete_file":{"runAfter":{"Create_Note_on_Work_Order":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_sharepointonline_1","operationId":"DeleteFile","apiId":"/providers/Microsoft.PowerApps/apis/shared_sharepointonline"},"parameters":{"dataset":"https://034gc.sharepoint.com/sites/SamuraiTeam","id":"@outputs('Create_file')?['body/Id']"},"authentication":"@parameters('$authentication')"}},"Populate_a_Microsoft_Word_template":{"runAfter":{"Apply_to_each":["Succeeded"]},"metadata":{"01QZYBJ7D7WBS5TYFRDBFJATRQHL6XCCML":"/Inspection Report Templates/SA_NOTICE_OF_DIRECTION.docx","01QZYBJ7DTQ2GUAAHEAJAITVFVVFDUTBGI":"/Inspection Report Templates/SA_NOTICE_OF_DIRECTION.docx","01QZYBJ7GFZLBSXRBVQNBKOGXWPX5RXECQ":"/Inspection Report Templates/SA_NOTICE_OF_DIRECTION.docx","01QZYBJ7F4ZXWRC5UCRBDIFFIY2UL4GH62":"/Inspection Report Templates/SA_NOTICE_OF_DIRECTION.docx","01QZYBJ7ERBOETFHDABRDZ2B7MGMOC6OSB":"/Inspection Report Templates/SA_NOTICE_OF_DIRECTION.docx","01QZYBJ7BNM2HRCH43WVHISSOI37TPHJG6":"/Inspection Report Templates/SA_NOTICE_OF_DIRECTION_REVISED.docx","01QZYBJ7AMT6MSU77QJNAKORWDTITVOW3R":"/Inspection Report Templates/SA_DETENTION_NOTICE_REVISED.docx","01QZYBJ7BOYKG6WQYZWZG2LHKZMN4MBPVC":"/Inspection Report Templates/DETENTION_NOTICE___AVIS_DE_RÉTENTION.docx","01QZYBJ7GB7IHVDORA7RGJA25ZLEDLORX7":"/Inspection Report Templates/DETENTION_NOTICE___AVIS_DE_RÉTENTION_adjusted.docx","01QZYBJ7DA2HXRNA7ILJEKDASD5FLRWGIC":"/Inspection Report Templates/DETENTION_NOTICE___AVIS_DE_RÉTENTION.docx"},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_wordonlinebusiness_1","operationId":"CreateFileItem","apiId":"/providers/Microsoft.PowerApps/apis/shared_wordonlinebusiness"},"parameters":{"source":"sites/034gc.sharepoint.com,140da73b-4423-4443-a812-e623d6d857c4,f2a2589e-2eec-4642-9280-443640f88211","drive":"b!O6cNFCNEQ0SoEuYj1thXxJ5YovLsLkJGkoBENkD4ghHOwr7dpePzS7BlI7DR0NOV","file":"01QZYBJ7DA2HXRNA7ILJEKDASD5FLRWGIC","dynamicFileSchema/106326818":"@variables('IsHOTI')","dynamicFileSchema/690186090":"@variables('closingInspectorBadge')","dynamicFileSchema/1109314837":"@outputs('Get_Work_Order_Details')?['body/msdyn_name']","dynamicFileSchema/1134297212":"@{outputs('Get_Inspector_Details')?['body/firstname']} @{outputs('Get_Inspector_Details')?['body/lastname']}","dynamicFileSchema/1171604637":"@outputs('Get_Inspector_Details')?['body/address1_fax']","dynamicFileSchema/1172687087":"@variables('IsMoC')","dynamicFileSchema/1227957053":" @{variables('closingInspectorName')}","dynamicFileSchema/1471556191":"@triggerOutputs()?['body/ovs_dgdescription']","dynamicFileSchema/1566602880":"@body('Get_Inspector_Details')?['systemuser_bookableresource_UserId'][0]['ovs_registeredinspectornumberrin']","dynamicFileSchema/1573465195":"@{outputs('Get_Work_Order_Details')?['body/msdyn_city']}, @{outputs('Get_Work_Order_Details')?['body/msdyn_stateorprovince']}","dynamicFileSchema/1575320369":"@body('Get_Inspector_Details')?['systemuser_bookableresource_UserId'][0]['ovs_badgenumber']","dynamicFileSchema/1895389775":"@outputs('Get_Primary_Contact_For_Account')?['body/primarycontactid/fullname']","dynamicFileSchema/2103988479":"@outputs('Get_Primary_Contact_For_Account')?['body/primarycontactid/mobilephone']","dynamicFileSchema/-2028243656":"@triggerOutputs()?['body/ovs_actionnumber']","dynamicFileSchema/-852727465":"@variables('IsHOTI')","dynamicFileSchema/-1780937642":"@variables('IsMoC')","dynamicFileSchema/-1395809158":"@outputs('Get_Primary_Contact_For_Account')?['body/ovs_legalname']","dynamicFileSchema/-745960806":"@{outputs('Get_Primary_Contact_For_Account')?['body/address1_line1']} @{outputs('Get_Primary_Contact_For_Account')?['body/address1_city']} @{outputs('Get_Primary_Contact_For_Account')?['body/address1_stateorprovince']} @{outputs('Get_Primary_Contact_For_Account')?['body/address1_postalcode']}","dynamicFileSchema/-117922535":"@outputs('Get_Primary_Contact_For_Account')?['body/primarycontactid/jobtitle']","dynamicFileSchema/-183747007":"@outputs('Get_Primary_Contact_For_Account')?['body/primarycontactid/telephone1']","dynamicFileSchema/-1755352695":"@outputs('Get_Primary_Contact_For_Account')?['body/primarycontactid/fax']","dynamicFileSchema/-1713186279":"@outputs('Get_Primary_Contact_For_Account')?['body/primarycontactid/emailaddress1']","dynamicFileSchema/-761756268":"@outputs('Get_Inspector_Details')?['body/title']","dynamicFileSchema/-41761194":"@{outputs('Get_Inspector_Details')?['body/address1_line1']} @{outputs('Get_Inspector_Details')?['body/address1_city']} @{outputs('Get_Inspector_Details')?['body/address1_stateorprovince']} @{outputs('Get_Inspector_Details')?['body/address1_postalcode']}","dynamicFileSchema/-848561687":"@outputs('Get_Inspector_Details')?['body/internalemailaddress']","dynamicFileSchema/-935824125":"@outputs('Get_Inspector_Details')?['body/address1_telephone1']","dynamicFileSchema/-1742393533":"@formatDateTime(triggerOutputs()?['body/ovs_actiondate'],'dd-MMM-yyyy')","dynamicFileSchema/-1569882268":"@triggerOutputs()?['body/ovs_mocdescription']","dynamicFileSchema/-59253584":"@triggerOutputs()?['body/ovs_noncompliancedetailstxt']","dynamicFileSchema/-43916254":"@variables('closingInspectorRINN')","dynamicFileSchema/-2069260909":"@variables('ReleaseDate')"},"authentication":"@parameters('$authentication')"}},"Get_Inspector_Details":{"runAfter":{"Get_Primary_Contact_For_Account":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps_2","operationId":"GetItem","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"systemusers","recordId":"@outputs('Get_Work_Order_Details')?['body/_ownerid_value']","$select":"firstname,lastname,internalemailaddress,address1_line1,address2_telephone1,address1_telephone1,address1_postalcode,address1_fax,title,address1_city,address1_postalcode,address1_stateorprovince","$expand":"systemuser_bookableresource_UserId($select=ovs_registeredinspectornumberrin,ovs_badgenumber)"},"authentication":"@parameters('$authentication')"}},"Create_Note_on_Work_Order":{"runAfter":{"Convert_Word_Document_to_PDF":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps_2","operationId":"CreateRecord","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"annotations","item/subject":"Detention Notice","item/isdocument":true,"item/documentbody":"@base64(outputs('Convert_Word_Document_to_PDF')?['body'])","item/filename":"@{variables('FileName')}.pdf","item/mimetype":"application/pdf","item/objectid_msdyn_workorder@odata.bind":"/msdyn_workorders/@{outputs('Get_Work_Order_Details')?['body/msdyn_workorderid']}"},"authentication":"@parameters('$authentication')"}},"Get_Work_Order_Details":{"runAfter":{"If_Status_is_Active":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps","operationId":"GetItem","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"msdyn_workorders","recordId":"@triggerOutputs()?['body/_regardingobjectid_value']"},"authentication":"@parameters('$authentication')"}},"Get_List_of_Violations":{"runAfter":{"Get_Inspector_Details":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps_2","operationId":"ListRecords","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"qm_syresults","$select":"qm_violationcount,qm_externalcomments","$filter":"_qm_workorderid_value eq '@{outputs('Get_Work_Order_Details')?['body/msdyn_workorderid']}'","$expand":"qm_rclegislationId($select=qm_name)"},"authentication":"@parameters('$authentication')"}},"Apply_to_each":{"foreach":"@outputs('Get_List_of_Violations')?['body/value']","actions":{"Append_to_array_variable":{"runAfter":{},"type":"AppendToArrayVariable","inputs":{"name":"ViolationsArray","value":{"ViolationName":"@items('Apply_to_each')?['qm_rclegislationid/qm_name']","ViolationCount":"@items('Apply_to_each')?['qm_violationcount']","ExternalComment":"@items('Apply_to_each')?['qm_externalcomments']"}}}},"runAfter":{"Get_List_of_Violations":["Succeeded"]},"type":"Foreach"},"Init_-_Violations_Array":{"runAfter":{"Continue_If_Status_Is_Active_Or_Closed":["Succeeded"]},"type":"InitializeVariable","inputs":{"variables":[{"name":"ViolationsArray","type":"array"}]}},"If_Status_is_Active":{"actions":{"Set_variable_4":{"runAfter":{},"type":"SetVariable","inputs":{"name":"DescriptionOfDangerousGoods","value":"@triggerOutputs()?['body/ovs_dgdescription']"}},"If_HOTI_Is_True":{"actions":{"Set_variable_2":{"runAfter":{},"type":"SetVariable","inputs":{"name":"IsHOTI","value":"X"}}},"runAfter":{"Set_variable_4":["Succeeded"]},"expression":{"equals":["@triggerOutputs()?['body/ovs_reasonhoti']",true]},"type":"If"},"If_MOC_Is_True":{"actions":{"Set_variable_3":{"runAfter":{},"type":"SetVariable","inputs":{"name":"IsMoC","value":"X"}}},"runAfter":{"If_HOTI_Is_True":["Succeeded"]},"expression":{"equals":["@triggerOutputs()?['body/ovs_reasonmoc']",true]},"type":"If"}},"runAfter":{"Get_Closing_Inspector_Details":["Succeeded"]},"else":{"actions":{"If_Status_Reason_is_Confirmation_Received_On_Time":{"actions":{"Set_variable":{"runAfter":{},"type":"SetVariable","inputs":{"name":"DescriptionOfMeansOfContainment","value":"@triggerOutputs()?['body/ovs_mocdescription']"}},"Set_variable_5":{"runAfter":{"Set_variable":["Succeeded"]},"type":"SetVariable","inputs":{"name":"DescriptionOfDangerousGoods","value":"@triggerOutputs()?['body/ovs_dgdescription']"}},"If_HOTI_Is_True_2":{"actions":{"Set_variable_6":{"runAfter":{},"type":"SetVariable","inputs":{"name":"IsHOTI","value":"X"}}},"runAfter":{"Set_Release_Date":["Succeeded"]},"expression":{"equals":["@triggerOutputs()?['body/ovs_reasonhoti']",true]},"type":"If"},"If_MOC_Is_True_2":{"actions":{"Set_variable_7":{"runAfter":{},"type":"SetVariable","inputs":{"name":"IsMoC","value":"X"}}},"runAfter":{"If_HOTI_Is_True_2":["Succeeded"]},"expression":{"equals":["@triggerOutputs()?['body/ovs_reasonmoc']",true]},"type":"If"},"Set_Release_Date":{"runAfter":{"Set_variable_5":["Succeeded"]},"type":"SetVariable","inputs":{"name":"ReleaseDate","value":"@triggerOutputs()?['body/ovs_releasedate']"}},"Set_Closing_Inspector_Name":{"runAfter":{"If_MOC_Is_True_2":["Succeeded"]},"type":"SetVariable","inputs":{"name":"closingInspectorName","value":" @{outputs('Get_Closing_Inspector_Details')?['body/firstname']} @{outputs('Get_Closing_Inspector_Details')?['body/lastname']}"}},"Set_Closing_Inspector_Badge":{"runAfter":{"Set_Closing_Inspector_Name":["Succeeded"]},"type":"SetVariable","inputs":{"name":"closingInspectorBadge","value":"@{body('Get_Closing_Inspector_Details')?['systemuser_bookableresource_UserId'][0]['ovs_badgenumber']}"}},"Set_Closing_Inspector_RINN":{"runAfter":{"Set_Closing_Inspector_Badge":["Succeeded"]},"type":"SetVariable","inputs":{"name":"closingInspectorRINN","value":"@{body('Get_Closing_Inspector_Details')?['systemuser_bookableresource_UserId'][0]['ovs_registeredinspectornumberrin']}"}},"Set_Closing_Inspector_Title":{"runAfter":{"Set_Closing_Inspector_RINN":["Succeeded"]},"type":"SetVariable","inputs":{"name":"closingInspectorTitle","value":"@outputs('Get_Closing_Inspector_Details')?['body/title']"}}},"runAfter":{},"else":{"actions":{"Terminate":{"runAfter":{},"type":"Terminate","inputs":{"runStatus":"Cancelled"}}}},"expression":{"and":[{"equals":["@triggerOutputs()?['body/statuscode']",918640000]},{"equals":["@triggerOutputs()?['body/statuscode']",918640001]}]},"type":"If"}}},"expression":{"equals":["@triggerOutputs()?['body/statuscode']",4]},"type":"If"},"Init_-_Revocation_Text":{"runAfter":{"Init_-_Violations_Array":["Succeeded"]},"type":"InitializeVariable","inputs":{"variables":[{"name":"DescriptionOfDangerousGoods","type":"string"}]}},"Init_-_Direction_Text":{"runAfter":{"Init_-_Revocation_Text":["Succeeded"]},"type":"InitializeVariable","inputs":{"variables":[{"name":"DescriptionOfMeansOfContainment","type":"string"}]}},"Init_-_IsHOTI":{"runAfter":{"Init_-_Direction_Text":["Succeeded"]},"type":"InitializeVariable","inputs":{"variables":[{"name":"IsHOTI","type":"string","value":"__"}]}},"Init_-_IsMoC":{"runAfter":{"Init_-_IsHOTI":["Succeeded"]},"type":"InitializeVariable","inputs":{"variables":[{"name":"IsMoC","type":"string","value":"__"}]}},"Init_-_File_Name":{"runAfter":{"Init_-_IsMoC":["Succeeded"]},"type":"InitializeVariable","inputs":{"variables":[{"name":"FileName","type":"string","value":"@{triggerOutputs()?['body/ovs_actionnumber']}@{parameters('Detention Notice EN')}@{formatDateTime(utcNow(),'ddMMyyyyhhmmfff')}"}]}},"Continue_If_Status_Is_Active_Or_Closed":{"actions":{},"runAfter":{},"else":{"actions":{"Terminate_2":{"runAfter":{},"type":"Terminate","inputs":{"runStatus":"Cancelled"}}}},"expression":{"or":[{"equals":["@triggerOutputs()?['body/statuscode']",4]},{"equals":["@triggerOutputs()?['body/statuscode']",918640000]},{"equals":["@triggerOutputs()?['body/statuscode']",918640001]}]},"type":"If"},"Get_Primary_Contact_For_Account":{"runAfter":{"Get_Work_Order_Details":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps_2","operationId":"GetItem","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"accounts","recordId":"@outputs('Get_Work_Order_Details')?['body/_msdyn_serviceaccount_value']","$select":"name,emailaddress1,accountid,address1_line1,address1_city,address1_postalcode,ovs_legalname,address1_stateorprovince","$expand":"primarycontactid($select=jobtitle,fullname,emailaddress1,telephone1,mobilephone,fax)"},"authentication":"@parameters('$authentication')"}},"Init_-_Release_Date":{"runAfter":{"Init_-_File_Name":["Succeeded"]},"type":"InitializeVariable","inputs":{"variables":[{"name":"ReleaseDate","type":"string"}]}},"Init_-_closingInspectorName":{"runAfter":{"Init_-_Release_Date":["Succeeded"]},"type":"InitializeVariable","inputs":{"variables":[{"name":"closingInspectorName","type":"string"}]}},"Init_-_closingInspectorBadge":{"runAfter":{"Init_-_closingInspectorName":["Succeeded"]},"type":"InitializeVariable","inputs":{"variables":[{"name":"closingInspectorBadge","type":"string"}]}},"Init_-_closingInspectorTitle":{"runAfter":{"Init_-_closingInspectorBadge":["Succeeded"]},"type":"InitializeVariable","inputs":{"variables":[{"name":"closingInspectorTitle","type":"string"}]}},"Init_-_closingInspectorRINN":{"runAfter":{"Init_-_closingInspectorTitle":["Succeeded"]},"type":"InitializeVariable","inputs":{"variables":[{"name":"closingInspectorRINN","type":"string"}]}},"Get_Closing_Inspector_Details":{"runAfter":{"Init_-_closingInspectorRINN":["Succeeded"]},"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_commondataserviceforapps_2","operationId":"GetItem","apiId":"/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps"},"parameters":{"entityName":"systemusers","recordId":"@triggerOutputs()?['body/_modifiedby_value']","$select":"firstname,lastname,internalemailaddress,address1_composite,address2_telephone1,address1_telephone1,address1_postalcode,address1_fax,title","$expand":"systemuser_bookableresource_UserId($select=ovs_registeredinspectornumberrin,ovs_badgenumber)"},"authentication":"@parameters('$authentication')"}}}}},"schemaVersion":"1.0.0.0"}