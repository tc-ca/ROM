 <style>
    #processingMsg {
        width: 300px;
        text-align: center;
        padding: 6px 10px;
        z-index: 9999;
        top: 15%;
        left: 40%;
        position: fixed;
        -webkit-border-radius: 0 0 2px 2px;
        border-radius: 0 0 2px 2px;
        -webkit-box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      display:none;
    }
  
</style>
{% assign parentid = user.parentcustomerid.id %}
{% fetchxml environment_settings %}
<fetch version="1.0" output-format="xml-platform" mapping="logical" distinct="false">
  <entity name="qm_environmentsettings">
    <attribute name="qm_environmentsettingsid" />
    <attribute name="qm_name" />
    <attribute name="createdon" />
    <attribute name="qm_value" />
    <order attribute="qm_name" descending="false" />
    <filter type="and">
      <condition attribute="qm_name" operator="like" value="%CID[_]%" />
    </filter>
  </entity>
</fetch>
{% endfetchxml %}
{% for env_setting in environment_settings.results.entities %}
{% if {{env_setting.qm_name}}  == 'CID_Upload_Excel_Flow' %}
{% assign excelload_Flow_URL = env_setting.qm_value %}
{% endif %}
{% if {{env_setting.qm_name}}  == 'CID_Bulk_Upload' %}
{% assign Bulk_flow_URL = env_setting.qm_value %}
{% endif %}

{% if {{env_setting.qm_name}}  == 'CID_Download_Template_Flow' %}
{% assign download_flow_URL = env_setting.qm_value %}
{% endif %}


{% endfor %}

<script>
  $(document).ready(function() {

$("div.actions").append("<input type='button' id='btn_attachfile_and_scan' name='btn_attachfile_and_scan' value='Scan and Upload' class='submit-btn btn btn-primary form-action-container-left' />");
    $(window).load(function() {

  $("#InsertButton").css("display", "none");
   
//InsertButton
    //  $('#ll').hide();
        //  notificationMsg.show("System is downloading site info ...");
           
    });
   // var pageURL = window.location.href;

$('#btn_attachfile_and_scan').click(function(e) 
{
    $("#mainContent").before("<div class='validation' style='color:black;margin-bottom: 20px;'>File is sent for scaning</div>");
    var DocumentbodyContents;
  // Get the name of the selected file
    var FileName = $('#AttachFile')[0].files[0].name;

    // Get the mime type of the selected file

    var MimeType = $('#AttachFile')[0].files[0].type;
  

    // Get the content of the selected file

    var file = document.getElementById('AttachFile').files[0];
  
  if (file) {
   
 $('#processingMsg').css('display','block');
$('#processingMsg').text("File is sent for scanning please wait");
            // Read the file

            var reader = new FileReader();

            reader.readAsDataURL(file);

            // The browser has finished reading the file, we can now do something with it...

            reader.onload = function (e) {

                // The browser has finished reading the file, we can now do something with it...

                 DocumentbodyContents = e.target.result;

                // Split the string at the first comma (removing the base64 prefix)

                DocumentbodyContents = DocumentbodyContents.substring(DocumentbodyContents.indexOf(',') + 1);


var Scan_API_URL ="https://prod-02.canadacentral.logic.azure.com:443/workflows/9c5deab59bdb45739dc659748c59b1a1/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=ZDI2-YxUhNZkKvpXe7R7Cs_y8J5gGtcB6ZT-y5EAMok";
//var c = String.raw `X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*`;


Call_Virsu_Scan_API(Scan_API_URL ,DocumentbodyContents);

//,btoa(c));
             


            };


        }
        else
        {

            $("#AttachFile").after("<div class='validation' style='color:red;margin-bottom: 20px;'>Please select file</div>");
$('#processingMsg').css('display','block');
$('#processingMsg').text("Please Select File First");

        }



//btoa(c) );

/*var xhr = new XMLHttpRequest();
xhr.withCredentials = true;

xhr.addEventListener("readystatechange", function() {
  if(this.readyState === 4) {
   alert ("done");
   alert(this.status);
   //xhr.setHeader("Access-Control-Allow-Origin", "*");

   // console.log(this.responseText);
   // alert(this.responseText);
  }
  alert(FileName);
xhr.open("POST", "https://wwwapps.tc.gc.ca/Saf-Sec-Sur/13/MTAPI/api/v1/file-scan-status?filename=" + "FileName",true);
xhr.setRequestHeader("access-Control-Allow-Origin", "*");
xhr.setRequestHeader("Content-Type", "application/octet-stream");
xhr.setRequestHeader("Access-Control-Allow-Credentials", "true");
xhr.setRequestHeader("Access-Control-Allow-Methods", "GET,HEAD,OPTIONS,POST,PUT");
xhr.setRequestHeader("Access-Control-Allow-Headers", "Access-Control-Allow-Headers, Origin,Accept, X-Requested-With, Content-Type, Access-Control-Request-Method, Access-Control-Request-Headers");


//xhr.setRequestHeader("Cookie", "_mtoa_session=ef57638bc41c4615ba2eb0721bfa9ab7");

xhr.send("AAAA");
 */
});

//alert(DocumentbodyContents);
//e.preventDefault();


//var DownloadURL = "~/RD_Sites_Template.xlsm";
    //var linktemplate = document.getElementById("linkdownload");
    //linktemplate.href = DownloadURL;
    //linktemplate.download = "RD_Sites_Template.xlsx";
    $('#linkdownload').on('click', async function() {
          $('#processingMsg').css('display','block');
        $('#processingMsg').text('System is downloading site info ...');
        
     // notificationMsg.show("System is downloading site info ...");
     
     // $('#ll').show();
      var companyid = '{{parentid}}';

    
      var acupdate =
        '{ "accountid": "' + companyid + '" }';
    
   
      var req = new XMLHttpRequest();
    
      var url = '{{download_flow_URL}}';
      console.log(url);
      //"https://prod-17.canadacentral.logic.azure.com:443/workflows/900f6e70915a4cddbb65b3c79da14581/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=LZveFQ8DXIDobQOPzgoc0LgOcSOPpqVcnCEicN1lvEQ";
      req.open("POST", url, true);
      req.setRequestHeader('Content-Type', 'application/json');
      req.onreadystatechange = function() {
        if (this.readyState === 4) {
          req.onreadystatechange = null;
          if (this.status === 200) {
               $('#processingMsg').text("Download complete");
            var result = this.response;
           // $('#ll').hide();
            //https://rd-tdgcore-dev.powerappsportals.com/_entity/annotation/
            var fileattachementURL = "~/_entity/annotation/" + result;
            window.location.replace(fileattachementURL);
             $("#processingMsg").css("display", "none");
            $("#processingMsg").hide();
          } else {
              $('#processingMsg').text("Download was not completed due to system issue, please contact system support");
            var result = this.response;
            alert("Error " + result);
          }
        }
      }
      req.send(acupdate);
    });

});//end document ready

    

  

   // Notification component
    var notificationMsg = (function () {
        var $processingMsgEl = $('#processingMsg'),
            _msg = 'Processing...',
            _stack = 0,
            _endTimeout;
        return {
            show: function (msg) {
             
                $processingMsgEl.text(msg || _msg);
                if (_stack === 0) {
                    clearTimeout(_endTimeout);
                    $processingMsgEl.show();
                }
                _stack++;
            },
            hide: function () {
                _stack--;
                if (_stack <= 0) {
                    _stack = 0;
                    clearTimeout(_endTimeout);
                    _endTimeout = setTimeout(function () {
                        $processingMsgEl.hide();
                    }, 500);
                }
            }
        }
    })();


function Call_Virsu_Scan_API(url, fileContent)
{
  
  var acupdate =
       '{"FileContent" :"' + fileContent  + '" }';

         // '{ "accountid": "' + companyid + '" }';
      var req = new XMLHttpRequest();
    
     
      console.log(url);
      //"https://prod-17.canadacentral.logic.azure.com:443/workflows/900f6e70915a4cddbb65b3c79da14581/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=LZveFQ8DXIDobQOPzgoc0LgOcSOPpqVcnCEicN1lvEQ";
      req.open("POST", url, true);
      req.setRequestHeader('Content-Type', 'application/json');
      req.onreadystatechange = function() {
        if (this.readyState === 4) {
          req.onreadystatechange = null;
          if (this.status === 200) {
               $('#processingMsg').text(this.response);
               alert (this.response);
            var result = this.response;
         if (result.toLowerCase().trim() == "false")
         {
              $("#InsertButton").click();

         }
         else
         {
             alert("File did not pass scanning");
         }
           
             $("#processingMsg").css("display", "none");
            $("#processingMsg").hide();
          } else {
              $('#processingMsg').text("Error Please Try again Later.");
            var result = this.response;
            alert("Error " + result);
          }
        }
      }
     
      req.send(acupdate);
}

</script>
<div class="container">
    <div class="container">
        {% block breadcrumbs %}
        {% include 'Breadcrumbs' %}
        {% endblock %}
        {% block title %}
        {% include 'Page Header' %} 
        {% endblock %}
    </div>

    <div id="mainContent" class="row">
      
        <div class="col-md-12">
            {% block main %}
          
   {% include 'Page Copy' %}  

           
      


  {% endblock %}

        
        </div>
    </div>
</div>