
<style>
    #processingMsg {
        width: 300px;
        text-align: center;
        padding: 6px 10px;
        z-index: 9999;
        top: 15%;
        left: 40%;
        position: fixed;
        -webkit-border-radius: 0 0 2px 2px;
        border-radius: 0 0 2px 2px;
        -webkit-box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
</style>
{% assign parentid = user.parentcustomerid.id %}
{% assign contactid = user.id %}
{% assign languagecode = website.selected_language.code %}
{% fetchxml environment_settings %}
<fetch version="1.0" output-format="xml-platform" mapping="logical" distinct="false">
    <entity name="qm_environmentsettings">
        <attribute name="qm_environmentsettingsid" />
        <attribute name="qm_name" />
        <attribute name="createdon" />
        <attribute name="qm_value" />
        <order attribute="qm_name" descending="false" />
        <filter type="and">
            <condition attribute="qm_name" operator="like" value="%CID[_]%" />
        </filter>
    </entity>
</fetch>
{% endfetchxml %}
{% for env_setting in environment_settings.results.entities %}
{% if {{env_setting.qm_name}}  == 'CID_Upload_Excel_Flow' %}
{% assign excelload_Flow_URL = env_setting.qm_value %}
{% endif %}
{% if {{env_setting.qm_name}}  == 'CID_Bulk_Upload' %}
{% assign Bulk_flow_URL = env_setting.qm_value %}
{% endif %}

{% if {{env_setting.qm_name}}  == 'CID_Download_Template_Flow' %}
{% assign download_flow_URL = env_setting.qm_value %}
{% endif %}

{% if {{env_setting.qm_name}}  == 'CID_Flow_FileScan' %}
{% assign Scan_flow_URL = env_setting.qm_value %}
{% endif %}


{% endfor %}

<script>
  $(document).ready( function() {

      //add new submit button
      $("div.actions").append("<input type='button' id='btn_attachfile_and_scan' name='btn_attachfile_and_scan' value='Upload' class='submit-btn btn btn-primary form-action-container-left' />");
      $("#InsertButton").css("display", "none");
    var langcode = '{{languagecode}}'  ;
    
      call_Inital_validation(langcode);
   

    $(window).load(function() {
    //call_Inital_validation();
    });
   // var pageURL = window.location.href;

$('#btn_attachfile_and_scan').click(function(e)
{
    if (document.getElementById('AttachFile').files.length == 0)
   {
       // call the submit button to show error message
    $("#InsertButton").click();
   }
   else
   {
   // $("#mainContent").before("<div class='validation' style='color:black;margin-bottom: 20px;'>File is sent for scaning</div>");
    var DocumentbodyContents;
  // Get the name of the selected file
    var FileName = $('#AttachFile')[0].files[0].name;

    // Get the mime type of the selected file
    var MimeType = $('#AttachFile')[0].files[0].type;

    // Get the content of the selected file
    var file = document.getElementById('AttachFile').files[0];



    if (MimeType != "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet")
   {
      
 // call the submit button to show error message
    $("#InsertButton").click();
   }

  else if (file) {

        $('#processingMsg').css('display', 'block');
        $('#processingMsg').text("Workbook is being scanned….");
        // Read the file

        var reader = new FileReader();

        reader.readAsDataURL(file);

        // The browser has finished reading the file, we can now do something with it...

        reader.onload = function (e) {

            // The browser has finished reading the file, we can now do something with it...

            DocumentbodyContents = e.target.result;

            // Split the string at the first comma (removing the base64 prefix)

            DocumentbodyContents = DocumentbodyContents.substring(DocumentbodyContents.indexOf(',') + 1);


            var Scan_API_URL = '{{Scan_flow_URL}}';
           

          Call_Virsu_Scan_API(Scan_API_URL
            // ,btoa(c));
            ,DocumentbodyContents , '100000001',FileName,langcode );


        // call_Metadefender_Api();


          

        }//end loader
    }///end if file
   }// end check file length


           // $("#AttachFile").after("<div class='validation' style='color:red;margin-bottom: 20px;'>Please select file</div>");
           //$('#processingMsg').css('display','block');
           //$('#processingMsg').text("Please Select File First");


//btoa(c) );
});


    $('#linkdownload_English').on('click', async function() {

          $('#processingMsg').css('display','block');
        $('#processingMsg').text('The custom Site Bulk Upload Excel workbook is being downloaded …');

     // notificationMsg.show("System is downloading site info ...");

     // $('#ll').show();
      var companyid = '{{parentid}}';


      var flowparamaters =
        '{ "accountid": "' + companyid + '",'  + '"Language": "English" }';


      var req = new XMLHttpRequest();

      var url = '{{download_flow_URL}}';
      console.log(url);
      
      req.open("POST", url, true);
      req.setRequestHeader('Content-Type', 'application/json');
      req.onreadystatechange = function() {
        if (this.readyState === 4) {
          req.onreadystatechange = null;
          if (this.status === 200) {
               $('#processingMsg').text("Download complete");
            var result = this.response;
           // $('#ll').hide();
            //https://rd-tdgcore-dev.powerappsportals.com/_entity/annotation/
            var fileattachementURL = "~/_entity/annotation/" + result;
            window.location.replace(fileattachementURL);
             $("#processingMsg").css("display", "none");
            $("#processingMsg").hide();
          } else {
              $('#processingMsg').text("Download was not completed due to system issue, please contact system support");
            var result = this.response;
            alert("Error " + result);
          }
        }
      }
      req.send(flowparamaters);
    });


 $('#linkdownload_French').on('click', async function() {

          $('#processingMsg').css('display','block');
        $('#processingMsg').text('System is downloading site info ...');

     // notificationMsg.show("System is downloading site info ...");

     // $('#ll').show();
      var companyid = '{{parentid}}';


      var flowparamaters =
        '{ "accountid": "' + companyid + '",'  + '"Language": "French" }';


      var req = new XMLHttpRequest();

      var url = '{{download_flow_URL}}';
      console.log(url);
      //"https://prod-17.canadacentral.logic.azure.com:443/workflows/900f6e70915a4cddbb65b3c79da14581/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=LZveFQ8DXIDobQOPzgoc0LgOcSOPpqVcnCEicN1lvEQ";
      req.open("POST", url, true);
      req.setRequestHeader('Content-Type', 'application/json');
      req.onreadystatechange = function() {
        if (this.readyState === 4) {
          req.onreadystatechange = null;
          if (this.status === 200) {
               $('#processingMsg').text("Download complete");
            var result = this.response;
           // $('#ll').hide();
            //https://rd-tdgcore-dev.powerappsportals.com/_entity/annotation/
            var fileattachementURL = "~/_entity/annotation/" + result;
            window.location.replace(fileattachementURL);
             $("#processingMsg").css("display", "none");
            $("#processingMsg").hide();
          } else {
              $('#processingMsg').text("Download was not completed due to system issue, please contact system support");
            var result = this.response;
            alert("Error " + result);
          }
        }
      }
      req.send(flowparamaters);
    });



});//end document ready





   // Notification component
    var notificationMsg = (function () {
        var $processingMsgEl = $('#processingMsg'),
            _msg = 'Processing...',
            _stack = 0,
            _endTimeout;
        return {
            show: function (msg) {

                $processingMsgEl.text(msg || _msg);
                if (_stack === 0) {
                    clearTimeout(_endTimeout);
                    $processingMsgEl.show();
                }
                _stack++;
            },
            hide: function () {
                _stack--;
                if (_stack <= 0) {
                    _stack = 0;
                    clearTimeout(_endTimeout);
                    _endTimeout = setTimeout(function () {
                        $processingMsgEl.hide();
                    }, 500);
                }
            }
        }
    })();


function Call_Virsu_Scan_API(url, fileContent, activitytype , excelfilename , language)
{

var companyid = '{{parentid}}';
var contactid = '{{contactid}}'
      $('#processingMsg').css('display', 'block');
        $('#processingMsg').text("Workbook is being scanned….");

  var acupdate =
        '{"FileContent" :"' + fileContent  + '", "CompanyId" : "' + companyid + '" , "ActionedBy" :"' + contactid +  '", "ActivityType" : "'+ activitytype +'" ,"ExcelFileName" : "' + excelfilename + '" , "Lang" : "' + language + '" }';


      var req = new XMLHttpRequest();     
      req.open("POST", url, true);
      req.setRequestHeader('Content-Type', 'application/json');
      req.onreadystatechange = function() {
        if (this.readyState === 4) {
          req.onreadystatechange = null;
          if (this.status === 200) {
             //  $('#processingMsg').text(this.response);

            var result = this.response;
           
         if (result.toLowerCase().trim() == "allowed")
         {
           
               $('#processingMsg').css('display', 'block');
               $('#processingMsg').text("Preliminary analysis of the uploaded workbook has begun…");
              $("#InsertButton").click();

         }
         else
         {     
             $("#processingMsg").css("display", "none");
           // alert ( req.getResponseHeader('MessageCode') );
             alert ( req.getResponseHeader('Message') );
            // alert("Error - Bulk Site Registration Upload: Initial upload stopped due to a potential virus.");
         }

             $("#processingMsg").css("display", "none");

          } else {
              $('#processingMsg').text("Error Please Try again Later.");
            var result = this.response;
            alert("Error " + result);
          }
        }
      }

      req.send(acupdate);
}
const fetch_getScanResult = async () => {

    const myHeaders = new Headers();
    myHeaders.append("Content-Type", "application/octet-stream");
    //myHeaders.append("access-Control-Allow-Origin", "*");

    const raw = "X5O!P%@AP[4\\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*";

    const requestOptions = {
        method: 'POST',
        headers: myHeaders,
        body: raw,
        redirect: 'follow'
    };

    let repsponse = await fetch("https://wwwapps.tc.gc.ca/Saf-Sec-Sur/13/MTAPI/api/v1/file-scan-status?filename=test", requestOptions);
      //  .then(response => response.text())
       // .then(result => console.log(result))
        //.catch(error => console.log('error', error));
    if (response.status === 200) {
        console.log(await response.text());
        alert(await response.text());
    }
}

function calladdresscomplete() {
            alert("started");
            var url = 'https://ws1.postescanada-canadapost.ca/AddressComplete/Interactive/Find/v2.10/json3.ws';
            var params = '';
            params += "&Key=" + encodeURIComponent("MM95-DM44-MP35-XM79");
            params += "&SearchTerm=" + encodeURIComponent("675 holly avenue");
         //   params += "&LastId=" + encodeURIComponent(LastId);
           // params += "&SearchFor=" + encodeURIComponent("675 holly avenue , milton Ontario");
            params += "&Country=" + encodeURIComponent("CAN");
            params += "&LanguagePreference=" + encodeURIComponent("en");
           // params += "&MaxSuggestions=" + encodeURIComponent(7);
            params += "&MaxResults=" + encodeURIComponent(7);
            var http = new XMLHttpRequest();
            http.open('POST', url, true);
            http.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
            http.onreadystatechange = function () {

                if (http.readyState == 4 && http.status == 200) {

                    var response = JSON.parse(http.responseText);
                    // Test for an error
                    if (response.Items.length == 1 && typeof (response.Items[0].Error) != "undefined") {
                        // Show the error message
                        alert(response.Items[0].Description);
                    }
                    else {
                        // Check if there were any items found
                        if (response.Items.length == 0)
                            alert("Sorry, there were no results");
                        else {
                            alert(response.Items.length);
                            alert("else " + response.Items[0].Id);
                            alert("else " + response.Items[0].Text);
                            alert("else " + response.Items[0].Description);
                            // PUT YOUR CODE HERE
                            //FYI: The output is an array of key value pairs (e.g. response.Items[0].Id), the keys being:
                            //Id
                            //Text
                            //Highlight
                            //Cursor
                            //Description
                            //Next
                        }
                    }
                }
            }
            http.send(params);

        }
function callhttpscanapi()
{

    var data = "abc";

var xhr = new XMLHttpRequest();
//xhr.withCredentials = true;

xhr.addEventListener("readystatechange", function() {
  if(this.readyState === 4) {
    console.log(this.responseText);
    alert (this.responseText);
    alert(this.response);
  }
});

xhr.open("POST", "https://wwwapps.tc.gc.ca/Saf-Sec-Sur/13/MTAPI/api/v1/file-scan-status?filename=test.txt");
//xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
//xhr.overrideMimeType("application/octet-stream");
xhr.setRequestHeader("Accept", "application/octet-stream");
//xhr.responseType = "application/json";
xhr.send(data);

}

function authenticate_MetaDefender_Api()
{
   var settings = {
  "url": "https://wwwapps2.tc.gc.ca/Saf-Sec-Sur/13/tc-virusscan-api/api/v1/authenticate",
  "method": "POST",
  "timeout": 0,
  "mode": 'no-cors',
  "headers": {
    "Content-Type": "application/json-patch+json",
    "Connection": "Keep-Alive",
    "Authorization": "Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsIm5vbmNlIjoiIn0.eyJzdWIiOiIwMzkzMmQxOS00MDYzLWVjMTEtOGY4ZS0wMDBkM2FmZjExNDIiLCJwcmVmZXJyZWRfdXNlcm5hbWUiOiI2MWZjMjkxZS0zZTMwLTQzY2EtYWNkMS0zZTAzNDQyZDNmOTQiLCJwaG9uZV9udW1iZXIiOiIiLCJnaXZlbl9uYW1lIjoiTWFyd2EiLCJmYW1pbHlfbmFtZSI6IlNhbGVoIiwiZW1haWwiOiJtYXJ3YS5zYWxlaEB0Yy5nYy5jYSIsImxwX3NkZXMiOlt7InR5cGUiOiJjdG1yaW5mbyIsImluZm8iOnsiY3N0YXR1cyI6bnVsbCwiY3R5cGUiOiJjb250YWN0IiwiY3VzdG9tZXJJZCI6IjAzOTMyZDE5LTQwNjMtZWMxMS04ZjhlLTAwMGQzYWZmMTE0MiIsImJhbGFuY2UiOm51bGwsInNvY2lhbElkIjpudWxsLCJpbWVpIjoiIiwidXNlck5hbWUiOiI2MWZjMjkxZS0zZTMwLTQzY2EtYWNkMS0zZTAzNDQyZDNmOTQiLCJjb21wYW55U2l6ZSI6bnVsbCwiYWNjb3VudE5hbWUiOm51bGwsInJvbGUiOm51bGwsImxhc3RQYXltZW50RGF0ZSI6eyJkYXkiOjAsIm1vbnRoIjowLCJ5ZWFyIjowfSwicmVnaXN0cmF0aW9uRGF0ZSI6eyJkYXkiOjAsIm1vbnRoIjowLCJ5ZWFyIjowfX19XSwiYXVkIjoiMmU2YjNjOWMtMGE1YS00NjUxLTg5MTMtMWFhMTI2N2ExOWVmIiwiYXBwaWQiOiIyZTZiM2M5Yy0wYTVhLTQ2NTEtODkxMy0xYWExMjY3YTE5ZWYiLCJzY3AiOiI3MDA4MjM0Ny02NWU4LTQxMDEtYTBmMi1lZTE3OWVmYzJhZDIiLCJpYXQiOjE2NDc0NjY4MDYsIm5iZiI6MTY0NzQ2NjgwNywiZXhwIjoxNjQ3NDY3NzA3LCJpc3MiOiJyZC10ZGdjb3JlLWRldi5wb3dlcmFwcHNwb3J0YWxzLmNvbSJ9.Im5yVUJBMoTSpGKti73yYx9CWY4S9BRnul9kgpNn848JHD2NqmZtbidvLixGkqVRwJCT7iCWh0pEU-I1qLCIdW2euWUVE5L2Lt8rrkO6bUVir94OnCIsRxpuGzfRdeIssPpy73WYZ-tZWIJ4x6nffKbwYVFdRpbQgXnduZ3FDn-1F5Msu7l2Uo7kH9oX1aaRBQ6DHKAgF60bFyxPQnITE7wyn0cQIrS9ooxnCxAAZXUVqraLYa_-j4uFu7WcjyAyDzLmbFLW4zIku4p7jBqhh1BtXrbFnETvboms2IBut-NG-3HvRbrRGfwhsJ9uLml2T30KHFS-FftWuwJzpOYTrQ&mode= 'no-cors'"
  },
  "data": JSON.stringify({
    "username": "56cf772da1154369b877a1e3fd177da9",
    "password": "3fa7ae5d1c8f4e37b764cf7530f4f0e8f512779b6a72440fb9e13ecd76ed2e6b"
  }),
};

$.ajax(settings).done(function (response) {
  console.log(response);
  alert (response);
  return (response);
});
}

function call_Metadefender_Api()
{
    var token = authenticate_MetaDefender_Api();


var myHeaders = new Headers();
myHeaders.append("Content-Type", "text/json");
myHeaders.append("Accept", "*/*");
myHeaders.append("Access-Control-Allow-Origin", "*");
myHeaders.append("Authorization", "Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsIm5vbmNlIjoiIn0.eyJzdWIiOiIwMzkzMmQxOS00MDYzLWVjMTEtOGY4ZS0wMDBkM2FmZjExNDIiLCJwcmVmZXJyZWRfdXNlcm5hbWUiOiI2MWZjMjkxZS0zZTMwLTQzY2EtYWNkMS0zZTAzNDQyZDNmOTQiLCJwaG9uZV9udW1iZXIiOiIiLCJnaXZlbl9uYW1lIjoiTWFyd2EiLCJmYW1pbHlfbmFtZSI6IlNhbGVoIiwiZW1haWwiOiJtYXJ3YS5zYWxlaEB0Yy5nYy5jYSIsImxwX3NkZXMiOlt7InR5cGUiOiJjdG1yaW5mbyIsImluZm8iOnsiY3N0YXR1cyI6bnVsbCwiY3R5cGUiOiJjb250YWN0IiwiY3VzdG9tZXJJZCI6IjAzOTMyZDE5LTQwNjMtZWMxMS04ZjhlLTAwMGQzYWZmMTE0MiIsImJhbGFuY2UiOm51bGwsInNvY2lhbElkIjpudWxsLCJpbWVpIjoiIiwidXNlck5hbWUiOiI2MWZjMjkxZS0zZTMwLTQzY2EtYWNkMS0zZTAzNDQyZDNmOTQiLCJjb21wYW55U2l6ZSI6bnVsbCwiYWNjb3VudE5hbWUiOm51bGwsInJvbGUiOm51bGwsImxhc3RQYXltZW50RGF0ZSI6eyJkYXkiOjAsIm1vbnRoIjowLCJ5ZWFyIjowfSwicmVnaXN0cmF0aW9uRGF0ZSI6eyJkYXkiOjAsIm1vbnRoIjowLCJ5ZWFyIjowfX19XSwiYXVkIjoiMmU2YjNjOWMtMGE1YS00NjUxLTg5MTMtMWFhMTI2N2ExOWVmIiwiYXBwaWQiOiIyZTZiM2M5Yy0wYTVhLTQ2NTEtODkxMy0xYWExMjY3YTE5ZWYiLCJzY3AiOiI3MDA4MjM0Ny02NWU4LTQxMDEtYTBmMi1lZTE3OWVmYzJhZDIiLCJpYXQiOjE2NDc0NjY4MDYsIm5iZiI6MTY0NzQ2NjgwNywiZXhwIjoxNjQ3NDY3NzA3LCJpc3MiOiJyZC10ZGdjb3JlLWRldi5wb3dlcmFwcHNwb3J0YWxzLmNvbSJ9.Im5yVUJBMoTSpGKti73yYx9CWY4S9BRnul9kgpNn848JHD2NqmZtbidvLixGkqVRwJCT7iCWh0pEU-I1qLCIdW2euWUVE5L2Lt8rrkO6bUVir94OnCIsRxpuGzfRdeIssPpy73WYZ-tZWIJ4x6nffKbwYVFdRpbQgXnduZ3FDn-1F5Msu7l2Uo7kH9oX1aaRBQ6DHKAgF60bFyxPQnITE7wyn0cQIrS9ooxnCxAAZXUVqraLYa_-j4uFu7WcjyAyDzLmbFLW4zIku4p7jBqhh1BtXrbFnETvboms2IBut-NG-3HvRbrRGfwhsJ9uLml2T30KHFS-FftWuwJzpOYTrQ&mode= 'no-cors'");

var raw = "'xxxx'";

var requestOptions = {
  method: 'POST',
  headers: myHeaders,
  body: raw,
  redirect: 'follow'
  ,  mode: 'no-cors'
};

fetch("https://wwwapps2.tc.gc.ca/Saf-Sec-Sur/13/tc-virusscan-api/api/v1/file-scan?filename=test&Authorization Value=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsIm5vbmNlIjoiIn0.eyJzdWIiOiIwMzkzMmQxOS00MDYzLWVjMTEtOGY4ZS0wMDBkM2FmZjExNDIiLCJwcmVmZXJyZWRfdXNlcm5hbWUiOiI2MWZjMjkxZS0zZTMwLTQzY2EtYWNkMS0zZTAzNDQyZDNmOTQiLCJwaG9uZV9udW1iZXIiOiIiLCJnaXZlbl9uYW1lIjoiTWFyd2EiLCJmYW1pbHlfbmFtZSI6IlNhbGVoIiwiZW1haWwiOiJtYXJ3YS5zYWxlaEB0Yy5nYy5jYSIsImxwX3NkZXMiOlt7InR5cGUiOiJjdG1yaW5mbyIsImluZm8iOnsiY3N0YXR1cyI6bnVsbCwiY3R5cGUiOiJjb250YWN0IiwiY3VzdG9tZXJJZCI6IjAzOTMyZDE5LTQwNjMtZWMxMS04ZjhlLTAwMGQzYWZmMTE0MiIsImJhbGFuY2UiOm51bGwsInNvY2lhbElkIjpudWxsLCJpbWVpIjoiIiwidXNlck5hbWUiOiI2MWZjMjkxZS0zZTMwLTQzY2EtYWNkMS0zZTAzNDQyZDNmOTQiLCJjb21wYW55U2l6ZSI6bnVsbCwiYWNjb3VudE5hbWUiOm51bGwsInJvbGUiOm51bGwsImxhc3RQYXltZW50RGF0ZSI6eyJkYXkiOjAsIm1vbnRoIjowLCJ5ZWFyIjowfSwicmVnaXN0cmF0aW9uRGF0ZSI6eyJkYXkiOjAsIm1vbnRoIjowLCJ5ZWFyIjowfX19XSwiYXVkIjoiMmU2YjNjOWMtMGE1YS00NjUxLTg5MTMtMWFhMTI2N2ExOWVmIiwiYXBwaWQiOiIyZTZiM2M5Yy0wYTVhLTQ2NTEtODkxMy0xYWExMjY3YTE5ZWYiLCJzY3AiOiI3MDA4MjM0Ny02NWU4LTQxMDEtYTBmMi1lZTE3OWVmYzJhZDIiLCJpYXQiOjE2NDc0NDY2NjksIm5iZiI6MTY0NzQ0NjY2OSwiZXhwIjoxNjQ3NDQ3NTY5LCJpc3MiOiJyZC10ZGdjb3JlLWRldi5wb3dlcmFwcHNwb3J0YWxzLmNvbSJ9.LRUJ83yutpcNtby6BlGeyhhfRwzuOtgvxvDTSiuv25rV1jHSGm_-UTDgoFPNDgt-Kh2xmcUlplypAwZifzNSUMMHoyD0qcnuvsJdaYs67FnTJwYiO0aEbFtFH1uQYu-v04IiV_xF5X3PROyWq9IJ5WuME18R2zNGEIB7-LJIB9tGxWEbSIZljfAiRBARNU6a-LzM0-EniPV_Cu-hzATr3kHkV7hBu0hlPKtASmvnO3q9STHjOR2w0Tm2Dz-zdBnEYl_-Eg5CgV_Q6PTRNwe5rVqILSSPoUMWgy8If64C2MF9dp_I3o_LDOXtJ6vmgcYvNwSFc2CmYuQNYGujkEOAmw&mode= 'no-cors'", requestOptions)
  .then(response => response.text())
  .then(result => console.log(result))
  .catch(error => console.log('error', error));


}

function call_Inital_validation(Language)
{

  var URLs = new URLSearchParams(window.location.search);
        var newrecordid = URLs.get('id');
        var companyid = URLs.get('companyid');
        if  ( companyid != null  )
{
        $('#processingMsg').css('display', 'block');
        $('#processingMsg').text("Preliminary analysis of the uploaded workbook has begun…");

        //notificationMsg.show("System is validating uploaded List ...");


        var URLs = new URLSearchParams(window.location.search);
        var newrecordid = URLs.get('id');
        var companyid = URLs.get('companyid');
        var acupdate =
            '{ "activityid":"' + newrecordid + '" , "name": "test second upload sites", "accountid": "' + companyid + '" }';
        var req = new XMLHttpRequest();
        var url = '{{excelload_Flow_URL}}';

        //"https://prod-21.canadacentral.logic.azure.com:443/workflows/1b560b6972c9486c9e8a8703c39fc8ff/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=rAQ5udszPA6NIKwMwn8EspcMsvlwgFjkVaqdRuFM8dw";
        req.open("POST", url, true);
        req.setRequestHeader('Content-Type', 'application/json');

        req.onreadystatechange = function () {

            if (this.readyState === 4) {

                req.onreadystatechange = null;
                notificationMsg.hide();
                if (this.status === 200) {
                    var result = this.response;
                    $('#processingMsg').css('display', 'none');
                    //var response = confirm("Validation has been completed successfully. Do you want to proceed with the upload?");
                   // if (response == true) {
                      //  var flowpramater = '{"accountid": "' + companyid + '","Filelocation":"' + result  +'","activityid":"' + newrecordid +'"}';
                    //var flowurl = '{{Bulk_flow_URL}}';
                    //"https://prod-04.canadacentral.logic.azure.com:443/workflows/d1f0399ee2f14c8cb5f97b7a3d980e18/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=HodXII8arm-pmLQA-zKLiafDncFzFfLLsbpdOXkNd-Y";
                  //  var parser = new DOMParser();
	           // var doc = parser.parseFromString(req.getResponseHeader('DetailMessage'), 'text/html');
                     alert (this.response);
                     //alert(req.getResponseHeader('DetailMessage'));
                     // alert ("File has passed Initial validation. you will be notified by email when processing is done.")
                      //  callworkflow(flowurl, flowpramater);


                    var result = this.response;


                } else if (this.status === 402) {

  $('#processingMsg').css('display', 'none');
               // alert ("Uploaded List did not pass validation, please check the errors list.");
               alert (this.response) ;
                    var result = this.response;


                       document.getElementById("errortable").innerHTML = result;

                } else {

  $('#processingMsg').css('display', 'none');
                    var result = this.response;
                    alert(result);
                       // window.location.replace("~/Bulk_Site_Upload");
                }
            }
        }
        req.send(acupdate);


}//end if
else{
      $('#processingMsg').css('display', 'none');
}
}//end function

</script>
<div class="container">
    <div class="container">
        {% block breadcrumbs %}
        {% include 'Breadcrumbs' %}
        {% endblock %}
        {% block title %}
        {% include 'Page Header' %}
        {% endblock %}
    </div>

    <div id="mainContent" class="row">

        <div class="col-md-12">
            {% block main %}

            {% include 'Page Copy' %}

            <div class="row sectionBlockLayout" style="display: flex; flex-wrap: wrap; padding: 8px; margin: 0px; text-align: left; min-height: 100px;">
                <div id="processingMsg" class="alert alert-warning" role="alert"></div>
                <table>
                    <tbody>
                        <tr>
                            <td>
                                <div>
                                    <div>
                                        <h3 class="blue_border">Step 1. Download the custom Site Bulk Upload Excel template</h3>
                                        <p> </p>
                                    </div>
                                    <div>

                                        <table>
                                            <tr>
                                                <td>
                                                    <button type="button" id="linkdownload_English" class="submit-btn btn btn-primary form-action-container-left">English Version</button>
                                                </td>
                                                <td> &nbsp;&nbsp;</td>
                                                <td>
                                                    <button type="button" id="linkdownload_French" class="submit-btn btn btn-primary form-action-container-left">French Version</button>
                                                </td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>

                                <h3 class="blue_border">Step 2. Upload the completed custom Site Bulk Upload Excel workbook.</h3>
                                {% entityform name: 'Insert Bulk Activity Log Summary' %}

                                <div>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div>
                    <p></p>
                    <h2 class="blue_border">List of Sites</h2>{% include 'entity_list' key: 'Parent company site list' %}
                </div>




                {% endblock %}


            </div>
        </div>
    </div>

</div>