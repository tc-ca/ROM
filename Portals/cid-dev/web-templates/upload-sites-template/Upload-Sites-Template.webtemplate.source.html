
<style>
    #processingMsg {
        width: 300px;
        text-align: center;
        padding: 6px 10px;
        z-index: 9999;
        top: 15%;
        left: 40%;
        position: fixed;
        -webkit-border-radius: 0 0 2px 2px;
        border-radius: 0 0 2px 2px;
        -webkit-box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        display: none;
    }

    #warnningMessage {
        -width: 300px;
        -text-align: center;
       -padding: 6px 10px;
        z-index: 9999;
        top: 15%;
        left: 40%;
        position: fixed;
        -webkit-border-radius: 0 0 2px 2px;
        -border-radius: 0 0 2px 2px;
        -webkit-box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        -box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        display: none;
    }
</style>
{% assign parentid = user.parentcustomerid.id %}
{% assign contactid = user.id %}
{% assign languagecode = website.selected_language.code %}
{% fetchxml environment_settings %}
<fetch version="1.0" output-format="xml-platform" mapping="logical" distinct="false">
    <entity name="qm_environmentsettings">
        <attribute name="qm_environmentsettingsid" />
        <attribute name="qm_name" />
        <attribute name="createdon" />
        <attribute name="qm_value" />
        <order attribute="qm_name" descending="false" />
        <filter type="and">
            <condition attribute="qm_name" operator="like" value="%CID[_]%" />
        </filter>
    </entity>
</fetch>
{% endfetchxml %}
{% for env_setting in environment_settings.results.entities %}
{% if {{env_setting.qm_name}}  == 'CID_Upload_Excel_Flow' %}
{% assign excelload_Flow_URL = env_setting.qm_value %}
{% endif %}
{% if {{env_setting.qm_name}}  == 'CID_Bulk_Upload' %}
{% assign Bulk_flow_URL = env_setting.qm_value %}
{% endif %}

{% if {{env_setting.qm_name}}  == 'CID_Download_Template_Flow' %}
{% assign download_flow_URL = env_setting.qm_value %}
{% endif %}

{% if {{env_setting.qm_name}}  == 'CID_Flow_FileScan' %}
{% assign Scan_flow_URL = env_setting.qm_value %}
{% endif %}



{% if {{env_setting.qm_name}}  == 'CID_Check_User_Response_To_continue' %}
{% assign CID_Check_User_Response_To_continue = env_setting.qm_value %}
{% endif %}

{% endfor %}

<script>
  $(document).ready( function() {

//TrigerMessageBox('test');
      //add new submit button
      $("div.actions").append("<input type='button' id='btn_attachfile_and_scan' name='btn_attachfile_and_scan' value='Upload' class='submit-btn btn btn-primary form-action-container-left' />");
     
      $("#InsertButton").css("display", "none");
    var langcode = '{{languagecode}}'  ;
    var BulkActivitytype = '100000001' ;
    //intial validation will be executed if this is a redirect call
      call_Inital_validation(langcode , BulkActivitytype);




    $(window).load(function() {
    //call_Inital_validation();
    });
   // var pageURL = window.location.href;

$('#btn_attachfile_and_scan').click(function(e)
{

    if (document.getElementById('AttachFile').files.length == 0)
   {
       // call the submit button to show error message
    $("#InsertButton").click();
   }
   else
   {
   // $("#mainContent").before("<div class='validation' style='color:black;margin-bottom: 20px;'>File is sent for scaning</div>");
    var DocumentbodyContents;
  // Get the name of the selected file
    var FileName = $('#AttachFile')[0].files[0].name;

    // Get the mime type of the selected file
    var MimeType = $('#AttachFile')[0].files[0].type;

    // Get the content of the selected file
    var file = document.getElementById('AttachFile').files[0];



    if (MimeType != "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet")
   {

 // call the submit button to show error message
    $("#InsertButton").click();
   }

  else if (file) {

        $('#processingMsg').css('display', 'block');
        $('#processingMsg').text("Workbook is being scanned….");

      //  $('#warnningMessage').css('display', 'block');
       // $('#warnningMessage').text("Workbook is being scanned….");
        // Read the file

        var reader = new FileReader();

        reader.readAsDataURL(file);

        // The browser has finished reading the file, we can now do something with it...

        reader.onload = function (e) {

            // The browser has finished reading the file, we can now do something with it...

            DocumentbodyContents = e.target.result;

            // Split the string at the first comma (removing the base64 prefix)

            DocumentbodyContents = DocumentbodyContents.substring(DocumentbodyContents.indexOf(',') + 1);


            var Scan_API_URL = '{{Scan_flow_URL}}';


          Call_Virsu_Scan_API(Scan_API_URL
            // ,btoa(c));
            ,DocumentbodyContents , BulkActivitytype ,FileName,langcode );


        // call_Metadefender_Api();




        }//end loader
    }///end if file
   }// end check file length


//btoa(c) );
});


    $('#linkdownload_English').on('click', async function() {

          $('#processingMsg').css('display','block');
        $('#processingMsg').text('The custom Site Bulk Upload Excel workbook is being downloaded …');


      var companyid = '{{parentid}}';
     var flowparamaters =
        '{ "accountid": "' + companyid + '",'  + '"Language": "English" }';


      var req = new XMLHttpRequest();

      var url = '{{download_flow_URL}}';
      console.log(url);

      req.open("POST", url, true);
      req.setRequestHeader('Content-Type', 'application/json');
      req.onreadystatechange = function() {
        if (this.readyState === 4) {
          req.onreadystatechange = null;
          if (this.status === 200) {
               $('#processingMsg').text("Download complete");
            var result = this.response;
           // $('#ll').hide();
            //https://rd-tdgcore-dev.powerappsportals.com/_entity/annotation/
            var fileattachementURL = "~/_entity/annotation/" + result;
            window.location.replace(fileattachementURL);
             $("#processingMsg").css("display", "none");
            $("#processingMsg").hide();
          } else {
              $('#processingMsg').text("Download was not completed due to system issue, please contact system support");
            var result = this.response;
            alert("Error " + result);
          }
        }
      }
      req.send(flowparamaters);
    });


 $('#linkdownload_French').on('click', async function() {

          $('#processingMsg').css('display','block');
        $('#processingMsg').text('System is downloading site info ...');

     // notificationMsg.show("System is downloading site info ...");

     // $('#ll').show();
      var companyid = '{{parentid}}';


      var flowparamaters =
        '{ "accountid": "' + companyid + '",'  + '"Language": "French" }';


      var req = new XMLHttpRequest();

      var url = '{{download_flow_URL}}';
      console.log(url);
      //"https://prod-17.canadacentral.logic.azure.com:443/workflows/900f6e70915a4cddbb65b3c79da14581/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=LZveFQ8DXIDobQOPzgoc0LgOcSOPpqVcnCEicN1lvEQ";
      req.open("POST", url, true);
      req.setRequestHeader('Content-Type', 'application/json');
      req.onreadystatechange = function() {
        if (this.readyState === 4) {
          req.onreadystatechange = null;
          if (this.status === 200) {
               $('#processingMsg').text("Download complete");
            var result = this.response;
           // $('#ll').hide();
            //https://rd-tdgcore-dev.powerappsportals.com/_entity/annotation/
            var fileattachementURL = "~/_entity/annotation/" + result;
            window.location.replace(fileattachementURL);
             $("#processingMsg").css("display", "none");
            $("#processingMsg").hide();
          } else {
              $('#processingMsg').text("Download was not completed due to system issue, please contact system support");
            var result = this.response;
            alert("Error " + result);
          }
        }
      }
      req.send(flowparamaters);
    });



});//end document ready


   // Notification component
    var notificationMsg = (function () {
        var $processingMsgEl = $('#processingMsg'),
            _msg = 'Processing...',
            _stack = 0,
            _endTimeout;
        return {
            show: function (msg) {

                $processingMsgEl.text(msg || _msg);
                if (_stack === 0) {
                    clearTimeout(_endTimeout);
                    $processingMsgEl.show();
                }
                _stack++;
            },
            hide: function () {
                _stack--;
                if (_stack <= 0) {
                    _stack = 0;
                    clearTimeout(_endTimeout);
                    _endTimeout = setTimeout(function () {
                        $processingMsgEl.hide();
                    }, 500);
                }
            }
        }
    })();



function Call_Check_User_Response_flow(activityid , UserResponse , Logdetaisls , Lang)
{
    
 var url = '{{CID_Check_User_Response_To_continue}}' ;

  var acupdate =
  ' { "activityid":"' + activityid  + '", "user_reponse":"' + UserResponse +'", "Log_details": "' +Logdetaisls + '","Lang":"' + Lang+ '"}' ;
 
    
      var req = new XMLHttpRequest();
      req.open("POST", url, true);
      req.setRequestHeader('Content-Type', 'application/json');
      req.onreadystatechange = function() {
        if (this.readyState === 4) {
          req.onreadystatechange = null;
          if (this.status === 200) {
             //  $('#processingMsg').text(this.response);

            var result = this.response;

         

               $('#processingMsg').css('display', 'block');
               $('#processingMsg').text("");
            

         }
         else {
              $('#processingMsg').text("Error Please Try again Later.");
            var result = this.response;
            alert("Error " + result);
          }
        }
      }

      req.send(acupdate);

}


function Call_Virsu_Scan_API(url, fileContent, activitytype , excelfilename , language)
{

var companyid = '{{parentid}}';
var contactid = '{{contactid}}'
      $('#processingMsg').css('display', 'block');
        $('#processingMsg').text("Workbook is being scanned….");

  var acupdate =
        '{"FileContent" :"' + fileContent  + '", "CompanyId" : "' + companyid + '" , "ActionedBy" :"' + contactid +  '", "ActivityType" : "'+ activitytype +'" ,"ExcelFileName" : "' + excelfilename + '" , "Lang" : "' + language + '" }';


      var req = new XMLHttpRequest();
      req.open("POST", url, true);
      req.setRequestHeader('Content-Type', 'application/json');
      req.onreadystatechange = function() {
        if (this.readyState === 4) {
          req.onreadystatechange = null;
          if (this.status === 200) {
             //  $('#processingMsg').text(this.response);

            var result = this.response;

         if (result.toLowerCase().trim() == "allowed")
         {

               $('#processingMsg').css('display', 'block');
               $('#processingMsg').text("Preliminary analysis of the uploaded workbook has begun…");
              $("#InsertButton").click();

         }
         else
         {
             $("#processingMsg").css("display", "none");
           // alert ( req.getResponseHeader('MessageCode') );
             alert ( req.getResponseHeader('Message') );
            // alert("Error - Bulk Site Registration Upload: Initial upload stopped due to a potential virus.");
         }

             $("#processingMsg").css("display", "none");

          } else {
              $('#processingMsg').text("Error Please Try again Later.");
            var result = this.response;
            alert("Error " + result);
          }
        }
      }

      req.send(acupdate);
}


function call_Inital_validation(Language , bulkactivitytype)
{

  var URLs = new URLSearchParams(window.location.search);
        var newrecordid = URLs.get('id');
        var companyid = URLs.get('companyid');
        var companyname = '{{ user.parentcustomerid.Name }}';
        if  ( companyid != null  )
{
       // $('#processingMsg').css('display', 'block');
        //$('#processingMsg').text("Preliminary analysis of the uploaded workbook has begun…");

  $('#warnningMessage').css('display', 'block');
        $('#warnningMessage').text("Preliminary analysis of the uploaded workbook has begun…");

        //notificationMsg.show("System is validating uploaded List ...");


        var URLs = new URLSearchParams(window.location.search);

        var newrecordid = URLs.get('id');
        var companyid = URLs.get('companyid');
        var acupdate =
            '{ "activityid":"' + newrecordid + '" , "name": "'+ companyname +'", "accountid": "' + companyid + '" , "Lang" : "' + Language + '" ,"ActivityType" : "' + bulkactivitytype +  '" }';

        var req = new XMLHttpRequest();
        var url = '{{excelload_Flow_URL}}';

       
        req.open("POST", url, true);
        req.setRequestHeader('Content-Type', 'application/json');

        req.onreadystatechange = function () {

            if (this.readyState === 4) {

                req.onreadystatechange = null;
                  $('#processingMsg').css('display', 'none');
                if (this.status === 200) {
                    var result = this.response;
                    //$('#processingMsg').css('display', 'none');
                   $('#warnningMessage').css('display', 'none');
                    // alert (this.response);
                     //alert(req.getResponseHeader('DetailMessage'));



                    var result = this.response;
                    confirmDialog(result, (ans) => {
                            if (ans) {
                                console.log("Yes");

                                Call_Check_User_Response_flow(newrecordid , 'yes' , '' , Language);
                                }else {
                            Call_Check_User_Response_flow(newrecordid , 'No' , '' , Language);
                            }
                            });


                } else if (this.status === 402) {

                 $('#processingMsg').css('display', 'none');
                  $('#warnningMessage').css('display', 'none');
               // alert ("Uploaded List did not pass validation, please check the errors list.");
              // alert (this.response) ;
                    var result = this.response;

                    confirmDialog(result, (ans) => {
                            if (ans) {
                                console.log("Yes");
                                }else {
                            console.log("No");
                            }
                            });

                       //document.getElementById("errortable").innerHTML = result;

                } else {
 
                   $('#warnningMessage').css('display', 'none');
                  //$('#processingMsg').css('display', 'none');
                    var result = this.response;
                    alert(result);
                       // window.location.replace("~/Bulk_Site_Upload");
                }
            }
        }
        req.send(acupdate);


}//end if
else{
      $('#processingMsg').css('display', 'none');
}
}//end function

function TrigerMessageBox(message)
{
  
$(`<section class="mfp-hide modal-dialog modal-content overlay-def" id="myModal">
    <header class="modal-header">
        <h2 class="modal-title">CID Portal</h2>
    </header>
    <div class="modal-body">
        <ol>${message}</ol>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-primary">Yes</button>
        <button type="button" class="btn btn-primary" data-dismiss="modal">No</button>
    </div>
</section>
`).appendTo('body');

$document.trigger( "open.wb-lbx", [
			[
				{
					src: "#myModal",
					type: "inline"
				}
			],
			true
		]);


}

 function confirmDialog(message, handler) {
      /*  $(`<div class="modal fade" id="myModal" role="dialog"> 
     <div class="modal-dialog"> 
       <!-- Modal content--> 
        <div class="modal-content"> 
           <div class="modal-body" style="padding:10px;"> 
             <h4 class="text-center">${message}</h4> 
             <div class="text-center"> 
               <a class="btn btn-danger btn-yes">yes</a> 
               <a class="btn btn-default btn-no">no</a> 
             </div> 
           </div> 
       </div> 
    </div> 
  </div>`).appendTo('body');*/
/*
  $(`<section class="modal-dialog modal-content overlay-def">
  <div class="modal" id="myModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-content overlay-def" >
    <div class="modal-content">
      <div class="modal-header ">
        <h5 class="modal-title">CID Portal</h5>
       
      </div>
      <div class="modal-body">
        <ol>${message}</ol>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary">Yes</button>
        <button type="button" class="btn btn-primary" data-dismiss="modal">No</button>
      </div>
    </div>
  </div>
</div></section>`).appendTo('body');
*/

 $(`<section class="modal-dialog modal-content overlay-def" id="myModal">
    <header class="modal-header">
        <h2 class="modal-title">CID Portal</h2>
    </header>
    <div class="modal-body">
        <ol>${message}</ol>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-primary">Yes</button>
        <button type="button" class="btn btn-primary" data-dismiss="modal">No</button>
    </div>
</section>
`).appendTo('body');


$document.trigger( "open.wb-lbx", [
			[
				{
					src: "#myModal",
					type: "inline"
				}
			],
			true
		]);
	
        //Trigger the modal
        $("#myModal").modal({
            backdrop: 'static',
            keyboard: false
        });

        //Pass true to a callback function
        $(".btn-yes").click(function () {
            handler(true);
            $("#myModal").modal("hide");
        });

        //Pass false to callback function
        $(".btn-no").click(function () {
            handler(false);
            $("#myModal").modal("hide");
        });

        //Remove the modal once it is closed.
        $("#myModal").on('hidden.bs.modal', function () {
            $("#myModal").remove();
        });
    }

</script>
<div class="container ">
    <div class="container">
        {% block breadcrumbs %}
        {% include 'Breadcrumbs' %}
        {% endblock %}
        {% block title %}
        {% include 'Page Header' %}
        {% endblock %}
    </div>

    <div id="mainContent" class="wb-lbx row">

        <div class="col-md-12">
            {% block main %}

            {% include 'Page Copy' %}



            <div class="row sectionBlockLayout" style="display: flex; flex-wrap: wrap; padding: 8px; margin: 0px; text-align: left; min-height: 100px;">


  <section class="alert alert-warning" id="warnningMessage">
                </section>

                <div id="processingMsg" class="alert alert-warning" role="alert">
              
                </div>
                <table>
                    <tbody>
                        <tr>
                            <td>
                                <div>
                                    <div>
                                        <h3 class="blue_border">Step 1. Download the custom Site Bulk Upload Excel template</h3>
                                        <p> </p>
                                    </div>
                                    <div>

                                        <table>
                                            <tr>
                                                <td>
                                                    <button type="button" id="linkdownload_English" class="submit-btn btn btn-primary form-action-container-left">English Version</button>
                                                </td>
                                                <td> &nbsp;&nbsp;</td>
                                                <td>
                                                    <button type="button" id="linkdownload_French" class="submit-btn btn btn-primary form-action-container-left">French Version</button>
                                                </td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>

                                <h3 class="blue_border">Step 2. Upload the completed custom Site Bulk Upload Excel workbook.</h3>
                                {% entityform name: 'Insert Bulk Activity Log Summary' %}

                                <div>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div>
                    <p></p>
                    <h2 class="blue_border">List of Sites</h2>{% include 'entity_list' key: 'Parent company site list' %}
                </div>




                {% endblock %}


            </div>
        </div>
    </div>

</div>